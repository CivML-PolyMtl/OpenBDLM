<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of buildModel</title>
  <meta name="keywords" content="buildModel">
  <meta name="description" content="BUILDMODEL Build model (build A,C, Q, R matrices)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">OpenBDLM_V1.0</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">ModelConfiguration</a> &gt; buildModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for OpenBDLM_V1.0/functions/ModelConfiguration&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>buildModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>BUILDMODEL Build model (build A,C, Q, R matrices)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [model, misc]=buildModel(data, model, misc) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">BUILDMODEL Build model (build A,C, Q, R matrices)

   SYNOPSIS:
     [model]=BUILDMODEL(data, model, misc, model)

   INPUT:
       data       - structure (required)
                    data must contain three fields:

                       'timestamps' is a M×1 array

                       'values' is a MxN  array

                       'labels' is a 1×N cell array
                               each cell is a character array

                           N: number of time series
                           M: number of samples

      model       - structure (required)

      misc        - structure (required)

   OUTPUT:
      model       - structure

      misc        - structure

   DESCRIPTION:
      BUILDMODEL builds model (build A,C,Q,R matrices)

   EXAMPLES:
      [model] = BUILDMODEL(data, model, misc)

   See also <a href="defineModel.html" class="code" title="function [model, misc]=defineModel(data, misc)">DEFINEMODEL</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>	DEFINEREFERENCETIMESTEP Compute reference timestep of a timestamp vector</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>	READPARAMETERPROPERTIES Extract some columns of a cell array</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>	WRITEPARAMETERPROPERTIES Write updated model parameter properties</li><li><a href="../../../OpenBDLM_V1.0/functions/StateEstimation/Kernel_component.html" class="code" title="function [K_norm]=Kernel_component(reg_parameters,timestamp,timestamp_ref,nb_p)">Kernel_component</a>	KERNEL_COMPONENT Compute normalized kernel coefficients</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../OpenBDLM_V1.0/functions/DataLoader/loadConfigurationFile.html" class="code" title="function [data, model, estimation, misc]=loadConfigurationFile(misc, ConfigFileName)">loadConfigurationFile</a>	LOADCONFIGURATIONFILE Load a new project from a configuration file</li><li><a href="configureModelForDataReal.html" class="code" title="function [data, model, estimation, misc]=configureModelForDataReal(data, model, estimation , misc)">configureModelForDataReal</a>	CONFIGUREMODELFORDATAREAL Configure model for BDLM analysis based on real data</li><li><a href="configureModelForDataSimulation.html" class="code" title="function [data, model, estimation, misc]=configureModelForDataSimulation(data, model, estimation , misc)">configureModelForDataSimulation</a>	CONFIGUREMODELFORDATASIMULATION Configure model for BDLM analysis based on simulated data</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [model, misc]=buildModel(data, model, misc)</a>
0002 <span class="comment">%BUILDMODEL Build model (build A,C, Q, R matrices)</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   SYNOPSIS:</span>
0005 <span class="comment">%     [model]=BUILDMODEL(data, model, misc, model)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   INPUT:</span>
0008 <span class="comment">%       data       - structure (required)</span>
0009 <span class="comment">%                    data must contain three fields:</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%                       'timestamps' is a M×1 array</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%                       'values' is a MxN  array</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%                       'labels' is a 1×N cell array</span>
0016 <span class="comment">%                               each cell is a character array</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%                           N: number of time series</span>
0019 <span class="comment">%                           M: number of samples</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%      model       - structure (required)</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%      misc        - structure (required)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%   OUTPUT:</span>
0026 <span class="comment">%      model       - structure</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%      misc        - structure</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%   DESCRIPTION:</span>
0031 <span class="comment">%      BUILDMODEL builds model (build A,C,Q,R matrices)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%   EXAMPLES:</span>
0034 <span class="comment">%      [model] = BUILDMODEL(data, model, misc)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   See also DEFINEMODEL</span>
0037 
0038 <span class="comment">%   AUTHORS:</span>
0039 <span class="comment">%      James-A Goulet, Luong Ha Nguyen, Ianis Gaudot</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%      Email: &lt;james.goulet@polymtl.ca&gt;</span>
0042 <span class="comment">%      Website: &lt;http://www.polymtl.ca/expertises/goulet-james-alexandre&gt;</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%   MATLAB VERSION:</span>
0045 <span class="comment">%      Tested on 9.1.0.441655 (R2016b)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%   DATE CREATED:</span>
0048 <span class="comment">%       April 23, 2018</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%   DATE LAST UPDATE:</span>
0051 <span class="comment">%       August 22, 2018</span>
0052 
0053 <span class="comment">%--------------------BEGIN CODE ----------------------</span>
0054 
0055 <span class="comment">%% Get arguments passed to the function and proceed to some verifications</span>
0056 p = inputParser;
0057 
0058 addRequired(p,<span class="string">'data'</span>, @isstruct );
0059 addRequired(p,<span class="string">'model'</span>, @isstruct );
0060 addRequired(p,<span class="string">'misc'</span>, @isstruct );
0061 parse(p,data, model, misc);
0062 
0063 data=p.Results.data;
0064 model=p.Results.model;
0065 misc=p.Results.misc;
0066 
0067 <span class="comment">%% Get reference time step</span>
0068 <span class="comment">%% Compute reference time step from timestamp vector</span>
0069 timestamps = data.timestamps;
0070 [dt_ref] = <a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>(timestamps);
0071 <span class="comment">%misc.dt_ref = dt_ref;</span>
0072 
0073 <span class="comment">%% Get number of time series</span>
0074 numberOfTimeSeries = length(data.labels);
0075 
0076 <span class="comment">%% Get the number of time steps</span>
0077 numberOfTimeSteps = length(data.timestamps);
0078 
0079 <span class="comment">%% Get number of model class</span>
0080 numberOfModelClass = size(model.components.block,2);
0081 model.nb_class = size(model.components.block,2);
0082 
0083 <span class="comment">%% Data simulation ?</span>
0084 <span class="keyword">if</span> ~isfield(misc.internalVars, <span class="string">'isDataSimulation'</span>)
0085     misc.internalVars.isDataSimulation = false;
0086 <span class="keyword">end</span>
0087 
0088 
0089 <span class="comment">%% Default prior information</span>
0090 
0091 PriorType = <span class="string">'N/A'</span>; 
0092 PriorMean = NaN;
0093 PriorSdev = NaN;
0094 
0095 disp(<span class="string">'     Building model...'</span>)
0096 
0097 <span class="comment">%% Block Component definition</span>
0098 
0099 <span class="comment">%#11 Local level</span>
0100 model.components.idx{11}=<span class="string">'LL'</span>;
0101 LL.A=@(p,t,dt) 1;
0102 LL.pA=[];
0103 LL.pA0=[];
0104 LL.C=@(p,t,dt) 1;
0105 LL.pC=[];
0106 LL.pC0=[];
0107 LL.I=@(p,t,dt) 0;
0108 LL.pI=[];
0109 LL.pI0=[];
0110 LL.Q=@(p,t,dt) p^2*dt';
0111 LL.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LL'</span>,[],[],[nan,nan], PriorType, PriorMean, PriorSdev};
0112 LL.x={<span class="string">'x^{LL}'</span>,[],[]};
0113 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0114     LL.pQ0={<span class="string">'0'</span>};
0115     LL.init={<span class="string">'10'</span>,<span class="string">'0.1^2'</span>};
0116 <span class="keyword">else</span>
0117     LL.pQ0={<span class="string">'0'</span>};
0118     LL.init={<span class="string">'nanmean(data.values(1:round(length(timestamps)*0.1), obs))'</span>,<span class="string">'(2*nanstd(data.values(:,obs)))^2'</span>};
0119 <span class="keyword">end</span>
0120 LL.B=@(p,t,dt) 0;
0121 LL.pB=[];
0122 LL.pB0=[];
0123 LL.W=@(p,t,dt) 0;
0124 LL.pW=[];
0125 LL.pW0=[];
0126 
0127 <span class="comment">%#12 Local trend</span>
0128 model.components.idx{12}=<span class="string">'LT'</span>;
0129 LT.A=@(p,t,dt) [1 dt;0 1];
0130 LT.pA=[];
0131 LT.pA0=[];
0132 LT.C=@(p,t,dt) [1 0];
0133 LT.pC=[];
0134 LT.pC0=[];
0135 LT.I=@(p,t,dt) [0 0];
0136 LT.pI=[];
0137 LT.pI0=[];
0138 LT.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^3/3 dt^2/2;dt^2/2 dt];
0139 LT.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LT'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev };
0140 LT.x={<span class="string">'x^{L}'</span>,[],[];<span class="string">'x^{LT}'</span>,[],[]};
0141 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0142     LT.pQ0={<span class="string">'1E-7'</span>};
0143     LT.init={<span class="string">'[10 -0.001]'</span>,<span class="string">'[0.1^2 0.1^2]'</span>};
0144 <span class="keyword">else</span>
0145     LT.pQ0={<span class="string">'1E-7*nanstd(data.values(:,obs))'</span>};
0146     <span class="comment">%LT.init={'[nanmean(data.values(1:max(min(365*dt_ref,numberOfTimeSteps),round(0.1*numberOfTimeSteps)), obs)) 0]','[(1E-1*nanstd(data.values(:,obs)))^2 (1E-3*nanstd(data.values(:,obs)))^2]'};</span>
0147     LT.init={<span class="string">'[nanmean(data.values(1:round(length(timestamps)*0.1), obs)) 0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2]'</span>};
0148 <span class="keyword">end</span>
0149 LT.B=@(p,t,dt) zeros(1,2);
0150 LT.pB=[];
0151 LT.pB0=[];
0152 LT.W=@(p,t,dt) zeros(2);
0153 LT.pW=[];
0154 LT.pW0=[];
0155 <span class="comment">% LT.B=@(p,t,dt) p'*dt/dt_ref;</span>
0156 <span class="comment">% LT.pB=[{'B_L','LT',[],[],[-inf,inf]};{'B_T','LT',[],[],[-inf,inf]}];</span>
0157 <span class="comment">% LT.pB0=[{'1E-2'};{'1E-3'}];</span>
0158 <span class="comment">% LT.W=@(p,t,dt) diag((p*dt/dt_ref).^2);</span>
0159 <span class="comment">% LT.pW=[{'\sigma_WL','LT',[],[],[0,inf]};{'\sigma_WT','LT',[],[],[0,inf]}];</span>
0160 <span class="comment">% LT.pW0=[{'nanstd(data.values(:,obs))'};{'0.1*nanstd(data.values(:,obs))'}];</span>
0161 
0162 <span class="comment">%#13 Local acceleration</span>
0163 model.components.idx{13}=<span class="string">'LA'</span>;
0164 LA.A=@(p,t,dt)[1 dt 0.5*dt^2;0 1 dt;0 0 1];
0165 LA.pA=[];
0166 LA.pA0=[];
0167 LA.C=@(p,t,dt)[1 0 0];
0168 LA.pC=[];
0169 LA.pC0=[];
0170 LA.I=@(p,t,dt) [0 0 0];
0171 LA.pI=[];
0172 LA.pI0=[];
0173 LA.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^5/20 dt^4/8 dt^3/6;dt^4/8 dt^3/3 dt^2/2;dt^3/6 dt^2/2 dt];
0174 LA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LA'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};
0175 LA.x={<span class="string">'x^{L}'</span>,[],[];<span class="string">'x^{T}'</span>,[],[];<span class="string">'x^{LA}'</span>,[],[]};
0176 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0177     LA.pQ0={<span class="string">'1E-8'</span>};
0178     LA.init={<span class="string">'[10 -0.001 -0.00001]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0179 <span class="keyword">else</span>
0180     LA.pQ0={<span class="string">'1E-8*nanstd(data.values(:,obs))'</span>};
0181     <span class="comment">%LA.init={'[nanmean(data.values(1:max(min(365*dt_ref,numberOfTimeSteps),round(0.1*numberOfTimeSteps)), obs)) 0 0]','[(1E-1*nanstd(data.values(:,obs)))^2 (1E-4*nanstd(data.values(:,obs)))^2 (1E-8*nanstd(data.values(:,obs)))^2]'};</span>
0182     LA.init={<span class="string">'[nanmean(data.values(1:round(length(timestamps)*0.1), obs)) 0 0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2]'</span>};
0183 <span class="keyword">end</span>
0184 LA.B=@(p,t,dt) zeros(1,3);
0185 LA.pB=[];
0186 LA.pB0=[];
0187 LA.W=@(p,t,dt) zeros(3);
0188 LA.pW=[];
0189 LA.pW0=[];
0190 <span class="comment">% LA.B=@(p,t,dt) p'*dt/dt_ref;</span>
0191 <span class="comment">% LA.pB=[{'B_L','LA',[],[],[-inf,inf]};{'B_T','LA',[],[],[-inf,inf]};{'B_LA','LA',[],[],[-inf,inf]}];</span>
0192 <span class="comment">% LA.pB0=[{'1E-2'};{'1E-3'};{'1E-4'}];</span>
0193 <span class="comment">% LA.W=@(p,t,dt) diag((p*dt/dt_ref).^2);</span>
0194 <span class="comment">% LA.pW=[{'\sigma_WL','LA',[],[],[0,inf]};{'\sigma_WT','LA',[],[],[0,inf]};{'\sigma_WA','LA',[],[],[0,inf]}];</span>
0195 <span class="comment">% LA.pW0=[{'nanstd(data.values(:,obs))'};{'0.1*nanstd(data.values(:,obs))'};{'0.01*nanstd(data.values(:,obs))'}];</span>
0196 
0197 <span class="comment">%#21 Local level compatible with LT</span>
0198 model.components.idx{21}=<span class="string">'LcT'</span>;
0199 LcT.A=@(p,t,dt) [1 0;0 0];
0200 LcT.pA=[];
0201 LcT.pA0=[];
0202 LcT.C=@(p,t,dt) [1 0];
0203 LcT.pC=[];
0204 LcT.pC0=[];
0205 LcT.I=@(p,t,dt) [0 0];
0206 LcT.pI=[];
0207 LcT.pI0=[];
0208 <span class="comment">%LcT.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0;0 1E-15/(p^2*dt/dt_ref)];</span>
0209 LcT.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0;0 1E-30];
0210 LcT.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LcT'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};
0211 LcT.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LTc}'</span>,[],[]};
0212 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0213     LcT.pQ0={<span class="string">'1E-7'</span>};
0214     LcT.init={<span class="string">'[10 0]'</span>,<span class="string">'[0.1^2 (1E-6)^2]'</span>};
0215 <span class="keyword">else</span>
0216     LcT.pQ0={<span class="string">'1E-7*nanstd(data.values(:,obs))'</span>};
0217     <span class="comment">%LcT.init={'[nanmean(data.values(1:max(min(365*dt_ref,numberOfTimeSteps),round(0.1*numberOfTimeSteps)), obs)) 0]','[(1E-1*nanstd(data.values(:,obs)))^2 (1E-6*nanstd(data.values(:,obs)))^2]'};</span>
0218     LcT.init={<span class="string">'[nanmean(data.values(1:round(length(timestamps)*0.1), obs)) 0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2]'</span>};
0219 <span class="keyword">end</span>
0220 LcT.B=@(p,t,dt) zeros(1,2);
0221 LcT.pB=[];
0222 LcT.pB0=[];
0223 LcT.W=@(p,t,dt) zeros(2);
0224 LcT.pW=[];
0225 LcT.pW0=[];
0226 
0227 <span class="comment">%#22 Local level compatible with LA</span>
0228 model.components.idx{22}=<span class="string">'LcA'</span>;
0229 LcA.A=@(p,t,dt) [1 0 0;0 0 0; 0 0 0]';
0230 LcA.pA=[];
0231 LcA.pA0=[];
0232 LcA.C=@(p,t,dt) [1 0 0];
0233 LcA.pC0=[];
0234 LcA.pC=[];
0235 LcA.I=@(p,t,dt) [0 0 0];
0236 LcA.pI=[];
0237 LcA.pA0=[];
0238 <span class="comment">%LcA.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0 0;0 0 0; 0 0 1E-15/(p^2*dt/dt_ref)];</span>
0239 LcA.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0 0;0 0 0; 0 0 1E-30];
0240 LcA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LcA'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};
0241 LcA.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LTc}'</span>,[],[];<span class="string">'x^{LAc}'</span>,[],[]};
0242 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0243     LcA.pQ0={<span class="string">'1E-7'</span>};
0244     LcA.init={<span class="string">'[10 -0.1 0]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0245 <span class="keyword">else</span>
0246     LcA.pQ0={<span class="string">'1E-7*nanstd(data.values(:,obs))'</span>};
0247     <span class="comment">%LcA.init={'[nanmean(data.values(1:round(max(min(365*dt_ref,numberOfTimeSteps),round(0.1*numberOfTimeSteps)), obs)) 0 0]','[(1E-1*nanstd(data.values(:,obs)))^2 (1E-3*nanstd(data.values(:,obs)))^2 (1E-6*nanstd(data.values(:,obs)))^2]'};</span>
0248     LcA.init={<span class="string">'[nanmean(data.values(1:round(length(timestamps)*0.1), obs)) 0 0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2]'</span>};
0249 <span class="keyword">end</span>
0250 LcA.B=@(p,t,dt) zeros(1,3);
0251 LcA.pB=[];
0252 LcA.pB0=[];
0253 LcA.W=@(p,t,dt) zeros(3);
0254 LcA.pW=[];
0255 LcA.pW0=[];
0256 
0257 
0258 <span class="comment">%#23 Local trend compatible with LA</span>
0259 model.components.idx{23}=<span class="string">'TcA'</span>;
0260 TcA.A=@(p,t,dt) [1 dt 0;0 1 0; 0 0 0];
0261 TcA.pA=[];
0262 TcA.pA0=[];
0263 TcA.C=@(p,t,dt) [1 0 0];
0264 TcA.pC=[];
0265 TcA.pC0=[];
0266 TcA.I=@(p,t,dt) [0 0 0];
0267 TcA.pI=[];
0268 TcA.pC0=[];
0269 <span class="comment">%TcA.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^3/3 dt^2/2 0;dt^2/2 dt 0; 0 0 1E-15/(p^2*dt/dt_ref)];</span>
0270 TcA.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^3/3 dt^2/2 0;dt^2/2 dt 0; 0 0 1E-30];
0271 TcA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'TcA'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};
0272 TcA.x={<span class="string">'x^{L}'</span>,[],[];<span class="string">'x^{LT}'</span>,[],[];<span class="string">'x^{LAc}'</span>,[],[]};
0273 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0274     TcA.pQ0={<span class="string">'1E-8'</span>};
0275     TcA.init={<span class="string">'[10 -0.1 0]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0276 <span class="keyword">else</span>
0277     TcA.pQ0={<span class="string">'1E-8*nanstd(data.values(:,obs))'</span>};
0278     <span class="comment">%TcA.init={'[nanmean(data.values(1:max(min(365*dt_ref,numberOfTimeSteps),round(0.1*numberOfTimeSteps)), obs)) 0 0]','[(1E-1*nanstd(data.values(:,obs)))^2 (1E-4*nanstd(data.values(:,obs)))^2 (1E-20*nanstd(data.values(:,obs)))^2]'};</span>
0279     TcA.init={<span class="string">'[nanmean(data.values(1:round(length(timestamps)*0.1), obs)) 0 0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2 (nanstd(data.values(:,obs)))^2]'</span>};
0280 <span class="keyword">end</span>
0281 TcA.B=@(p,t,dt) zeros(1,3);
0282 TcA.pB=[];
0283 TcA.pB0=[];
0284 TcA.W=@(p,t,dt) zeros(3);
0285 TcA.pW=[];
0286 TcA.pW0=[];
0287 
0288 <span class="comment">%#31 Periodic component</span>
0289 model.components.idx{31}=<span class="string">'PD'</span>;
0290 PD.A=@(p,t,dt) [cos(2*pi*dt/p(1)) sin(2*pi*dt/p(1));-sin(2*pi*dt/p(1)) cos(2*pi*dt/p(1))];
0291 PD.pA={<span class="string">'p'</span>,<span class="string">'PD'</span>,[],[nan,nan]};
0292 PD.pA0={<span class="string">'365.2422'</span>,<span class="string">'1'</span>,<span class="string">'365.2422/2'</span>,<span class="string">'7'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span> , <span class="string">'1'</span>};
0293 PD.C=@(p,t,dt) [1 0];
0294 PD.pC=[];
0295 PD.pC0=[];
0296 PD.I=@(p,t,dt) [p 0];
0297 PD.pI={<span class="string">'\phi'</span>,<span class="string">'PD,I'</span>,[],[],[-inf,inf], PriorType, PriorMean, PriorSdev};
0298 PD.pI0={<span class="string">'0.5'</span>};
0299 PD.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0;0 1];
0300 PD.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'PD'</span>,[],[],[nan,nan], PriorType, PriorMean, PriorSdev};
0301 PD.x={<span class="string">'x^{S1}'</span>,[],[];<span class="string">'x^{S2}'</span>,[],[]};
0302 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0303     PD.pQ0={<span class="string">'0'</span>};
0304     PD.init={<span class="string">'[10,10]'</span>,<span class="string">'[(2*0.1)^2,(2*0.1)^2]'</span>};
0305 <span class="keyword">else</span>
0306     PD.pQ0={<span class="string">'0*nanstd(data.values(:,obs))'</span>};
0307     PD.init={<span class="string">'[5,0]'</span>,<span class="string">'[(2*nanstd(data.values(:,obs)))^2,(2*nanstd(data.values(:,obs)))^2]'</span>};
0308 <span class="keyword">end</span>
0309 PD.B=@(p,t,dt) 0;
0310 PD.pB=[];
0311 PD.pB0=[];
0312 PD.W=@(p,t,dt) diag([0,0]);
0313 PD.pW=[];
0314 PD.pW0=[];
0315 
0316 <span class="comment">%#41 Autoregressive component</span>
0317 model.components.idx{41}=<span class="string">'AR'</span>;
0318 AR.A=@(p,t,dt)  p(1)^(dt/dt_ref);
0319 AR.pA={<span class="string">'\phi'</span>,<span class="string">'AR'</span>,[],[],[0,1], PriorType, PriorMean, PriorSdev};
0320 AR.pA0={<span class="string">'0.75'</span>};
0321 AR.C=@(p,t,dt) 1;
0322 AR.pC=[];
0323 AR.pC0=[];
0324 AR.I=@(p,t,dt) p;
0325 AR.pI={<span class="string">'\phi'</span>,<span class="string">'AR,I'</span>,[],[],[-inf,inf], PriorType, PriorMean, PriorSdev};
0326 AR.pI0={<span class="string">'0.5'</span>};
0327 AR.Q=@(p,t,dt) p^2*dt/dt_ref;
0328 AR.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'AR'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};
0329 AR.x={<span class="string">'x^{AR}'</span>,[],[]};
0330 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0331     AR.pQ0={<span class="string">'1E-1*0.1'</span>};
0332     AR.init={<span class="string">'0'</span>,<span class="string">'0.1^2'</span>};
0333 <span class="keyword">else</span>
0334     AR.pQ0={<span class="string">'1E-1*nanstd(data.values(:,obs))'</span>};
0335     AR.init={<span class="string">'0'</span>,<span class="string">'(nanstd(data.values(:,obs)))^2'</span>};
0336 <span class="keyword">end</span>
0337 AR.B=@(p,t,dt) 0;
0338 AR.pB=[];
0339 AR.pB0=[];
0340 AR.W=@(p,t,dt) 0;
0341 AR.pW=[];
0342 AR.pW0=[];
0343 
0344 <span class="comment">%#51 Kernel Regression</span>
0345 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'nb_KR_p'</span>)
0346     model.components.nb_KR_p=misc.options.KRNumberControlPoints+1;
0347 <span class="keyword">end</span>
0348 model.components.idx{51}=<span class="string">'KR'</span>;
0349 KR.A=@(p,t,dt) [[0 <a href="../../../OpenBDLM_V1.0/functions/StateEstimation/Kernel_component.html" class="code" title="function [K_norm]=Kernel_component(reg_parameters,timestamp,timestamp_ref,nb_p)">Kernel_component</a>(p,t,timestamps(1),model.components.nb_KR_p-1)];zeros(model.components.nb_KR_p-1,1) eye(model.components.nb_KR_p-1)];
0350 KR.pA=[{<span class="string">'\ell'</span>,<span class="string">'KR'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev}; <span class="keyword">...</span>
0351     {<span class="string">'p'</span>,<span class="string">'KR'</span>,[],[],[nan,nan], PriorType, PriorMean, PriorSdev}];
0352 KR.pA0=[{<span class="string">'0.5'</span>};{<span class="string">'365.2422'</span>}];
0353 KR.C=@(p,t,dt) [1 zeros(1,model.components.nb_KR_p-1)];
0354 KR.pC=[];
0355 KR.pC0=[];
0356 KR.I=@(p,t,dt) p*[1 zeros(1,model.components.nb_KR_p-1)];
0357 KR.pI={<span class="string">'\phi'</span>,<span class="string">'KR,I'</span>,[],[],[-inf,inf], PriorType, PriorMean, PriorSdev};
0358 KR.pI0={<span class="string">'0.01'</span>};
0359 <span class="comment">%KR.Q=@(p,t,dt) blkdiag(0,eye(model.components.nb_KR_p-1)*p^2*dt/dt_ref);</span>
0360 KR.Q=@(p,t,dt) blkdiag(p(1)^2*dt/dt_ref,eye(model.components.nb_KR_p-1)*p(2)^2*dt/dt_ref);
0361 KR.pQ=[{<span class="string">'\sigma_w'</span>,<span class="string">'KR'</span>,[],[],[0,inf], PriorType, PriorMean, PriorSdev};<span class="keyword">...</span>
0362     {<span class="string">'\sigma_hw'</span>,<span class="string">'KR'</span>,[],[],[NaN,NaN], PriorType, PriorMean, PriorSdev}];
0363 KR.x=[];
0364 <span class="keyword">for</span> i=0:model.components.nb_KR_p-1
0365     KR.x=[KR.x;{[<span class="string">'x^{KR'</span> num2str(i) <span class="string">'}'</span>],[],[]}];
0366 <span class="keyword">end</span>
0367 clear i
0368 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0369     t = linspace(1,2*pi, model.components.nb_KR_p);
0370     a=sin(t);
0371     b=sin(4*t+30);
0372     c = sin(8*t-45);
0373     summ=a+b+c;
0374     summ_trun = summ(1:model.components.nb_KR_p);
0375     
0376     KR.pQ0=[{<span class="string">'0'</span>};{<span class="string">'0'</span>}];
0377     KR.init={[<span class="string">'['</span> sprintf(<span class="string">'%f '</span>, summ_trun) <span class="string">']'</span>],[<span class="string">'['</span> repmat(<span class="string">'0.01 '</span>,[1,model.components.nb_KR_p]) <span class="string">']'</span>]};
0378 <span class="keyword">else</span>
0379     
0380     KR.pQ0=[{<span class="string">'1E-1*nanstd(data.values(:,obs))'</span>};{<span class="string">'0'</span>}];
0381     <span class="comment">%KR.init={['[' repmat('0 ',[1,model.components.nb_KR_p]) ']'],['[' '1E-4*nanstd(data.values(:,obs))^2 ' repmat('nanstd(data.values(:,obs))^2 ',[1,model.components.nb_KR_p-1]) ']']};</span>
0382     KR.init={[<span class="string">'['</span> repmat(<span class="string">'0 '</span>,[1,model.components.nb_KR_p]) <span class="string">']'</span>],[<span class="string">'['</span> <span class="string">'nanstd(data.values(:,obs))^2 '</span> repmat(<span class="string">'nanstd(data.values(:,obs))^2 '</span>,[1,model.components.nb_KR_p-1]) <span class="string">']'</span>]};
0383 <span class="keyword">end</span>
0384 KR.B=@(p,t,dt) zeros(1,model.components.nb_KR_p);
0385 KR.pB=[];
0386 KR.pB0=[];
0387 KR.W=@(p,t,dt) zeros(model.components.nb_KR_p);
0388 KR.pW=[];
0389 KR.pW0=[];
0390 <span class="comment">% KR.B=@(p,t,dt) zeros(1,model.components.nb_KR_p);</span>
0391 <span class="comment">% KR.pB=[];</span>
0392 <span class="comment">% KR.pB0=[];</span>
0393 <span class="comment">% KR.W=@(p,t,dt) eye(model.components.nb_KR_p)*p^2*dt/dt_ref;</span>
0394 <span class="comment">% KR.pW={'\sigma_W','KR',[],[],[0,inf]};</span>
0395 <span class="comment">% KR.pW0={'1E-2*nanstd(data.values(:,obs))'};</span>
0396 
0397 <span class="comment">%#61 Level intervention</span>
0398 model.components.idx{61}=<span class="string">'LI'</span>;
0399 LI.A=@(p,t,dt) 1;
0400 LI.pA=[];
0401 LI.pA0=[];
0402 LI.C=@(p,t,dt) 1;
0403 LI.pC=[];
0404 LI.pC0=[];
0405 LI.I=@(p,t,dt) 0;
0406 LI.pI=[];
0407 LI.pI0=[];
0408 LI.Q=@(p,t,dt) 0;
0409 LI.pQ=[];
0410 LI.x={<span class="string">'x^{LI}'</span>,[],[]};
0411 LI.pQ0={<span class="string">'0'</span>};
0412 LI.init={<span class="string">'0'</span>,<span class="string">'1E-20'</span>};
0413 LI.B=@(p,t,dt) p'*dt/dt_ref;
0414 LI.pB=[{<span class="string">'b'</span>,<span class="string">'LI'</span>,[],[],[-inf,inf]}];
0415 LI.pB0=[{<span class="string">'1E-1*nanstd(data.values(:,obs))'</span>}];
0416 LI.W=@(p,t,dt) (p*dt/dt_ref).^2;
0417 LI.pW=[{<span class="string">'\sigma_W'</span>,<span class="string">'LI'</span>,[],[],[0,inf]}];
0418 LI.pW0=[{<span class="string">'nanstd(data.values(:, obs))'</span>}];
0419 
0420 <span class="comment">%% Block initialization</span>
0421 param_properties={};        <span class="comment">%Reference vector for parameter names in A,C,Q,R matrices</span>
0422 param_idx=1;                <span class="comment">%Index for parameter count in A,C,Q,R matrices</span>
0423 x_count=zeros(numberOfTimeSeries,100);
0424 parameter=[];               <span class="comment">%Default values for parameters</span>
0425 nb_param_class=1;           <span class="comment">%number of parameter per model class</span>
0426 <span class="keyword">for</span> class_from=1:numberOfModelClass  <span class="comment">%Loop over each model class</span>
0427     h_count=0;                   <span class="comment">%Count of the number of periodic component</span>
0428     A{class_from}=[];            <span class="comment">%Matrices initialization</span>
0429     R{class_from}=[];
0430     B{class_from}=[];
0431     W{class_from}=[];
0432     initX{class_from}=[];        <span class="comment">%Initial state variable expected value</span>
0433     initV{class_from}=[];        <span class="comment">%Initial state variable variance</span>
0434     hidden_states_names{class_from}={};     <span class="comment">%Reference vector for hidden state variables names</span>
0435     <span class="keyword">for</span> class_to=1:numberOfModelClass<span class="comment">%Loop over each model class</span>
0436         Q{class_from}{class_to}=[];
0437         CI_block=cell(numberOfTimeSeries);
0438         <span class="keyword">for</span> obs=1:numberOfTimeSeries   <span class="comment">%Loop over each observation</span>
0439             p_count=0;                   <span class="comment">%Count of the number of periodic component</span>
0440             nb_hidden_states{class_from}{obs}=0;
0441             C{class_from}{obs,obs}=[];
0442             C_block=[];
0443             <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0444                 block_idx=model.components.block{class_from}{obs}(block);
0445                 block_name=model.components.idx{block_idx};
0446                 <span class="keyword">if</span> class_from==class_to
0447                     x_count(obs,block_idx)=x_count(obs,block_idx)+1;    <span class="comment">%count the number of components</span>
0448                     <span class="keyword">if</span> x_count(obs,block_idx)&gt;1
0449                         count_label=num2str(x_count(obs,block_idx));
0450                     <span class="keyword">else</span>
0451                         count_label=num2str([]);
0452                     <span class="keyword">end</span>
0453                     name=eval([block_name <span class="string">'.x'</span>]);
0454                     <span class="keyword">for</span> i=1:size(name,1)
0455                         name{i,2}=num2str(class_from);
0456                         name{i,3}=num2str(obs);
0457                         hidden_states_names{class_from}=[hidden_states_names{class_from};name(i,:)];
0458                     <span class="keyword">end</span>
0459                     <span class="comment">% initial hidden state values</span>
0460                     initX{class_from}=[initX{class_from},eval(eval([block_name <span class="string">'.init{1}'</span>]))];
0461                     initV{class_from}=[initV{class_from},eval(eval([block_name <span class="string">'.init{2}'</span>]))];
0462                     
0463                     <span class="comment">% A - Transition matrix</span>
0464                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0465                         A{class_from}=[A{class_from},<span class="string">','</span>,[block_name <span class="string">'.A(p(['</span> num2str(A_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0466                     <span class="keyword">else</span>
0467                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pA,1)'</span>]);
0468                         <span class="keyword">if</span> nb_param&gt;0
0469                             p_idx=param_idx:param_idx-1+nb_param;
0470                         <span class="keyword">else</span>
0471                             p_idx=[];
0472                         <span class="keyword">end</span>
0473                         A{class_from}=[A{class_from},<span class="string">','</span>,[block_name <span class="string">'.A(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0474                         <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pA'</span>]),<span class="string">'p'</span>))
0475                             p_count=p_count+1;
0476                             name={<span class="string">'p'</span> ,[<span class="string">'PD'</span> num2str(p_count)],[],[],eval([block_name <span class="string">'.pA{4}'</span>]), PriorType, PriorMean, PriorSdev};
0477                             p_value=eval([block_name <span class="string">'.pA0{'</span> num2str(p_count) <span class="string">'}'</span>]);
0478                             <span class="keyword">if</span> ~isempty(p_value)
0479                                 parameter=[parameter;eval(p_value)];
0480                             <span class="keyword">end</span>
0481                         <span class="keyword">elseif</span> strcmp(block_name,<span class="string">'KR'</span>)
0482                             name=eval([block_name <span class="string">'.pA'</span>]);
0483                             k_count=0;
0484                             <span class="keyword">for</span> i=1:2
0485                                 k_count=k_count+1;
0486                                 p_value=eval([block_name <span class="string">'.pA0{'</span> num2str(k_count) <span class="string">'}'</span>]);
0487                                 parameter=[parameter;eval(p_value)];
0488                                 name{i,3}=[num2str(class_from)];
0489                                 name{i,4}=num2str(obs);
0490                             <span class="keyword">end</span>
0491                         <span class="keyword">else</span>
0492                             name=eval([block_name <span class="string">'.pA'</span>]);
0493                             p_value=eval([block_name <span class="string">'.pA0'</span>]);
0494                             <span class="keyword">if</span> ~isempty(p_value)
0495                                 parameter=[parameter;eval(p_value{:})];
0496                             <span class="keyword">end</span>
0497                         <span class="keyword">end</span>
0498                         <span class="keyword">if</span> ~isempty(name)&amp;&amp;~strcmp(block_name,<span class="string">'KR'</span>)
0499                             name{3}=[num2str(class_from)];
0500                             name{4}=num2str(obs);
0501                         <span class="keyword">end</span>
0502                         param_properties=[param_properties;name];
0503                         A_param_ref{class_from}{obs}{block}=p_idx;
0504                         param_idx=param_idx+nb_param;
0505                     <span class="keyword">end</span>
0506                     
0507                     <span class="comment">% Q - Model transition error covariance</span>
0508                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0509                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(Q_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0510                         Q_param_ref{class_from}{obs}{block}=Q_param_ref{1}{obs}{block};
0511                     <span class="keyword">else</span>
0512                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pQ,1)'</span>]);
0513                         <span class="keyword">if</span> nb_param&gt;0
0514                             p_idx=param_idx:param_idx-1+nb_param;
0515                         <span class="keyword">else</span>
0516                             p_idx=[];
0517                         <span class="keyword">end</span>
0518                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0519                         <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pA'</span>]),<span class="string">'p'</span>))
0520                             name={<span class="string">'\sigma_w'</span>,[<span class="string">'PD'</span> num2str(p_count)],[],[],eval([block_name <span class="string">'.pQ{5}'</span>]), PriorType, PriorMean, PriorSdev};
0521                         <span class="keyword">else</span>
0522                             name=eval([block_name <span class="string">'.pQ'</span>]);
0523                         <span class="keyword">end</span>
0524                         <span class="keyword">if</span> ~isempty(name)
0525                             <span class="keyword">for</span> i=1:nb_param
0526                                 p_value=eval(eval([block_name <span class="string">'.pQ0{'</span> num2str(i) <span class="string">'}'</span>]));
0527                                 parameter=[parameter;p_value];
0528                                 name{i,3}=[num2str(class_from)];
0529                                 name{i,4}=num2str(obs);
0530                             <span class="keyword">end</span>
0531                         <span class="keyword">end</span>
0532                         param_properties=[param_properties;name];
0533                         Q_param_ref{class_from}{obs}{block}=p_idx;
0534                         param_idx=param_idx+nb_param;
0535                     <span class="keyword">end</span>
0536                     
0537                     <span class="comment">% C - Observation matrix</span>
0538                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0539                         C_block=[C_block,<span class="string">','</span>,[block_name <span class="string">'.C(p(['</span> num2str(C_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0540                     <span class="keyword">else</span>
0541                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pC,1)'</span>]);
0542                         <span class="keyword">if</span> nb_param&gt;0
0543                             p_idx=param_idx:param_idx-1+nb_param;
0544                         <span class="keyword">else</span>
0545                             p_idx=[];
0546                         <span class="keyword">end</span>
0547                         C_block=[C_block,<span class="string">','</span>,[block_name <span class="string">'.C(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0548                         name=eval([block_name <span class="string">'.pC'</span>]);
0549                         <span class="keyword">if</span> ~isempty(name)
0550                             <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pC{1,1}'</span>]),<span class="string">'ycp1'</span>))
0551                                 <span class="keyword">for</span> i=1:size(eval([block_name <span class="string">'.pC'</span>]),1)
0552                                     h_count=h_count+1;
0553                                     p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(h_count) <span class="string">'}'</span>]);
0554                                     parameter=[parameter;eval(p_value)];
0555                                     name{i,3}=[num2str(class_from)];
0556                                     name{i,4}=num2str(obs);
0557                                 <span class="keyword">end</span>
0558                             <span class="keyword">elseif</span> any(strcmp(eval([block_name <span class="string">'.pC{1,1}'</span>]),<span class="string">'\ell'</span>))
0559                                 C_block_K=[block_name <span class="string">'.C(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>];
0560                                 k_count=0;
0561                                 <span class="keyword">for</span> i=1:2
0562                                     k_count=k_count+1;
0563                                     p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(k_count) <span class="string">'}'</span>]);
0564                                     parameter=[parameter;eval(p_value)];
0565                                     name{i,3}=[num2str(class_from)];
0566                                     name{i,4}=num2str(obs);
0567                                 <span class="keyword">end</span>
0568                             <span class="keyword">else</span>
0569                                 p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(p_count) <span class="string">'}'</span>]);
0570                                 parameter=[parameter;eval(h_value)];
0571                                 name{3}=[num2str(class_from)];
0572                                 name{4}=num2str(obs);
0573                             <span class="keyword">end</span>
0574                         <span class="keyword">end</span>
0575                         param_properties=[param_properties;name];
0576                         C_param_ref{class_from}{obs}{block}=p_idx;
0577                         param_idx=param_idx+nb_param;
0578                     <span class="keyword">end</span>
0579                     nb_hidden_states{class_from}{obs}=nb_hidden_states{class_from}{obs}+length(eval([block_name <span class="string">'.A(ones(1,10000),1,1)'</span>]));
0580                     
0581                     <span class="keyword">if</span> isfield(data,<span class="string">'interventions'</span>)
0582                         <span class="comment">% B - Interventions mean shift</span>
0583                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pB,1)'</span>]);
0584                         <span class="keyword">if</span> nb_param&gt;0
0585                             p_idx=param_idx:param_idx-1+nb_param;
0586                         <span class="keyword">else</span>
0587                             p_idx=[];
0588                         <span class="keyword">end</span>
0589                         B{class_from}=[B{class_from},<span class="string">','</span>,[block_name <span class="string">'.B(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0590                         name=eval([block_name <span class="string">'.pB'</span>]);
0591                         <span class="keyword">if</span> ~isempty(name)
0592                             <span class="keyword">for</span> i=1:size(name,1)
0593                                 p_value=eval(eval([block_name <span class="string">'.pB0{i}'</span>]));
0594                                 parameter=[parameter;p_value];
0595                                 name{i,3}=[num2str(class_from)];
0596                                 name{i,4}=num2str(obs);
0597                                 name{i,6}=PriorType;
0598                                 name{i,7}=PriorMean;
0599                                 name{i,8}=PriorSdev;
0600                             <span class="keyword">end</span>
0601                         <span class="keyword">end</span>
0602                         param_properties=[param_properties;name];
0603                         B_param_ref{class_from}{obs}{block}=p_idx;
0604                         param_idx=param_idx+nb_param;
0605                         
0606                         <span class="comment">% W - Interventions covariance</span>
0607                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pW,1)'</span>]);
0608                         <span class="keyword">if</span> nb_param&gt;0
0609                             p_idx=param_idx:param_idx-1+nb_param;
0610                         <span class="keyword">else</span>
0611                             p_idx=[];
0612                         <span class="keyword">end</span>
0613                         W{class_from}=[W{class_from},<span class="string">','</span>,[block_name <span class="string">'.W(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0614                         name=eval([block_name <span class="string">'.pW'</span>]);
0615                         <span class="keyword">if</span> ~isempty(name)
0616                             <span class="keyword">for</span> i=1:size(name,1)
0617                                 p_value=eval(eval([block_name <span class="string">'.pW0{i}'</span>]));
0618                                 parameter=[parameter;p_value];
0619                                 name{i,3}=[num2str(class_from)];
0620                                 name{i,4}=num2str(obs);
0621                                 name{i,6}=PriorType;
0622                                 name{i,7}=PriorMean;
0623                                 name{i,8}=PriorSdev;
0624                             <span class="keyword">end</span>
0625                         <span class="keyword">end</span>
0626                         param_properties=[param_properties;name];
0627                         W_param_ref{class_from}{obs}{block}=p_idx;
0628                         param_idx=param_idx+nb_param;
0629                     <span class="keyword">end</span>
0630                 <span class="keyword">end</span>
0631             <span class="keyword">end</span>
0632             <span class="keyword">if</span> class_from==class_to
0633                 
0634                 R{class_from}=[R{class_from},<span class="string">',p(['</span> num2str(param_idx) <span class="string">'])^2'</span>];
0635                 C{class_from}{obs,obs}=[C{class_from}{obs,obs},<span class="string">',['</span> C_block(2:end) <span class="string">']'</span>];
0636                 param_properties=[param_properties;{[<span class="string">'\sigma_v'</span>],[],[num2str(class_from)],[num2str(obs)],[0,inf], PriorType, PriorMean, PriorSdev}];
0637                 
0638                 <span class="keyword">if</span> misc.internalVars.isDataSimulation
0639                     parameter=[parameter;0.01];
0640                 <span class="keyword">else</span>
0641                     parameter=[parameter;0.05*nanstd(data.values(:,obs))];
0642                 <span class="keyword">end</span>
0643                 param_idx=param_idx+1;
0644                 
0645                 <span class="comment">% PCA inter-component regression</span>
0646                 <span class="keyword">if</span> isfield(model.components,<span class="string">'PCA'</span>)
0647                     <span class="comment">%PCA_coeff=model.components.PCA{obs};</span>
0648                     <span class="keyword">for</span> pca_idx=1:length(model.components.ic{obs})
0649                         PCA_reg_param{obs}(pca_idx)=param_idx;
0650                         param_properties=[param_properties;{[<span class="string">'\phi'</span>],[ num2str(obs) <span class="string">'|'</span> <span class="string">'PC'</span> num2str(pca_idx) ],[num2str(class_from)],[num2str(obs)],[-inf,inf], PriorType, PriorMean, PriorSdev}];
0651                         parameter=[parameter;1];
0652                         param_idx=param_idx+1;
0653                     <span class="keyword">end</span>
0654                     
0655                 <span class="keyword">end</span>
0656                 
0657                 <span class="comment">% I - Inter-component regression</span>
0658                 <span class="keyword">for</span> obs_idx=1:numberOfTimeSeries
0659                     
0660                     <span class="keyword">if</span> obs_idx ~= obs
0661                         C{class_from}{obs_idx,obs} = [];
0662                     <span class="keyword">end</span>
0663                     
0664                     ic_idx=find([model.components.ic{obs_idx}]==obs);
0665                     <span class="keyword">if</span> ~isempty(ic_idx)
0666                         <span class="comment">%param_reg=0;</span>
0667                         <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0668                             block_idx=model.components.block{class_from}{obs}(block);
0669                             block_name=model.components.idx{block_idx};
0670                             
0671                             <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0672                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">','</span>,[block_name <span class="string">'.I(p(['</span> num2str(IC_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0673                             <span class="keyword">else</span>
0674                                 nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pI,1)'</span>]);
0675                                 <span class="keyword">if</span> nb_param&gt;0
0676                                     p_idx=param_idx:param_idx-1+nb_param;
0677                                     param_reg=p_idx;
0678                                     param_properties=[param_properties;{<span class="string">'\phi'</span>, [num2str(obs_idx) <span class="string">'|'</span> num2str(obs) <span class="string">'('</span> block_name <span class="string">')'</span> ],[num2str(class_from)],[num2str(obs)],[-inf,inf], PriorType, PriorMean, PriorSdev}];
0679                                     parameter=[parameter;eval(eval([block_name <span class="string">'.pI0{:}'</span>]))];
0680                                     param_idx=param_idx+1;
0681                                     
0682                                 <span class="keyword">else</span>
0683                                     p_idx=[];
0684                                 <span class="keyword">end</span>
0685                                     C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">','</span>,[block_name <span class="string">'.I(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0686                             <span class="keyword">end</span>
0687                             <span class="keyword">if</span> isfield(model.components,<span class="string">'PCA'</span>)
0688                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">'*'</span>,<span class="string">'sum(p(['</span> num2str(PCA_reg_param{obs_idx}) <span class="string">']).*model.components.PCA{'</span> num2str(obs_idx) <span class="string">'}('</span> num2str(ic_idx) <span class="string">',:)'')'</span> ];
0689                             <span class="keyword">end</span>
0690                             IC_param_ref{class_from}{obs}{block}=p_idx;
0691                         <span class="keyword">end</span>
0692                     <span class="keyword">elseif</span> obs_idx~=obs
0693                         C{class_from}{obs_idx,obs}=[<span class="string">','</span> num2str(zeros(1,nb_hidden_states{class_from}{obs}))];
0694                     <span class="keyword">end</span>
0695                 <span class="keyword">end</span>
0696             <span class="keyword">end</span>
0697         <span class="keyword">end</span>
0698         <span class="keyword">if</span> class_from==class_to
0699             <span class="keyword">for</span> obs=1:numberOfTimeSeries  <span class="comment">%Loop over each observation</span>
0700                 Cc{class_from}{obs,1}=[<span class="string">',['</span> cell2mat(C{class_from}(obs,:)) <span class="string">']'</span>];
0701             <span class="keyword">end</span>
0702             model.A{class_from}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> A{class_from}(2:end) <span class="string">')'</span>]);
0703             model.C{class_from}=eval([<span class="string">'@(p,t,dt) reshape(['</span> ([Cc{class_from}{:}]) <span class="string">'],['</span> num2str(sum([nb_hidden_states{class_from}{:}])) <span class="string">','</span>  num2str(numberOfTimeSeries) <span class="string">'])'''</span>]);
0704             model.R{class_from}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> R{class_from}(2:end) <span class="string">')'</span>]);
0705             model.Q{class_from}{class_to}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> Q{class_from}{class_to}(2:end) <span class="string">')'</span>]);
0706             model.B{class_from}=eval([<span class="string">'@(p,t,dt) ['</span> B{class_from}(2:end) <span class="string">']'</span>]);
0707             model.W{class_from}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> W{class_from}(2:end) <span class="string">')'</span>]);
0708         <span class="keyword">end</span>
0709     <span class="keyword">end</span>
0710 <span class="keyword">end</span>
0711 
0712 <span class="comment">%% Q_ij model process noise transition errors</span>
0713 <span class="keyword">for</span> class_from=1:numberOfModelClass  <span class="comment">%Loop over each model class</span>
0714     <span class="keyword">for</span> class_to=setdiff([1:numberOfModelClass],class_from)<span class="comment">%Loop over each model class</span>
0715         Q{class_from}{class_to}=[];
0716         <span class="keyword">if</span> class_from~=class_to
0717             <span class="keyword">for</span> obs=1:numberOfTimeSeries   <span class="comment">%Loop over each observation</span>
0718                 <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0719                     block_idx=model.components.block{class_from}{obs}(block);
0720                     block_name=model.components.idx{block_idx};
0721                     <span class="comment">% Q - Model transition error covariance</span>
0722                     <span class="keyword">if</span> block_idx&gt;10&amp;&amp;block_idx&lt;30
0723                         nb_param=1;
0724                         <span class="comment">%nb_param=size(eval([block_name '.Q(1,1,1)']),1);</span>
0725                         <span class="keyword">if</span> nb_param&gt;0
0726                             p_idx=param_idx:param_idx-1+nb_param;
0727                         <span class="keyword">else</span>
0728                             p_idx=[];
0729                         <span class="keyword">end</span>
0730                         <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0731                             Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(Q_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0732                         <span class="keyword">else</span>
0733                             <span class="comment">%Q{class_from}{class_to}=[Q{class_from}{class_to},',',['diag(p([' num2str(p_idx) ']))']];</span>
0734                             Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0735                             <span class="keyword">for</span> i=1:nb_param
0736                                 name=[eval([block_name <span class="string">'.pQ'</span>])];
0737                                 <span class="keyword">if</span> ~isempty(name)
0738                                     <span class="keyword">if</span> nb_param&gt;1
0739                                         name{1}=name{1};
0740                                         <span class="comment">%name{1}=[name{1},'(' num2str(i),num2str(i) ')'];</span>
0741                                     <span class="keyword">end</span>
0742                                     parameter=[parameter;1E3*eval(eval([block_name <span class="string">'.pQ0{:}'</span>]))];
0743                                     name{3}=[num2str(class_from) num2str(class_to)];
0744                                     name{4}=num2str(obs);
0745                                 <span class="keyword">end</span>
0746                                 param_properties=[param_properties;name];
0747                             <span class="keyword">end</span>
0748                             param_idx=param_idx+nb_param;
0749                         <span class="keyword">end</span>
0750                     <span class="keyword">else</span>
0751                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(Q_param_ref{class_from}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0752                     <span class="keyword">end</span>
0753                 <span class="keyword">end</span>
0754             <span class="keyword">end</span>
0755         <span class="keyword">end</span>
0756         <span class="keyword">if</span> class_from~=class_to
0757             model.Q{class_from}{class_to}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> Q{class_from}{class_to}(2:end) <span class="string">')'</span>]);
0758         <span class="keyword">end</span>
0759     <span class="keyword">end</span>
0760 <span class="keyword">end</span>
0761 
0762 <span class="comment">%% Initial nanmean vector and covariance matrix</span>
0763 
0764 <span class="keyword">if</span> ~isfield(model,<span class="string">'initX'</span>)
0765     <span class="keyword">for</span> class_from=1:numberOfModelClass
0766         model.initX{class_from}=initX{class_from}';
0767     <span class="keyword">end</span>
0768 <span class="keyword">end</span>
0769 <span class="keyword">if</span> ~isfield(model,<span class="string">'initV'</span>)
0770     <span class="keyword">for</span> class_from=1:numberOfModelClass
0771         model.initV{class_from}=diag(initV{class_from});
0772     <span class="keyword">end</span>
0773 <span class="keyword">end</span>
0774 <span class="keyword">if</span> ~isfield(model,<span class="string">'initS'</span>)
0775     <span class="keyword">for</span> class_from=1:numberOfModelClass
0776         model.initS{class_from}=1/numberOfModelClass;
0777     <span class="keyword">end</span>
0778 <span class="keyword">end</span>
0779 
0780 <span class="comment">%% Transition matrix</span>
0781 model.Z=[];
0782 <span class="keyword">if</span> numberOfModelClass==1
0783     model.Z=@(p,t,dt) 1;
0784 <span class="keyword">elseif</span> numberOfModelClass==2
0785     model.Z=@(p,t,dt) eval([<span class="string">'[p('</span> num2str(param_idx) <span class="string">') 1-p('</span> num2str(param_idx) <span class="string">') ;1-p('</span> num2str(param_idx) <span class="string">'+1) p('</span> num2str(param_idx) <span class="string">'+1) ]^(dt/'</span> num2str(dt_ref) <span class="string">')'</span>]);
0786     param_properties=[param_properties;{<span class="string">'Z(11)'</span>,[],<span class="string">'11'</span>,[],[0,1], PriorType, PriorMean, PriorSdev};{<span class="string">'Z(22)'</span>,[],<span class="string">'22'</span>,[],[0,1], PriorType, PriorMean, PriorSdev}];
0787     parameter=[parameter;1-1/(365/dt_ref*10);1-1/(365/dt_ref*10)];
0788     param_idx=param_idx+2;
0789     
0790 <span class="keyword">else</span>
0791     <span class="keyword">for</span> i=1:numberOfModelClass
0792         <span class="keyword">for</span> j=i:numberOfModelClass
0793             param_idx=param_idx+1;
0794             model.Z=[model.Z;{ <span class="string">'p(param_idx)'</span>}];
0795             param_properties=[param_properties;{<span class="string">'\pi_z'</span>,[],[num2str(i),num2str(j)], [] ,[nan,nan], PriorType, PriorMean, PriorSdev}];
0796             parameter=[parameter;0.5];
0797         <span class="keyword">end</span>
0798     <span class="keyword">end</span>
0799     model.Z=@(p,t,dt) [reshape(model.Z),[numberOfModelClass,numberOfModelClass]]^(dt/dt_ref);
0800 <span class="keyword">end</span>
0801 
0802 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'PCA'</span>)
0803     model.components.PCA=cell(1,numberOfTimeSeries);
0804 <span class="keyword">end</span>
0805 
0806 <span class="comment">% Model hidden states name</span>
0807 model.hidden_states_names=hidden_states_names;
0808 
0809 <span class="comment">% Create model.param_properties using default values only if</span>
0810 <span class="comment">% model.param_properties does not exist</span>
0811 
0812 <span class="keyword">if</span> ~isfield(model,<span class="string">'param_properties'</span>)
0813     
0814     <span class="comment">% No parameter constrain by default</span>
0815     p_ref = 1:length(parameter);
0816     p_ref=p_ref';
0817     
0818     <span class="comment">% Add parameter and p_ref to param_properties</span>
0819     [model.param_properties]=<a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>(param_properties, <span class="keyword">...</span>
0820         [parameter, p_ref], size(param_properties,2)+1);
0821     
0822 <span class="keyword">else</span>
0823     
0824     <span class="comment">%% Read model parameter properties</span>
0825     idx_pvalues=size(model.param_properties,2)-1;
0826     idx_pref= size(model.param_properties,2);
0827     
0828     [arrayOut]=<span class="keyword">...</span>
0829         <a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>(model.param_properties, [idx_pvalues, idx_pref]);
0830     
0831     parameter= arrayOut(:,1);
0832     p_ref = arrayOut(:,2);
0833     
0834     <span class="comment">%% Write model parameter properties</span>
0835     <span class="comment">% Add parameter and p_ref to param_properties</span>
0836     [model.param_properties]=<a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>(model.param_properties, <span class="keyword">...</span>
0837         [parameter, p_ref], 9);
0838     
0839 <span class="keyword">end</span>
0840 
0841 <span class="comment">%--------------------END CODE ------------------------</span>
0842 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 05-Feb-2019 11:23:52 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>