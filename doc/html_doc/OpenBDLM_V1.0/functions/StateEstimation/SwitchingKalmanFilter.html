<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of SwitchingKalmanFilter</title>
  <meta name="keywords" content="SwitchingKalmanFilter">
  <meta name="description" content="SWITCHINGKALMANFILTER Perform Switching Kalman filtering of time series">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">OpenBDLM_V1.0</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">StateEstimation</a> &gt; SwitchingKalmanFilter.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for OpenBDLM_V1.0/functions/StateEstimation&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>SwitchingKalmanFilter
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SWITCHINGKALMANFILTER Perform Switching Kalman filtering of time series</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [x, V, VV, S, loglik,U,D]=SwitchingKalmanFilter(data, model, misc) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">SWITCHINGKALMANFILTER Perform Switching Kalman filtering of time series

   SYNOPSIS:
      [x, V, VV, S, loglik,U,D]=SWITCHINGKALMANFILTER(data, model, misc)
 
   INPUT:
      data             - structure (required)
                         see documentation for details about the fields of
                         data
                         data contains time series to be filtered

      model            - structure (required)
                         see documentation for details about the fields of
                         model
                         model contains A,C,Q,R matrices to perform
                         filtering
                         model also contains hidden states mean and variance
                         initial values at t=0

      misc             - structure (required)
                         see documentation for details about the fields of
                         misc
 
   OUTPUT:
      x                - 1×M cell array
                         M refers to the number of model class in the
                         model
                         Each element in the array is a NxT real array,
                         which is the filtered posterior hidden state mean vector 
                         for each time t (t=1,...,T) for one model class
                         
      V                - 1×M cell array
                         M refers to the number of model class in the
                         model
                         Each element in the array is a NxNxT real array,
                         which is the filtered posterior hidden state covariance 
                         matrix for each time t (t=1,...,T) for one model 
                         class

      VV               - 1×M cell array
                         M refers to the number of model class in the
                         model
                         Each element in the array is a NxNxT real array,

      S                - TxM real valued array 
                         M refers to the number of model class in the
                         model
                         filtered posterior probability of each model class

     loglik            - real value
                         full log-likelihood
                         sum of the log-likelihood computed at each time t

     U                 - real-valued array

     D                 - real-valued array                         
 
   DESCRIPTION:
      SWITCHINGKALMANFILTER performs Switching Kalman filtering of time 
      series.
      SWITCHINGKALMANFILTER allows to process non-stationary time series
      (with switching dynamics) by including several model classes.
      One model class is a given model structure (i.e a given dynamics)
      The probability of each model class is given at each time t.

      A special case of Kalman filtering named UD filtering is also 
      implemented in SWITCHINGKALMANFILTER.
      UD filtering avoids numerical issues which may occur with classical
      Kalman filtering.
 
   EXAMPLES:
      [x, V, VV, S, loglik,U,D]=SWITCHINGKALMANFILTER(data, model, misc)
 
   EXTERNAL FUNCTIONS CALLED:
      KalmanFilter, UDFilter
 
   SUBFUNCTIONS:
      N/A
 
   See also STATESTIMATION, <a href="KalmanFilter.html" class="code" title="function [xnew, Vnew, VVnew, loglik]=KalmanFilter(A, C, Q, R, y, x, V,varargin)">KALMANFILTER</a>, <a href="UDFilter.html" class="code" title="function [xnew, Vnew, VVnew, U_post, D_post, loglik]=UDFilter(A, C, Q, R, y, x, V, U_post, D_post)">UDFILTER</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../OpenBDLM_V1.0/functions/DataLoader/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>	COMPUTETIMESTEPS Compute timestep vector from timestamps vector</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>	DEFINEREFERENCETIMESTEP Compute reference timestep of a timestamp vector</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>	READPARAMETERPROPERTIES Extract some columns of a cell array</li><li><a href="KalmanFilter.html" class="code" title="function [xnew, Vnew, VVnew, loglik]=KalmanFilter(A, C, Q, R, y, x, V,varargin)">KalmanFilter</a>	KALMANFILTER Do one step of the Kalman filter (prediction + update at time t)</li><li><a href="UDFilter.html" class="code" title="function [xnew, Vnew, VVnew, U_post, D_post, loglik]=UDFilter(A, C, Q, R, y, x, V, U_post, D_post)">UDFilter</a>	UDFILTER Do one step of the UD filter (prediction + update at time t)</li><li><a href="myUD.html" class="code" title="function [U, D] = myUD(mat,varargin)">myUD</a>	MYUD Compute the UD decomposition</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../OpenBDLM_V1.0/functions/ModelParametersLearning/NewtonRaphson.html" class="code" title="function [optim, model]=NewtonRaphson(data, model, misc)">NewtonRaphson</a>	NEWTONRAPHSON Learn models parameters using the Newton-Raphson technique</li><li><a href="../../../OpenBDLM_V1.0/functions/ModelParametersLearning/logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>	INPUTS:</li><li><a href="StateEstimation.html" class="code" title="function [estimation]=StateEstimation(data, model, misc, varargin)">StateEstimation</a>	STATEESTIMATION State estimation from switching Kalman filtering/smoothing</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [x, V, VV, S, loglik,U,D]=SwitchingKalmanFilter(data, model, misc)</a>
0002 <span class="comment">%SWITCHINGKALMANFILTER Perform Switching Kalman filtering of time series</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   SYNOPSIS:</span>
0005 <span class="comment">%      [x, V, VV, S, loglik,U,D]=SWITCHINGKALMANFILTER(data, model, misc)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   INPUT:</span>
0008 <span class="comment">%      data             - structure (required)</span>
0009 <span class="comment">%                         see documentation for details about the fields of</span>
0010 <span class="comment">%                         data</span>
0011 <span class="comment">%                         data contains time series to be filtered</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%      model            - structure (required)</span>
0014 <span class="comment">%                         see documentation for details about the fields of</span>
0015 <span class="comment">%                         model</span>
0016 <span class="comment">%                         model contains A,C,Q,R matrices to perform</span>
0017 <span class="comment">%                         filtering</span>
0018 <span class="comment">%                         model also contains hidden states mean and variance</span>
0019 <span class="comment">%                         initial values at t=0</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%      misc             - structure (required)</span>
0022 <span class="comment">%                         see documentation for details about the fields of</span>
0023 <span class="comment">%                         misc</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%   OUTPUT:</span>
0026 <span class="comment">%      x                - 1×M cell array</span>
0027 <span class="comment">%                         M refers to the number of model class in the</span>
0028 <span class="comment">%                         model</span>
0029 <span class="comment">%                         Each element in the array is a NxT real array,</span>
0030 <span class="comment">%                         which is the filtered posterior hidden state mean vector</span>
0031 <span class="comment">%                         for each time t (t=1,...,T) for one model class</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%      V                - 1×M cell array</span>
0034 <span class="comment">%                         M refers to the number of model class in the</span>
0035 <span class="comment">%                         model</span>
0036 <span class="comment">%                         Each element in the array is a NxNxT real array,</span>
0037 <span class="comment">%                         which is the filtered posterior hidden state covariance</span>
0038 <span class="comment">%                         matrix for each time t (t=1,...,T) for one model</span>
0039 <span class="comment">%                         class</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%      VV               - 1×M cell array</span>
0042 <span class="comment">%                         M refers to the number of model class in the</span>
0043 <span class="comment">%                         model</span>
0044 <span class="comment">%                         Each element in the array is a NxNxT real array,</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%      S                - TxM real valued array</span>
0047 <span class="comment">%                         M refers to the number of model class in the</span>
0048 <span class="comment">%                         model</span>
0049 <span class="comment">%                         filtered posterior probability of each model class</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%     loglik            - real value</span>
0052 <span class="comment">%                         full log-likelihood</span>
0053 <span class="comment">%                         sum of the log-likelihood computed at each time t</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%     U                 - real-valued array</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%     D                 - real-valued array</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%   DESCRIPTION:</span>
0060 <span class="comment">%      SWITCHINGKALMANFILTER performs Switching Kalman filtering of time</span>
0061 <span class="comment">%      series.</span>
0062 <span class="comment">%      SWITCHINGKALMANFILTER allows to process non-stationary time series</span>
0063 <span class="comment">%      (with switching dynamics) by including several model classes.</span>
0064 <span class="comment">%      One model class is a given model structure (i.e a given dynamics)</span>
0065 <span class="comment">%      The probability of each model class is given at each time t.</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%      A special case of Kalman filtering named UD filtering is also</span>
0068 <span class="comment">%      implemented in SWITCHINGKALMANFILTER.</span>
0069 <span class="comment">%      UD filtering avoids numerical issues which may occur with classical</span>
0070 <span class="comment">%      Kalman filtering.</span>
0071 <span class="comment">%</span>
0072 <span class="comment">%   EXAMPLES:</span>
0073 <span class="comment">%      [x, V, VV, S, loglik,U,D]=SWITCHINGKALMANFILTER(data, model, misc)</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%   EXTERNAL FUNCTIONS CALLED:</span>
0076 <span class="comment">%      KalmanFilter, UDFilter</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%   SUBFUNCTIONS:</span>
0079 <span class="comment">%      N/A</span>
0080 <span class="comment">%</span>
0081 <span class="comment">%   See also STATESTIMATION, KALMANFILTER, UDFILTER</span>
0082  
0083 <span class="comment">%   AUTHORS:</span>
0084 <span class="comment">%      Luong Ha Nguyen, Ianis Gaudot, James-A Goulet</span>
0085 <span class="comment">%</span>
0086 <span class="comment">%      Inspired from the initial codes of John Quinn, Kevin P. Murphy,</span>
0087 <span class="comment">%      Brian Moore,</span>
0088 <span class="comment">%</span>
0089 <span class="comment">%      Email: &lt;james.goulet@polymtl.ca&gt;</span>
0090 <span class="comment">%      Website: &lt;http://www.polymtl.ca/expertises/goulet-james-alexandre&gt;</span>
0091 <span class="comment">%</span>
0092 <span class="comment">%   MATLAB VERSION:</span>
0093 <span class="comment">%      Tested on 9.1.0.441655 (R2016b)</span>
0094 <span class="comment">%</span>
0095 <span class="comment">%   DATE CREATED:</span>
0096 <span class="comment">%       June 29, 2018</span>
0097 <span class="comment">%</span>
0098 <span class="comment">%   DATE LAST UPDATE:</span>
0099 <span class="comment">%       December 3, 2018</span>
0100  
0101 <span class="comment">%--------------------BEGIN CODE ----------------------</span>
0102 <span class="comment">%% Get arguments passed to the function and proceed to some verifications</span>
0103 p = inputParser;
0104 
0105 addRequired(p,<span class="string">'data'</span>, @isstruct );
0106 addRequired(p,<span class="string">'model'</span>, @isstruct );
0107 addRequired(p,<span class="string">'misc'</span>, @isstruct );
0108 parse(p,data, model, misc);
0109 
0110 data=p.Results.data;
0111 model=p.Results.model;
0112 misc=p.Results.misc;
0113 
0114 <span class="comment">%% options from misc</span>
0115 MethodStateEstimation=misc.options.MethodStateEstimation;
0116 
0117 
0118 <span class="comment">%% Get timestamps information</span>
0119 
0120 <span class="comment">% Get timestamps</span>
0121 timestamps = data.timestamps;
0122 
0123 <span class="comment">% Compute timestep vector</span>
0124 [timesteps]=<a href="../../../OpenBDLM_V1.0/functions/DataLoader/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>(timestamps);
0125 
0126 <span class="comment">% Compute reference timestep</span>
0127 [referencetimestep] = <a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>(timestamps);
0128 
0129 <span class="comment">% Number of timestamps</span>
0130 T = length(timestamps);
0131 
0132 <span class="comment">%% Get observations</span>
0133 DataValues = data.values;
0134 
0135 <span class="comment">%% Get number of model classes</span>
0136 M = model.nb_class;         
0137 
0138 <span class="comment">%% Get method to use for filtering 'kalman' or 'UD'</span>
0139 <span class="keyword">if</span> strcmp(MethodStateEstimation,<span class="string">'UD'</span>)
0140     U=cell(M,M,T);
0141     D=cell(M,M,T);
0142     <span class="keyword">if</span> isfield(model,<span class="string">'U'</span>)     <span class="comment">%Online procedure</span>
0143         <span class="keyword">for</span> j=1:M
0144             <span class="keyword">for</span> i=1:M
0145                 U{i,j,1}=model.U{i,j,1};
0146                 D{i,j,1}=model.D{i,j,1};
0147             <span class="keyword">end</span>
0148         <span class="keyword">end</span>
0149     <span class="keyword">end</span>
0150 <span class="keyword">elseif</span> strcmp(MethodStateEstimation,<span class="string">'kalman'</span>)
0151     U=[];
0152     D=[];
0153 <span class="keyword">else</span>
0154     error([<span class="string">'    Error: estimation method not '</span>, <span class="keyword">...</span>
0155         <span class="string">'recognized | SwitchingKalmanFilter.m'</span>])
0156 <span class="keyword">end</span>
0157 
0158 <span class="comment">%% Read model parameter properties</span>
0159 idx_pvalues=size(model.param_properties,2)-1;
0160 idx_pref= size(model.param_properties,2);
0161 
0162 [arrayOut]=<span class="keyword">...</span>
0163     <a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>(model.param_properties, [idx_pvalues, idx_pref]);
0164 
0165 parameter= arrayOut(:,1);
0166 p_ref = arrayOut(:,2);
0167 
0168 
0169 <span class="comment">%% Initialization</span>
0170 x = cell(1,M);
0171 V = cell(1,M);
0172 VV = cell(1,M);
0173 x_ij=cell(1,M);
0174 V_ij=cell(1,M);
0175 VV_ij=cell(1,M);
0176 sigma22_idx=find(strcmp(model.param_properties(:,1), <span class="keyword">...</span>
0177     <span class="string">'\sigma_w(22)'</span>),1,<span class="string">'first'</span>);
0178 
0179 <span class="comment">%% Preallocate the matrices A, C, R, Z, Q</span>
0180 A=cell(M,T);
0181 C=cell(M,T);
0182 R=cell(M,T);
0183 Z=cell(1,T);
0184 Q=cell(M,M,T);
0185 
0186 <span class="keyword">for</span> j=1:M
0187     ss=size(model.hidden_states_names{1},1);
0188     
0189     x{j} = zeros(ss,T);
0190     V{j} = zeros(ss, ss,T);
0191     VV{j} = zeros(ss, ss,T);
0192     
0193     x_ij{j} = zeros(ss,M);
0194     V_ij{j} = zeros(ss,ss,M);
0195     VV_ij{j} = zeros(ss,ss,M);
0196 <span class="keyword">end</span>
0197 
0198 S = zeros(T,M);
0199 W=zeros(M,M);
0200 LL=zeros(M,M,T);
0201 
0202 loglik = 0;
0203 
0204 <span class="comment">%% Interventions</span>
0205 <span class="keyword">if</span> isfield(data, <span class="string">'interventions'</span>)   
0206     interventions=find(ismember(data.timestamps,data.interventions));
0207 <span class="keyword">else</span>
0208     data.interventions=[];
0209     interventions=find(ismember(data.timestamps,data.interventions));
0210 <span class="keyword">end</span>
0211 
0212 <span class="comment">%% Estimate state for each t</span>
0213 <span class="keyword">for</span> t=1:T
0214     log_S_marginal = zeros(M,M);
0215     lik_merge=0;
0216     <span class="keyword">for</span> j=1:M       <span class="comment">% transition model</span>
0217         
0218         <span class="keyword">if</span> (t==1 | (timesteps(t)~=timesteps(1:t-1)))
0219             
0220             A{j,t} = model.A{j}(parameter(<span class="keyword">...</span>
0221                 p_ref),data.timestamps(t),timesteps(t));
0222             C{j,t} = model.C{j}(parameter(<span class="keyword">...</span>
0223                 p_ref),data.timestamps(t),timesteps(t));
0224             R{j,t} = model.R{j}(parameter(<span class="keyword">...</span>
0225                 p_ref),data.timestamps(t),timesteps(t));
0226             Z{t} = model.Z(parameter(<span class="keyword">...</span>
0227                 p_ref),data.timestamps(t),timesteps(t));
0228             B=model.B{j}(parameter(<span class="keyword">...</span>
0229                 p_ref),data.timestamps(t),timesteps(t))';
0230             WB=model.W{j}(parameter(<span class="keyword">...</span>
0231                 p_ref),data.timestamps(t),timesteps(t)); 
0232             
0233         <span class="keyword">else</span>
0234             idx=find(timesteps(t)==timesteps(1:t-1),1,<span class="string">'first'</span>);
0235 <span class="comment">%             if any([model.components.block{:}{:}]==51)</span>
0236 <span class="comment">%                 A{j,t}=model.A{j}(parameter(...</span>
0237 <span class="comment">%                     p_ref),data.timestamps(t),timesteps(t));</span>
0238 <span class="comment">%             else</span>
0239 <span class="comment">%                 A{j,t}=A{j,idx};</span>
0240 <span class="comment">%             end</span>
0241             
0242             <span class="keyword">for</span> model_loop = 1:M 
0243                extract_model = model.components.block{model_loop};
0244                <span class="keyword">if</span> any([extract_model{:}]==51)
0245                    A{j,t}=model.A{j}(parameter(<span class="keyword">...</span>
0246                        p_ref),data.timestamps(t),timesteps(t));
0247                <span class="keyword">else</span>
0248                    A{j,t}=A{j,idx};
0249                <span class="keyword">end</span>
0250            <span class="keyword">end</span>
0251             
0252             C{j,t} = model.C{j}(parameter(<span class="keyword">...</span>
0253                 p_ref),data.timestamps(t),timesteps(t));
0254             R{j,t}=R{j,idx};
0255             Z{t}=Z{idx};
0256             
0257         <span class="keyword">end</span>
0258         <span class="keyword">for</span> i=1:M   <span class="comment">% starting model</span>
0259             <span class="keyword">if</span> (t==1 | (timesteps(t)~=timesteps(1:t-1)))
0260                 Q{j,i,t} = model.Q{j}{i}(parameter(p_ref), <span class="keyword">...</span>
0261                     data.timestamps(t),timesteps(t));                
0262             <span class="keyword">else</span>
0263                 idx=find(timesteps(t)==timesteps(1:t-1),1,<span class="string">'first'</span>);
0264                 Q{j,i,t}=Q{j,i,idx};
0265             <span class="keyword">end</span>
0266 <span class="comment">%             if and(j==1,i==2)</span>
0267 <span class="comment">%                 Q{j,i,t}=diag(diag(Q{j,j,t}));</span>
0268 <span class="comment">%                 Q{j,i,t}(2,2)=parameter(...</span>
0269 <span class="comment">%                     sigma22_idx)^2*(timesteps(t)^2/referencetimestep);</span>
0270 <span class="comment">%             elseif and(j==2,i==1)</span>
0271 <span class="comment">%                 QQ = model.Q{j}{j}(parameter(...</span>
0272 <span class="comment">%                     p_ref),data.timestamps(t),timesteps(t));</span>
0273 <span class="comment">%                 Q{j,i,t}=diag(diag(QQ));</span>
0274 <span class="comment">%                 Q{j,i,t}(2,2)=parameter(...</span>
0275 <span class="comment">%                     sigma22_idx)^2*(timesteps(t)^4/(3*referencetimestep));</span>
0276 <span class="comment">%             end</span>
0277             
0278             <span class="keyword">if</span> t==1
0279                 prevX = model.initX{i};
0280                 prevV = model.initV{i};
0281                 prevS = model.initS{i};
0282                 <span class="keyword">if</span> strcmp(MethodStateEstimation,<span class="string">'UD'</span>)
0283                     <span class="keyword">if</span> and(isempty(U{i,j,t}),isempty(D{i,j,t}))
0284                         error_myUD=1;
0285                         <span class="keyword">while</span> error_myUD
0286                             <span class="keyword">try</span>
0287                                 [U{i,j,t},D{i,j,t}] = <a href="myUD.html" class="code" title="function [U, D] = myUD(mat,varargin)">myUD</a>(prevV);
0288                                 <span class="keyword">if</span> isempty(U{i,j,t})
0289                                     error_myUD=1;
0290                                 <span class="keyword">else</span>
0291                                     error_myUD=0;
0292                                 <span class="keyword">end</span>
0293                             <span class="keyword">catch</span> 
0294                                 warning([<span class="string">'UD decomposition failed '</span>, <span class="keyword">...</span>
0295                                     <span class="string">' at time step '</span> num2str(t) , <span class="keyword">...</span>
0296                                     <span class="string">'. Retry without covariance '</span>, <span class="keyword">...</span>
0297                                     <span class="string">'terms in ''prevV''.'</span>])
0298                                 prevV=diag(diag(prevV));
0299                             <span class="keyword">end</span>
0300                         <span class="keyword">end</span>
0301                     <span class="keyword">end</span>
0302                 <span class="keyword">end</span>
0303             <span class="keyword">else</span>
0304                 prevX = x{i}(:,t-1);
0305                 prevV = V{i}(:,:,t-1);
0306                 prevS = S(t-1,i);
0307             <span class="keyword">end</span>            
0308             
0309             <span class="keyword">if</span> strcmp(MethodStateEstimation,<span class="string">'UD'</span>)
0310                 <span class="comment">%% UD filter</span>
0311                 [x_ij{j}(:,i), V_ij{j}(:,:,i), VV_ij{j}(:,:,i), <span class="keyword">...</span>
0312                     U{i,j,t+1}, D{i,j,t+1}, LL(i,j,t)] = <span class="keyword">...</span>
0313                     <a href="UDFilter.html" class="code" title="function [xnew, Vnew, VVnew, U_post, D_post, loglik]=UDFilter(A, C, Q, R, y, x, V, U_post, D_post)">UDFilter</a>(A{j,t},C{j,t},Q{j,i,t},R{j,t}, <span class="keyword">...</span>
0314                     DataValues(t,:)', prevX, prevV, U{i,j,t}, D{i,j,t});
0315             <span class="keyword">else</span>
0316                 <span class="comment">%% Kalman filter</span>
0317                 warning(<span class="string">'off'</span>,<span class="string">'all'</span>)
0318                 <span class="keyword">if</span> any(t==interventions)
0319                     B_=B;
0320                     WB_=WB;
0321                 <span class="keyword">else</span>
0322                     B_=0;
0323                     WB_=0;
0324                 <span class="keyword">end</span>
0325                 [x_ij{j}(:,i), V_ij{j}(:,:,i), VV_ij{j}(:,:,i), LL(i,j,t)] = <span class="keyword">...</span>
0326                     <a href="KalmanFilter.html" class="code" title="function [xnew, Vnew, VVnew, loglik]=KalmanFilter(A, C, Q, R, y, x, V,varargin)">KalmanFilter</a>(A{j,t},C{j,t},Q{j,i,t},R{j,t}, <span class="keyword">...</span>
0327                     DataValues(t,:)', prevX, prevV,<span class="string">'B'</span>,B_,<span class="string">'W'</span>,WB_);
0328                 warning(<span class="string">'on'</span>,<span class="string">'all'</span>)
0329             <span class="keyword">end</span>
0330             
0331             <span class="keyword">if</span> isnan(LL(i,j,t))
0332                 LL(i,j,t)=1;
0333                 loglik=-inf;
0334 <span class="comment">%                                 disp(['warning: LL{ ', ...</span>
0335 <span class="comment">%                 '' num2str(i) ',' num2str(j) '}(t=' num2str(t) '', ...</span>
0336 <span class="comment">%                 ')=nan | SKF.m'])</span>
0337                 <span class="keyword">break</span>
0338             <span class="keyword">end</span>
0339             
0340             log_S_marginal(i,j)=LL(i,j,t) + log(Z{t}(i,j)) + log(prevS);
0341             S_marginal_ij=exp(log_S_marginal(i,j));
0342             <span class="keyword">if</span> S_marginal_ij==0
0343                 S_marginal_ij=1E-300;
0344             <span class="keyword">end</span>
0345             lik_merge=lik_merge + S_marginal_ij;
0346             <span class="keyword">if</span> any(any(isnan(VV_ij{j}(:,:,i))))
0347 <span class="comment">%                                  disp(['warning: VV_ij{', ...</span>
0348 <span class="comment">%                 '' num2str(i) ',' num2str(j) '}(t=' num2str(t) ')=nan ', ...</span>
0349 <span class="comment">%                     ' | SKF.m'])</span>
0350             <span class="keyword">end</span>
0351         <span class="keyword">end</span>
0352         <span class="keyword">if</span> loglik==-inf
0353 <span class="comment">%                          disp(['warning: LL{', ...</span>
0354 <span class="comment">%                              '' num2str(i) ',' num2str(j) '}(t=', ...</span>
0355 <span class="comment">%                              '' num2str(t) ')=-inf | SKF.m'])</span>
0356             <span class="keyword">break</span>
0357         <span class="keyword">end</span>
0358     <span class="keyword">end</span>
0359     <span class="keyword">if</span> loglik==-inf
0360         <span class="keyword">break</span>
0361     <span class="keyword">end</span>
0362     
0363     loglik=loglik+log(lik_merge);
0364     <span class="keyword">if</span> loglik==-inf
0365         <span class="comment">%         disp('warning: loglik=-inf | SKF.m')</span>
0366         <span class="keyword">break</span>
0367     <span class="keyword">elseif</span> isnan(loglik)
0368         <span class="comment">%         disp('warning: loglik=-inf | SKF.m')</span>
0369     <span class="keyword">end</span>
0370     
0371     S_marginal=exp(log_S_marginal);
0372     <span class="keyword">if</span> any(any(S_marginal==0))
0373         S_marginal=exp(log_S_marginal+(299-max(max(log_S_marginal))));
0374     <span class="keyword">end</span>
0375     <span class="keyword">if</span> any(any(S_marginal==0))
0376         S_marginal(S_marginal==0)=1E-100;
0377     <span class="keyword">end</span>
0378     S_norm = sum(sum(S_marginal));
0379     
0380     <span class="comment">%% posterior for state j at time t</span>
0381     S_marginal = S_marginal/S_norm;
0382     <span class="keyword">for</span> j=1:M
0383         S(t,j) = sum(S_marginal(:,j));
0384     <span class="keyword">end</span>
0385     S(t,S(t,:)==0)=1E-99;
0386     
0387     <span class="comment">%% Weights of state components</span>
0388     <span class="keyword">for</span> j=1:M
0389         <span class="keyword">for</span> i=1:M
0390             W(i,j) = S_marginal(i,j)/S(t,j);
0391         <span class="keyword">end</span>
0392     <span class="keyword">end</span>
0393     W(W==0)=1E-99;
0394     
0395     <span class="keyword">if</span> isnan(W(i,j))
0396         <span class="comment">%         disp(['warning: W(i,j)(t=' num2str(t) ')=nan | SKF.m'])</span>
0397     <span class="keyword">end</span>
0398     
0399     <span class="comment">%% Approximate new continuous state</span>
0400     <span class="keyword">for</span> j=1:M
0401         x{j}(:,t) = x_ij{j}(:,:) * W(:,j);
0402         <span class="keyword">for</span> i=1:M
0403             m = x_ij{j}(:,i) - x{j}(:,t);
0404             V{j}(:,:,t) = V{j}(:,:,t) + W(i,j)*(V_ij{j}(:,:,i) + m*m');
0405             VV{j}(:,:,t) = VV{j}(:,:,t) + W(i,j)*(VV_ij{j}(:,:,i) + m*m');
0406         <span class="keyword">end</span>
0407     <span class="keyword">end</span>
0408 <span class="keyword">end</span>
0409 <span class="comment">%--------------------END CODE ------------------------</span>
0410 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 05-Feb-2019 11:23:52 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>