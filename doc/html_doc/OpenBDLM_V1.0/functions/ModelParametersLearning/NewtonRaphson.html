<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of NewtonRaphson</title>
  <meta name="keywords" content="NewtonRaphson">
  <meta name="description" content="NEWTONRAPHSON Learn models parameters using the Newton-Raphson technique">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">OpenBDLM_V1.0</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">ModelParametersLearning</a> &gt; NewtonRaphson.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for OpenBDLM_V1.0/functions/ModelParametersLearning&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>NewtonRaphson
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>NEWTONRAPHSON Learn models parameters using the Newton-Raphson technique</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [optim, model]=NewtonRaphson(data, model, misc) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">NEWTONRAPHSON Learn models parameters using the Newton-Raphson technique

   SYNOPSIS:
     [optim]=NEWTONRAPHSON(data, model, misc)

   INPUT:
     data             - structure (required)
                        see documentation for details about the fields of
                        data

     model            - structure (required)
                        see documentation for details about the fields of
                        model

     misc             - structure (required)
                        see documentation for details about the fields of
                        misc
   OUTPUT:
     optim            - structure
                        * optim.parameter_OR_opt: optimal parameters in
                          original space
                        * optim.parameter_TR_opt: optimal parameters in
                          transformed space.
                        * optim.covParamTR_matrix: parameter covariance
                          matrix in transformed space. The parameter 
                          covariance matrix is computed using the Laplace 
                          Approximation arount the point estimate.

     model            - structure (required)
                           see documentation for details about the fields of
                           model

   DESCRIPTION:
      NEWTONRAPHSON is an implementation of the Newton-Raphson
      algorithm to learn the model parameters of the Bayesian dynamic
      linear models.
      NEWTONRAPHSON can either perform Maximum Likelihood Estimation (MLE) 
      or Maximum A Posteriori estimation (MAP). MAP required a valid prior
      for each unknown model parameters.
      The MLE (MAP) Newton-Raphson technique is used to iteratively
      search for the maximum of the log-likelihood (or log-posterior) using
      approximated derivatives computed using the finite-difference method.

      NEWTONRAPHSON computes point estimate (MLE or MAP) of the model 
      parameters. It may also provide confidence intervals around the point 
      estimate using the Laplace approximation, assuming that the function 
      around the optimized parameter value can be approximated using a 
      gaussian distribution.
      Note that computing the Laplace approximation can significantly
      increases the computation time for high dimensional problem.

      For bounded model parameters ([a,b], [0,Inf]), NEWTONRAPHSON works in
      transformed space.

      WARNING: Newton-Raphson technique is sensitive to the initial model
      parameters values. Newton-Raphson can reach a local maximum, instead
      of the global maximum of the target function.
      Always re-run the optimizations several times, with different
      starting model parameters values, in order to
      check that the proposed solution is stable.

   EXAMPLES:
      [optim]=NEWTONRAPHSON(data, model, misc)

   EXTERNAL FUNCTIONS CALLED:
      logPosteriorPE, logPriorDistr, LaplaceApproximation,
        parameter_transformation_fct

   SUBFUNCTIONS:

   See also <a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">LOGPOSTERIORPE</a>, <a href="logPriorDistr.html" class="code" title="function [logprior, Glogprior, Hlogprior]= logPriorDistr(P, Mu, Sigma, varargin)">LOGPRIORDISTR</a>, LAPLACEAPPROXIMATION,
   <a href="parameter_transformation_fct.html" class="code" title="function [fct_TR,fct_inv_TR,grad_TR2OR,hessian_TR2OR]=parameter_transformation_fct(model,param_idx_loop)">PARAMETER_TRANSFORMATION_FCT</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../OpenBDLM_V1.0/functions/DataLoader/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>	COMPUTETIMESTEPS Compute timestep vector from timestamps vector</li><li><a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>	INPUTS:</li><li><a href="logPriorDistr.html" class="code" title="function [logprior, Glogprior, Hlogprior]= logPriorDistr(P, Mu, Sigma, varargin)">logPriorDistr</a>	The other distribution will be added later</li><li><a href="numerical_hessian.html" class="code" title="function H=numerical_hessian(x, fX, varargin)">numerical_hessian</a>	% Defaut values</li><li><a href="parameter_transformation_fct.html" class="code" title="function [fct_TR,fct_inv_TR,grad_TR2OR,hessian_TR2OR]=parameter_transformation_fct(model,param_idx_loop)">parameter_transformation_fct</a>	</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/day2sampleIndex.html" class="code" title="function [Index]=day2sampleIndex(day, timestamps)">day2sampleIndex</a>	DAY2SAMPLEINDEX Convert a number of days to timestamp index</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>	DEFINEREFERENCETIMESTEP Compute reference timestep of a timestamp vector</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>	READPARAMETERPROPERTIES Extract some columns of a cell array</li><li><a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>	WRITEPARAMETERPROPERTIES Write updated model parameter properties</li><li><a href="../../../OpenBDLM_V1.0/functions/StateEstimation/SwitchingKalmanFilter.html" class="code" title="function [x, V, VV, S, loglik,U,D]=SwitchingKalmanFilter(data, model, misc)">SwitchingKalmanFilter</a>	SWITCHINGKALMANFILTER Perform Switching Kalman filtering of time series</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="learnModelParameters.html" class="code" title="function [data, model, estimation, misc]=learnModelParameters(data, model, estimation, misc, varargin)">learnModelParameters</a>	LEARNMODELPARAMETERS Learn Bayesian dynamic linear model parameters</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [covParamTR_matrix, hessParamTR_matrix, hessParamOR_matrix] =</a></li><li><a href="#_sub2" class="code">function  LL = loglik4hessian (p, data, model, misc, search_idx)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [optim, model]=NewtonRaphson(data, model, misc)</a>
0002 <span class="comment">%NEWTONRAPHSON Learn models parameters using the Newton-Raphson technique</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   SYNOPSIS:</span>
0005 <span class="comment">%     [optim]=NEWTONRAPHSON(data, model, misc)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   INPUT:</span>
0008 <span class="comment">%     data             - structure (required)</span>
0009 <span class="comment">%                        see documentation for details about the fields of</span>
0010 <span class="comment">%                        data</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%     model            - structure (required)</span>
0013 <span class="comment">%                        see documentation for details about the fields of</span>
0014 <span class="comment">%                        model</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%     misc             - structure (required)</span>
0017 <span class="comment">%                        see documentation for details about the fields of</span>
0018 <span class="comment">%                        misc</span>
0019 <span class="comment">%   OUTPUT:</span>
0020 <span class="comment">%     optim            - structure</span>
0021 <span class="comment">%                        * optim.parameter_OR_opt: optimal parameters in</span>
0022 <span class="comment">%                          original space</span>
0023 <span class="comment">%                        * optim.parameter_TR_opt: optimal parameters in</span>
0024 <span class="comment">%                          transformed space.</span>
0025 <span class="comment">%                        * optim.covParamTR_matrix: parameter covariance</span>
0026 <span class="comment">%                          matrix in transformed space. The parameter</span>
0027 <span class="comment">%                          covariance matrix is computed using the Laplace</span>
0028 <span class="comment">%                          Approximation arount the point estimate.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%     model            - structure (required)</span>
0031 <span class="comment">%                           see documentation for details about the fields of</span>
0032 <span class="comment">%                           model</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%   DESCRIPTION:</span>
0035 <span class="comment">%      NEWTONRAPHSON is an implementation of the Newton-Raphson</span>
0036 <span class="comment">%      algorithm to learn the model parameters of the Bayesian dynamic</span>
0037 <span class="comment">%      linear models.</span>
0038 <span class="comment">%      NEWTONRAPHSON can either perform Maximum Likelihood Estimation (MLE)</span>
0039 <span class="comment">%      or Maximum A Posteriori estimation (MAP). MAP required a valid prior</span>
0040 <span class="comment">%      for each unknown model parameters.</span>
0041 <span class="comment">%      The MLE (MAP) Newton-Raphson technique is used to iteratively</span>
0042 <span class="comment">%      search for the maximum of the log-likelihood (or log-posterior) using</span>
0043 <span class="comment">%      approximated derivatives computed using the finite-difference method.</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%      NEWTONRAPHSON computes point estimate (MLE or MAP) of the model</span>
0046 <span class="comment">%      parameters. It may also provide confidence intervals around the point</span>
0047 <span class="comment">%      estimate using the Laplace approximation, assuming that the function</span>
0048 <span class="comment">%      around the optimized parameter value can be approximated using a</span>
0049 <span class="comment">%      gaussian distribution.</span>
0050 <span class="comment">%      Note that computing the Laplace approximation can significantly</span>
0051 <span class="comment">%      increases the computation time for high dimensional problem.</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%      For bounded model parameters ([a,b], [0,Inf]), NEWTONRAPHSON works in</span>
0054 <span class="comment">%      transformed space.</span>
0055 <span class="comment">%</span>
0056 <span class="comment">%      WARNING: Newton-Raphson technique is sensitive to the initial model</span>
0057 <span class="comment">%      parameters values. Newton-Raphson can reach a local maximum, instead</span>
0058 <span class="comment">%      of the global maximum of the target function.</span>
0059 <span class="comment">%      Always re-run the optimizations several times, with different</span>
0060 <span class="comment">%      starting model parameters values, in order to</span>
0061 <span class="comment">%      check that the proposed solution is stable.</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%   EXAMPLES:</span>
0064 <span class="comment">%      [optim]=NEWTONRAPHSON(data, model, misc)</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%   EXTERNAL FUNCTIONS CALLED:</span>
0067 <span class="comment">%      logPosteriorPE, logPriorDistr, LaplaceApproximation,</span>
0068 <span class="comment">%        parameter_transformation_fct</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%   SUBFUNCTIONS:</span>
0071 <span class="comment">%</span>
0072 <span class="comment">%   See also LOGPOSTERIORPE, LOGPRIORDISTR, LAPLACEAPPROXIMATION,</span>
0073 <span class="comment">%   PARAMETER_TRANSFORMATION_FCT</span>
0074 
0075 <span class="comment">%   AUTHORS:</span>
0076 <span class="comment">%       Luong Ha Nguyen, Ianis Gaudot, James-A Goulet</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%      Email: &lt;james.goulet@polymtl.ca&gt;</span>
0079 <span class="comment">%      Website: &lt;http://www.polymtl.ca/expertises/goulet-james-alexandre&gt;</span>
0080 <span class="comment">%</span>
0081 <span class="comment">%   MATLAB VERSION:</span>
0082 <span class="comment">%      Tested on 9.1.0.441655 (R2016b)</span>
0083 <span class="comment">%</span>
0084 <span class="comment">%   DATE CREATED:</span>
0085 <span class="comment">%       June 22, 2018</span>
0086 <span class="comment">%</span>
0087 <span class="comment">%   DATE LAST UPDATE:</span>
0088 <span class="comment">%       December 3, 2018</span>
0089 
0090 <span class="comment">%--------------------BEGIN CODE ----------------------</span>
0091 
0092 <span class="comment">%% Get arguments passed to the function and proceed to some verifications</span>
0093 p = inputParser;
0094 
0095 addRequired(p,<span class="string">'data'</span>, @isstruct );
0096 addRequired(p,<span class="string">'model'</span>, @isstruct );
0097 addRequired(p,<span class="string">'misc'</span>, @isstruct );
0098 
0099 parse(p,data, model,  misc);
0100 
0101 data=p.Results.data;
0102 model=p.Results.model;
0103 misc=p.Results.misc;
0104 
0105 <span class="comment">%% Read current options from misc.options structure</span>
0106 trainingPeriod=misc.options.trainingPeriod;
0107 <span class="comment">%isMAP=misc.options.isMAP;</span>
0108 <span class="comment">%isPredCap=misc.options.isPredCap;</span>
0109 isLaplaceApprox = misc.options.isLaplaceApprox;
0110 maxIterations = misc.options.maxIterations;
0111 maxTime = misc.options.maxTime;
0112 nb_levels_lambda_ref = misc.options.NRLevelsLambdaRef;
0113 convergence_tolerance = misc.options.NRTerminationTolerance;
0114 
0115 <span class="comment">%isParallel=misc.options.isParallel;</span>
0116 isMute=misc.options.isMute;
0117 
0118 <span class="comment">% Set fileID for logfile</span>
0119 <span class="keyword">if</span> misc.internalVars.isQuiet
0120     <span class="comment">% output message in logfile</span>
0121     fileID=fopen(misc.internalVars.logFileName, <span class="string">'a'</span>);
0122 <span class="keyword">else</span>
0123     <span class="comment">% output message on screen and logfile using diary command</span>
0124     fileID=1;
0125 <span class="keyword">end</span>
0126 
0127 <span class="comment">%% Read model parameter properties</span>
0128 <span class="comment">% Current model parameters</span>
0129 idx_pvalues=size(model.param_properties,2)-1;
0130 idx_pref= size(model.param_properties,2);
0131 
0132 [arrayOut]=<span class="keyword">...</span>
0133     <a href="../../../OpenBDLM_V1.0/functions/Others/readParameterProperties.html" class="code" title="function [arrayOut]=readParameterProperties(cellIn, Position)">readParameterProperties</a>(model.param_properties, [idx_pvalues, idx_pref]);
0134 
0135 parameter= arrayOut(:,1);
0136 p_ref=arrayOut(:,2);
0137 
0138 <span class="comment">% Assign model.parameters</span>
0139 model.parameter=parameter;
0140 model.p_ref=p_ref;
0141 
0142 <span class="comment">%% Resize the dataset according to the chosen training period</span>
0143 <span class="comment">% Get timestamp vector</span>
0144 timestamps = data.timestamps;
0145 <span class="comment">% Get training period</span>
0146 training_start_idx = <a href="../../../OpenBDLM_V1.0/functions/Others/day2sampleIndex.html" class="code" title="function [Index]=day2sampleIndex(day, timestamps)">day2sampleIndex</a>(trainingPeriod(1), timestamps);
0147 training_end_idx = <a href="../../../OpenBDLM_V1.0/functions/Others/day2sampleIndex.html" class="code" title="function [Index]=day2sampleIndex(day, timestamps)">day2sampleIndex</a>(trainingPeriod(2), timestamps);
0148 
0149 <span class="comment">%% Interventions</span>
0150 <span class="keyword">if</span> ~isfield(data, <span class="string">'interventions'</span>)
0151     data.interventions=[];
0152 <span class="keyword">end</span>
0153 
0154 <span class="comment">% Resize timestamps</span>
0155 data_train.timestamps = timestamps(training_start_idx:training_end_idx);
0156 data_train.interventions      = data.interventions;
0157 
0158 <span class="comment">% Get timestep training vector</span>
0159 [data_train.dt_steps]=<a href="../../../OpenBDLM_V1.0/functions/DataLoader/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>(data_train.timestamps);
0160 data_train.nb_steps = length(training_start_idx:training_end_idx);
0161 
0162 <span class="comment">% Compute reference timestep during training</span>
0163 [data_train.dt_ref] = <a href="../../../OpenBDLM_V1.0/functions/Others/defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>(data_train.timestamps);
0164 
0165 <span class="comment">%Define time step vector</span>
0166 data_train.dt_steps           = [data_train.dt_ref;data_train.dt_steps];
0167 <span class="comment">% data.dt_ref                   = data_train.dt_ref ;</span>
0168 <span class="comment">% data.dt_steps(1)              = data.dt_ref;</span>
0169 
0170 <span class="comment">%Get data values</span>
0171 DataValues = data.values;
0172 <span class="comment">% Resize data values</span>
0173 <span class="keyword">for</span> i=1:size(data.values,2)
0174     data_train.values(:,i) = <span class="keyword">...</span>
0175         DataValues(training_start_idx:training_end_idx,i);
0176 <span class="keyword">end</span>
0177 
0178 
0179 <span class="comment">%% Identify parameters to be optimized</span>
0180 parameter_search_idx    = find(~all(isnan(reshape( <span class="keyword">...</span>
0181     [model.param_properties{:,5}],2,size(model.param_properties,1))'),2));
0182 nb_param                = length(parameter_search_idx);
0183 
0184 <span class="comment">%% Initialize transformed model parameters</span>
0185 parameter_OR            = model.parameter;
0186 parameter_TR            = zeros(length(model.parameter),1);
0187 transfFunc.TR           = cell(1,nb_param);
0188 transfFunc.InvTR        = cell(1,nb_param);
0189 transfFunc.gradTR2OR    = cell(1,nb_param);
0190 <span class="keyword">for</span> i = 1 : nb_param
0191     idx                 = parameter_search_idx(i);
0192     [transfFunc.TR{i},transfFunc.InvTR{i},transfFunc.gradTR2OR{i},~] =  <span class="keyword">...</span>
0193         <a href="parameter_transformation_fct.html" class="code" title="function [fct_TR,fct_inv_TR,grad_TR2OR,hessian_TR2OR]=parameter_transformation_fct(model,param_idx_loop)">parameter_transformation_fct</a>(model,idx);
0194     parameter_TR(idx)   = transfFunc.TR{i}(parameter_OR(idx));
0195 <span class="keyword">end</span>
0196 <span class="comment">% parameterTR_ref = parameter_TR;</span>
0197 model.parameterTR   = parameter_TR;
0198 
0199 disp(<span class="string">'     Learning model parameters (Newton-Raphson) ...'</span>)
0200 
0201 <span class="keyword">if</span> ~isMute
0202     fprintf(fileID, <span class="string">'\n'</span>);
0203     fprintf(fileID, [<span class="string">'    \\Start Newton-Raphson maximization '</span>, <span class="keyword">...</span>
0204         <span class="string">' algorithm (finite difference method)\n'</span>]);
0205     fprintf(fileID, <span class="string">'\n'</span>);
0206     fprintf(fileID, [<span class="string">'      Training period:'</span>, <span class="keyword">...</span>
0207         <span class="string">'                                      '</span>,<span class="keyword">...</span>
0208         <span class="string">' '</span> num2str(trainingPeriod(1)) <span class="string">'-'</span>,<span class="keyword">...</span>
0209         <span class="string">''</span>  num2str(trainingPeriod(2)) <span class="string">' [days]\n'</span>]);
0210     fprintf(fileID, [<span class="string">'      Maximal number of iteration:'</span>, <span class="keyword">...</span>
0211         <span class="string">'                          '</span>,<span class="keyword">...</span>
0212         <span class="string">' '</span> num2str(maxIterations), <span class="string">'\n'</span>]);
0213     fprintf(fileID, [<span class="string">'      Total time limit for calibration :'</span>, <span class="keyword">...</span>
0214         <span class="string">'                    '</span>,<span class="keyword">...</span>
0215         <span class="string">' '</span> num2str(maxTime) <span class="string">' [min]\n'</span>]);
0216     fprintf(fileID, [<span class="string">'      Convergence criterion:'</span>, <span class="keyword">...</span>
0217         <span class="string">'                                '</span>,<span class="keyword">...</span>
0218         <span class="string">' '</span> num2str(convergence_tolerance) <span class="string">'*LL\n'</span>]);
0219     fprintf(fileID, [<span class="string">'      Nb. of search levels for \\lambda:'</span>, <span class="keyword">...</span>
0220         <span class="string">'                     '</span>,<span class="keyword">...</span>
0221         <span class="string">' '</span> num2str(nb_levels_lambda_ref) <span class="string">'*2\n'</span>]);
0222     fprintf(fileID, <span class="string">'\n'</span>);
0223 <span class="keyword">end</span>
0224 
0225 <span class="comment">%% Matrices &amp; parameter initilization</span>
0226 hessian_fail_hist        = zeros(1,numel(parameter_search_idx));
0227 optimization_fail        = zeros(1,numel(parameter_search_idx));
0228 converged                = zeros(1,numel(parameter_search_idx));
0229 dll                      = 1E6*ones(1,numel(parameter_search_idx));
0230 grad_p_TR                = zeros(size(parameter_OR));
0231 hessian_p_TR             = zeros(size(parameter_OR));
0232 std_p                    = zeros(size(parameter_OR));
0233 std_p_TR                 = abs(parameter_TR);
0234 delta_grad               = 1E-3*ones(size(parameter_OR));
0235 <span class="comment">%% Log-likelihood initialization</span>
0236 [logpdf_0, ~, ~,~] = <a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>(data_train, model, misc, <span class="string">'getlogpdf'</span>, 1);
0237 <span class="keyword">if</span> isinf(logpdf_0)
0238     fprintf(fileID, <span class="string">'Warning: LL0=-inf\n'</span>);
0239 <span class="keyword">end</span>
0240 <span class="keyword">if</span> ~isMute
0241     fprintf(fileID, <span class="string">'           Initial LL: %s\n'</span>, num2str(logpdf_0));
0242 <span class="keyword">end</span>
0243 name_idx_1=<span class="string">''</span>;
0244 name_idx_2=<span class="string">''</span>;
0245 <span class="keyword">for</span> i=parameter_search_idx'
0246     name_p1{i}=[model.param_properties{i,1}];
0247     <span class="keyword">if</span> ~isempty(model.param_properties{i,4})
0248         temp=model.param_properties{i,4}(1);
0249     <span class="keyword">else</span>
0250         temp=<span class="string">''</span>;
0251     <span class="keyword">end</span>
0252     name_p2{i}=[model.param_properties{i,2}, <span class="string">'|M'</span>, <span class="keyword">...</span>
0253         model.param_properties{i,3},<span class="string">'|'</span>,temp];
0254     name_idx_1=[name_idx_1  name_p1{i} <span class="keyword">...</span>
0255         repmat(<span class="string">' '</span>,[1,15-length(name_p1{i})]) <span class="string">' '</span>];
0256     name_idx_2=[name_idx_2  name_p2{i} <span class="keyword">...</span>
0257         repmat(<span class="string">' '</span>,[1,15-length(name_p2{i})]) <span class="string">' '</span>];
0258 <span class="keyword">end</span>
0259 <span class="keyword">if</span> ~isMute
0260     fprintf(fileID, <span class="string">'                       %s \n'</span>, name_idx_2);
0261     fprintf(fileID, <span class="string">'      parameter names: %s \n'</span>, name_idx_1);
0262     fprintf(fileID, [<span class="string">'       initial values: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>], <span class="keyword">...</span>
0263         [1,length(parameter_OR)])],parameter_OR(parameter_search_idx));
0264 <span class="keyword">end</span>
0265 
0266 <span class="comment">%% NR Optimization loops</span>
0267 tic; <span class="comment">% time counter initialization</span>
0268 time_loop=0;
0269 search_loop=1;
0270 <span class="keyword">while</span> and(search_loop&lt;=maxIterations, <span class="keyword">...</span>
0271         time_loop&lt;(maxTime*60))
0272     <span class="keyword">if</span> ~isMute
0273         fprintf(fileID, <span class="string">'\n'</span>);
0274     <span class="keyword">end</span>
0275     parameter_OR_ref = parameter_OR;
0276     parameter_TR_ref = parameter_TR;
0277     <span class="comment">%% Select the parameter which previously led to the highest change in LL</span>
0278     rand_sample = rand;
0279     dll_cumsum  = cumsum(dll)/sum(dll);
0280     dll_rank    = dll_cumsum-rand_sample;
0281     dll_rank(dll_rank&lt;0) = inf;
0282     <span class="comment">% Remove the parameters that have small impact on log-likelihood</span>
0283     dll_rank(hessian_fail_hist&gt;10) = Inf;
0284     <span class="keyword">if</span> all(dll_rank == Inf)
0285         param_idx = find(~converged,1,<span class="string">'first'</span>);
0286     <span class="keyword">else</span>
0287         param_idx = find((dll_cumsum-rand_sample)==min(dll_rank),1,<span class="string">'first'</span>);
0288     <span class="keyword">end</span>
0289     param_idx_loop = parameter_search_idx(param_idx);
0290     param          = parameter_OR_ref(param_idx_loop);
0291     param_TR       = parameter_TR_ref(param_idx_loop);
0292     <span class="keyword">if</span> ~isMute
0293         fprintf(fileID, <span class="string">'--------------------------\n'</span>);
0294         fprintf(fileID, <span class="string">'    Loop #%s : %s | %s \n'</span>, <span class="keyword">...</span>
0295             num2str(search_loop), name_p2{param_idx_loop}, <span class="keyword">...</span>
0296             name_p1{param_idx_loop});
0297     <span class="keyword">end</span>
0298     H_test       = 1;
0299     loop_count   = 1;
0300     skip_loop_H  = 0;
0301     hessian_fail = 0;
0302     <span class="comment">% loop until the hessian can be calculated</span>
0303     <span class="keyword">while</span> H_test
0304         loop_count=loop_count +1;
0305         <span class="keyword">if</span> loop_count &gt;5 || hessian_fail
0306             <span class="keyword">if</span> ~isMute
0307                 fprintf(fileID, [<span class="string">'Warning: &gt;5 failed '</span>,<span class="keyword">...</span>
0308                     <span class="string">'attempts to compute the Hessian \n'</span>]);
0309             <span class="keyword">end</span>
0310             skip_loop_H = 1;
0311             hessian_fail_hist(param_idx)        = <span class="keyword">...</span>
0312                 hessian_fail_hist(param_idx)+1;
0313             parameter_OR(param_idx_loop)        = <span class="keyword">...</span>
0314                 parameter_OR_ref(param_idx_loop);
0315             parameter_TR(param_idx_loop)        = <span class="keyword">...</span>
0316                 parameter_TR_ref(param_idx_loop);
0317             <span class="keyword">if</span> hessian_fail_hist(param_idx)&gt;3
0318                 <span class="keyword">if</span> ~isMute
0319                     fprintf(fileID, [<span class="string">'Warning: '</span>, <span class="keyword">...</span>
0320                         <span class="string">'3nd discontinued fails '</span>, <span class="keyword">...</span>
0321                         <span class="string">'to compute the Hessian  -&gt; converged=1\n'</span>]);
0322                 <span class="keyword">end</span>
0323                 converged(param_idx) = 1;
0324             <span class="keyword">end</span>
0325             dll(param_idx) = abs(convergence_tolerance*logpdf_0);
0326             <span class="keyword">break</span>
0327         <span class="keyword">end</span>
0328         
0329         model.parameter   = parameter_OR;
0330         model.parameterTR = parameter_TR;
0331         
0332         [~, GlogpdfTR_loop, HlogpdfTR_loop, delta_grad_loop] = <span class="keyword">...</span>
0333             <a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>(data_train, model, misc,<span class="keyword">...</span>
0334             <span class="string">'paramTR_index'</span>,param_idx_loop,<span class="keyword">...</span>
0335             <span class="string">'stepSize4grad'</span>,delta_grad(param_idx_loop));
0336         
0337         delta_grad(param_idx_loop) = delta_grad_loop;
0338         <span class="keyword">if</span> hessian_fail_hist(param_idx) &gt; 0
0339             hessian_fail_hist(param_idx) = 0;
0340         <span class="keyword">end</span>
0341         <span class="keyword">if</span> HlogpdfTR_loop &lt; 0
0342             hessian_p_TR(param_idx_loop) = HlogpdfTR_loop;
0343             grad_p_TR(param_idx_loop)    = GlogpdfTR_loop;
0344             delta_p_TR                   = - GlogpdfTR_loop/HlogpdfTR_loop;
0345             H_test                       = 0;
0346         <span class="keyword">elseif</span> HlogpdfTR_loop &gt; 0
0347             hessian_p_TR(param_idx_loop) = HlogpdfTR_loop;
0348             grad_p_TR(param_idx_loop)    = GlogpdfTR_loop;
0349             <span class="keyword">if</span> model.param_properties{param_idx_loop,5}(1)==0 &amp;&amp; <span class="keyword">...</span>
0350                     model.param_properties{param_idx_loop,5}(2)==inf &amp;&amp; <span class="keyword">...</span>
0351                     abs(param)&lt;1E-7
0352                 delta_p_TR = sign(GlogpdfTR_loop)*0.25*param_TR;
0353             <span class="keyword">else</span>
0354                 <span class="comment">%Gradient descent must be used to reach the maxima</span>
0355                 delta_p_TR = 0.1*GlogpdfTR_loop/HlogpdfTR_loop;
0356             <span class="keyword">end</span>
0357             <span class="keyword">if</span> ~isMute
0358                 fprintf(fileID, [<span class="string">'Warning: '</span>, <span class="keyword">...</span>
0359                     <span class="string">'Hessian is positive\n'</span>]);
0360             <span class="keyword">end</span>
0361             H_test = 0;
0362         <span class="keyword">elseif</span> isnan(HlogpdfTR_loop)
0363             H_test       = 1;
0364             hessian_fail = 1;
0365         <span class="keyword">end</span>
0366     <span class="keyword">end</span>
0367     <span class="keyword">if</span> skip_loop_H ~= 1
0368         std_p_TR_loop = sqrt(-1/hessian_p_TR(param_idx_loop));
0369         <span class="comment">%Linearized Laplace approximation of parameter standard deviation</span>
0370         std_p_loop    = <span class="keyword">...</span>
0371             abs(transfFunc.gradTR2OR{param_idx}(param_TR))*std_p_TR_loop;
0372         <span class="keyword">if</span> hessian_p_TR(param_idx_loop) &lt; 0
0373             std_p(param_idx_loop)    = std_p_loop;
0374             std_p_TR(param_idx_loop) = std_p_TR_loop;
0375         <span class="keyword">else</span>
0376             std_p(param_idx_loop)    = NaN;
0377             std_p_TR(param_idx_loop) = NaN;
0378         <span class="keyword">end</span>
0379         delta_p = transfFunc.InvTR{param_idx}(param_TR+delta_p_TR) - param;
0380         <span class="keyword">if</span> ~isMute
0381             fprintf(fileID, <span class="string">'       delta_param: %s \n'</span>, num2str(delta_p));
0382         <span class="keyword">end</span>
0383         <span class="keyword">try</span>
0384             <span class="comment">%% LL test</span>
0385             parameter_TR(param_idx_loop) = param_TR + delta_p_TR;
0386             parameter_OR(param_idx_loop) = <span class="keyword">...</span>
0387                 transfFunc.InvTR{param_idx}(parameter_TR(param_idx_loop));
0388             model.parameter              = parameter_OR;
0389             model.parameterTR            = parameter_TR;
0390             [logpdf_test, ~, ~,~]        = <span class="keyword">...</span>
0391                 <a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>(data_train, model, misc, <span class="string">'getlogpdf'</span>, 1);
0392         <span class="keyword">catch</span>
0393             logpdf_test = -inf;
0394         <span class="keyword">end</span>
0395         loop_converged = 1;
0396         delta_p_TR_ref = delta_p_TR;
0397     <span class="keyword">else</span>
0398         <span class="comment">% Optimization has failed the actual parameter -&gt; move to next parameter</span>
0399         loop_converged = 0;
0400     <span class="keyword">end</span>
0401     <span class="comment">%% Check the validity of delta_p</span>
0402     n                = 0;
0403     reverse          = 0;
0404     n_ref            = 0;
0405     nb_levels_lambda = nb_levels_lambda_ref;
0406     <span class="keyword">while</span> loop_converged
0407         n=n+1;
0408         <span class="keyword">if</span> logpdf_test&gt;logpdf_0
0409             loop_converged       = 0;
0410             converged(param_idx) = and(~isnan(std_p(param_idx_loop)), <span class="keyword">...</span>
0411                 abs(logpdf_test - logpdf_0)&lt;abs(convergence_tolerance*logpdf_0));
0412             <span class="comment">% Record the change in the log-likelihood</span>
0413             dll(param_idx)       = logpdf_test - logpdf_0;
0414             <span class="keyword">if</span> dll(param_idx)&lt;abs(convergence_tolerance*logpdf_0)
0415                 <span class="keyword">if</span> isnan(std_p(param_idx_loop))
0416                     dll(param_idx) = 10*abs(convergence_tolerance*logpdf_0);
0417                 <span class="keyword">else</span>
0418                     dll(param_idx) = abs(convergence_tolerance*logpdf_0);
0419                 <span class="keyword">end</span>
0420             <span class="keyword">end</span>
0421             logpdf_0                            = logpdf_test;
0422             parameter_TR_ref(param_idx_loop)    = parameter_TR(param_idx_loop);
0423             parameter_OR_ref(param_idx_loop)    = parameter_OR(param_idx_loop);
0424             <span class="keyword">if</span> ~isMute
0425                 fprintf(fileID, [<span class="string">'    log-likelihood :'</span>, <span class="keyword">...</span>
0426                     <span class="string">' %s\n'</span>], num2str(logpdf_0));
0427                 fprintf(fileID, [<span class="string">'    param change   :'</span>, <span class="keyword">...</span>
0428                     <span class="string">' %s -&gt; %s\n'</span>], num2str(param),<span class="keyword">...</span>
0429                     num2str(parameter_OR(param_idx_loop)));
0430                 fprintf(fileID, <span class="string">'\n'</span>);
0431                 fprintf(fileID, <span class="string">'                    %s\n'</span>, name_idx_2);
0432                 fprintf(fileID, <span class="string">'   parameter names: %s\n'</span>, name_idx_1);
0433                 fprintf(fileID, [<span class="string">'    current values: '</span>, <span class="keyword">...</span>
0434                     <span class="string">''</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>], <span class="keyword">...</span>
0435                     [1,length(parameter_OR(parameter_search_idx))-1]) <span class="keyword">...</span>
0436                     <span class="string">'%#-+15.2e\n'</span>,<span class="keyword">...</span>
0437                     <span class="string">'  current f.o. std: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>],<span class="keyword">...</span>
0438                     [1,length(parameter_OR(parameter_search_idx))-1]) <span class="keyword">...</span>
0439                     <span class="string">'%#-+15.2e\n'</span>,<span class="keyword">...</span>
0440                     <span class="string">'      previous dLL: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>],<span class="keyword">...</span>
0441                     [1,length(parameter_OR(parameter_search_idx))-1]) <span class="keyword">...</span>
0442                     <span class="string">'%#-+15.2e\n'</span>,<span class="keyword">...</span>
0443                     <span class="string">'         converged: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>],<span class="keyword">...</span>
0444                     [1,length(parameter_OR(parameter_search_idx))-1]) <span class="keyword">...</span>
0445                     <span class="string">'%#-+15.2e\n'</span>],<span class="keyword">...</span>
0446                     parameter_OR(parameter_search_idx),<span class="keyword">...</span>
0447                     std_p(parameter_search_idx),<span class="keyword">...</span>
0448                     dll,<span class="keyword">...</span>
0449                     converged);
0450                 
0451             <span class="keyword">end</span>
0452             optimization_fail=optimization_fail*0;
0453             
0454             <span class="keyword">if</span> converged(param_idx)
0455                 <span class="keyword">break</span>
0456             <span class="keyword">else</span>
0457                 converged(param_idx)=0;
0458             <span class="keyword">end</span>
0459             
0460         <span class="keyword">else</span>
0461             converged(param_idx)=0;
0462             <span class="keyword">if</span> n&gt;nb_levels_lambda
0463                 <span class="keyword">if</span> ~isMute
0464                     fprintf(fileID, <span class="string">'\n'</span>);
0465                     fprintf(fileID, [<span class="string">'Warning: the optimization '</span>, <span class="keyword">...</span>
0466                         <span class="string">' loop has failed\n'</span>]);
0467                 <span class="keyword">end</span>
0468                 parameter_OR(param_idx_loop) = <span class="keyword">...</span>
0469                     parameter_OR_ref(param_idx_loop);
0470                 parameter_TR(param_idx_loop) = <span class="keyword">...</span>
0471                     parameter_TR_ref(param_idx_loop);
0472                 optimization_fail(param_idx) = <span class="keyword">...</span>
0473                     optimization_fail(param_idx)+1;
0474                 <span class="keyword">if</span> optimization_fail(param_idx)&gt;3
0475                     converged(param_idx) = 1;
0476                     dll(param_idx)       = abs(convergence_tolerance*logpdf_0);
0477                 <span class="keyword">else</span>
0478                     dll(param_idx) = 2*abs(convergence_tolerance*logpdf_0);
0479                 <span class="keyword">end</span>
0480                 <span class="keyword">break</span>
0481             <span class="keyword">elseif</span> n &lt; nb_levels_lambda
0482                 delta_p_TR  = delta_p_TR/(2^n);
0483                 delta_p     = <span class="keyword">...</span>
0484                     transfFunc.InvTR{param_idx}(param_TR + <span class="keyword">...</span>
0485                     delta_p_TR)-param;
0486                 
0487                 <span class="keyword">if</span> ~isMute
0488                     fprintf(fileID, [<span class="string">'Warning: '</span>, <span class="keyword">...</span>
0489                         <span class="string">'log-likelihood has '</span>,<span class="keyword">...</span>
0490                         <span class="string">'decreased -&gt; delta_param: %s '</span>, <span class="keyword">...</span>
0491                         <span class="string">'(delta_p_TR=delta_p_TR/(2^%s))\n'</span>], <span class="keyword">...</span>
0492                         delta_p, num2str(n));
0493                 <span class="keyword">end</span>
0494             <span class="keyword">elseif</span> n == nb_levels_lambda
0495                 <span class="keyword">if</span> reverse == 0
0496                     reverse     = 1;
0497                     n           = n_ref;
0498                     delta_p_TR  = -delta_p_TR_ref;
0499                     delta_p     = transfFunc.InvTR{param_idx} <span class="keyword">...</span>
0500                         (param_TR+delta_p_TR) - param;
0501                 <span class="keyword">elseif</span> reverse == 1
0502                     reverse          = 0;
0503                     n_ref            = n;
0504                     nb_levels_lambda = 2*nb_levels_lambda_ref;
0505                     delta_p_TR       = delta_p_TR_ref;
0506                     delta_p          = transfFunc.InvTR{param_idx} <span class="keyword">...</span>
0507                         (param_TR+delta_p_TR)-param;
0508                 <span class="keyword">end</span>
0509                 <span class="keyword">if</span> ~isMute
0510                     fprintf(fileID, [<span class="string">'Warning: '</span>, <span class="keyword">...</span>
0511                         <span class="string">'log-likelihood has '</span>,<span class="keyword">...</span>
0512                         <span class="string">'decreased -&gt; delta_param: %s '</span>, <span class="keyword">...</span>
0513                         <span class="string">'(delta_p_TR=-delta_p_TR)\n'</span>], num2str(delta_p));
0514                 <span class="keyword">end</span>
0515                 
0516             <span class="keyword">end</span>
0517             <span class="keyword">try</span>
0518                 <span class="comment">%% LL test</span>
0519                 parameter_TR(param_idx_loop) = param_TR + delta_p_TR;
0520                 parameter_OR(param_idx_loop) = <span class="keyword">...</span>
0521                     transfFunc.InvTR{param_idx}(parameter_TR(<span class="keyword">...</span>
0522                     param_idx_loop));
0523                 model.parameter              = parameter_OR;
0524                 model.parameterTR            = parameter_TR;
0525                 [logpdf_test, ~, ~,~]        = <span class="keyword">...</span>
0526                     <a href="logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, misc, varargin)">logPosteriorPE</a>(data_train, model, misc,<span class="string">'getlogpdf'</span>, 1);
0527             <span class="keyword">catch</span>
0528                 logpdf_test=-inf;
0529             <span class="keyword">end</span>
0530         <span class="keyword">end</span>
0531     <span class="keyword">end</span>
0532     search_loop=search_loop+1;
0533     <span class="keyword">if</span> all(optimization_fail&gt;0)
0534         <span class="keyword">if</span> ~isMute
0535             fprintf(fileID, <span class="string">'\n'</span>);
0536             fprintf(fileID, [<span class="string">'Warning: the optimization '</span>, <span class="keyword">...</span>
0537                 <span class="string">'has failed '</span>,<span class="keyword">...</span>
0538                 <span class="string">'for every parameter\n'</span>]);
0539         <span class="keyword">end</span>
0540         <span class="keyword">break</span>
0541     <span class="keyword">elseif</span> all(converged)
0542         <span class="keyword">if</span> ~isMute
0543             fprintf(fileID, <span class="string">'\n'</span>);
0544             fprintf(fileID, [<span class="string">'             Done ! The optimization '</span>, <span class="keyword">...</span>
0545                 <span class="string">'has converged '</span>, <span class="keyword">...</span>
0546                 <span class="string">'for all parameters\n'</span>]);
0547         <span class="keyword">end</span>
0548         <span class="keyword">break</span>
0549     <span class="keyword">end</span>
0550     time_loop=toc;
0551 <span class="keyword">end</span>
0552 <span class="keyword">if</span> ~isMute
0553     <span class="keyword">if</span> ~or(all(optimization_fail),all(converged))
0554         fprintf(fileID, <span class="string">'\n'</span>);
0555         fprintf(fileID, <span class="string">'\n'</span>);
0556         fprintf(fileID, <span class="string">'\n'</span>);
0557         <span class="keyword">if</span> time_loop&gt;(maxTime*60)
0558             fprintf(fileID, [<span class="string">'          Warning: the '</span>, <span class="keyword">...</span>
0559                 <span class="string">'optimization has reached  '</span>, <span class="keyword">...</span>
0560                 <span class="string">'the maximum allowed time ('</span>,<span class="keyword">...</span>
0561                 <span class="string">'%s [min]) '</span>,<span class="keyword">...</span>
0562                 <span class="string">'without convergence \n'</span>], <span class="keyword">...</span>
0563                 num2str(maxTime));
0564         <span class="keyword">else</span>
0565             fprintf(fileID, [<span class="string">'          Warning: the '</span>, <span class="keyword">...</span>
0566                 <span class="string">'optimization has reached the '</span>,<span class="keyword">...</span>
0567                 <span class="string">' maximum number of loops ('</span>,<span class="keyword">...</span>
0568                 <span class="string">'%s) without convergence \n'</span>], <span class="keyword">...</span>
0569                 num2str(maxIterations));
0570         <span class="keyword">end</span>
0571     <span class="keyword">end</span>
0572 <span class="keyword">end</span>
0573 
0574 <span class="keyword">if</span> ~isMute
0575     <span class="comment">%% Display final results</span>
0576     fprintf(fileID, <span class="string">'\n'</span>);
0577     fprintf(fileID, <span class="string">' ----------------------\n'</span>);
0578     fprintf(fileID, <span class="string">'    Final results\n'</span>);
0579     fprintf(fileID, <span class="string">' ----------------------\n'</span>);
0580     fprintf(fileID, <span class="string">'   log-likelihood: %s\n'</span>, num2str(logpdf_0));
0581     fprintf(fileID, <span class="string">'                   %s\n'</span>, name_idx_2);
0582     fprintf(fileID, <span class="string">'  parameter names: %s\n'</span>, name_idx_1);
0583     fprintf(fileID, [<span class="string">'   current values: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>], <span class="keyword">...</span>
0584         [1,length(parameter_OR(parameter_search_idx))-1]) <span class="string">'%#-+15.2e\n'</span>,<span class="keyword">...</span>
0585         <span class="string">' current f.o. std: '</span> repmat([<span class="string">'%#-+15.2e'</span> <span class="string">' '</span>], <span class="keyword">...</span>
0586         [1,length(parameter_OR(parameter_search_idx))-1]) <span class="string">'%#-+15.2e\n'</span>],<span class="keyword">...</span>
0587         parameter_OR(parameter_search_idx),<span class="keyword">...</span>
0588         std_p(parameter_search_idx));
0589 <span class="keyword">end</span>
0590 <span class="comment">%% Outputs</span>
0591 optim.parameter_opt         = parameter_OR;
0592 optim.parameterTR_opt       = parameter_TR;
0593 optim.std_parameter_TR_opt  = std_p;
0594 optim.hessian_p_TR_opt      = hessian_p_TR(parameter_search_idx);
0595 optim.std_parameter_TR_opt  = std_p_TR;
0596 optim.converged             = converged;
0597 optim.search_loop           = search_loop;
0598 optim.log_lik               = logpdf_0;
0599 optim.data                  = data;
0600 optim.data_train            = data_train;
0601 optim.misc                  = misc;
0602 
0603 <span class="comment">%% Laplace Approximation</span>
0604 <span class="comment">%if all(converged) &amp;&amp; isLaplaceApprox</span>
0605 <span class="keyword">if</span> isLaplaceApprox
0606     fprintf(fileID, <span class="string">'    Laplace Approximation...\n'</span>);
0607     [covParamTR_matrix, hessParamTR_matrix, hessParamOR_matrix] = <span class="keyword">...</span>
0608         LaplaceApproximation(data, model, misc,<span class="keyword">...</span>
0609         parameter_TR,<span class="keyword">...</span>
0610         parameter_OR,<span class="keyword">...</span>
0611         transfFunc.gradTR2OR,<span class="keyword">...</span>
0612         parameter_search_idx,<span class="keyword">...</span>
0613         std_p_TR);
0614     
0615     <span class="comment">% Store results</span>
0616     optim.covParamTR_matrix     = covParamTR_matrix;
0617     optim.hessParamTR_matrix    = hessParamTR_matrix;
0618     optim.hessParamOR_matrix    = hessParamOR_matrix;
0619 <span class="keyword">end</span>
0620 
0621 <span class="comment">%% Write model.parameters in model.param_properties</span>
0622 
0623 <span class="comment">% Add parameter and p_ref to param_properties</span>
0624 parameter=optim.parameter_opt;
0625 [model.param_properties]=<a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>(model.param_properties, <span class="keyword">...</span>
0626     [parameter, p_ref], 9);
0627 
0628 <span class="comment">%--------------------END CODE ------------------------</span>
0629 <span class="keyword">end</span>
0630 
0631 
0632 <a name="_sub1" href="#_subfunctions" class="code">function [covParamTR_matrix, hessParamTR_matrix, hessParamOR_matrix] = </a><span class="keyword">...</span>
0633     LaplaceApproximation(data, model, misc, pTR, pOR, func_gradTR2OR, <span class="keyword">...</span>
0634     search_idx, std_p_TR)
0635 <span class="keyword">if</span> size(model.param_properties,2)&gt;6
0636     <span class="comment">% mean</span>
0637     logpriorMu               = [model.param_properties{:,7}];
0638     <span class="comment">% standard deviation</span>
0639     logpriorSig              = [model.param_properties{:,8}];
0640     <span class="comment">% distribution name</span>
0641     logpriorName             = {model.param_properties{:,6}};
0642     prior_empty = 0;
0643 <span class="keyword">else</span>
0644     prior_empty = 1;
0645 <span class="keyword">end</span>
0646 nb_param                 = length(search_idx);
0647 gradParamTR_matrix       = zeros(nb_param,nb_param);
0648 hessParanTR_prior_matrix = zeros(nb_param,nb_param);
0649 <span class="comment">% stepsize for the numerical hessian</span>
0650 delta_diff               = 1E-6*ones(nb_param,1);
0651 <span class="keyword">for</span> p = 1 : nb_param
0652     idx = search_idx(p);
0653     gradParamTR_matrix(p,p) = func_gradTR2OR{p}(pTR(idx));
0654     <span class="keyword">if</span> prior_empty
0655         hessParanTR_prior_matrix(p,p) = 0;
0656     <span class="keyword">else</span>
0657         [~, ~, hessParanTR_prior_matrix(p,p)]      = <span class="keyword">...</span>
0658             <a href="logPriorDistr.html" class="code" title="function [logprior, Glogprior, Hlogprior]= logPriorDistr(P, Mu, Sigma, varargin)">logPriorDistr</a>(pTR(idx), logpriorMu(idx), logpriorSig(idx), <span class="keyword">...</span>
0659             <span class="string">'distribution'</span>,logpriorName{idx});
0660     <span class="keyword">end</span>
0661     
0662     <span class="keyword">if</span> pOR(idx)&lt;5E-3
0663         delta_diff(p) = 1E-4;
0664     <span class="keyword">end</span>
0665 <span class="keyword">end</span>
0666 
0667 loglikH             = @(p) <a href="#_sub2" class="code" title="subfunction  LL = loglik4hessian (p, data, model, misc, search_idx)">loglik4hessian</a> (p, data, model, misc, search_idx);
0668 
0669 hessParamOR_matrix  =  <a href="numerical_hessian.html" class="code" title="function H=numerical_hessian(x, fX, varargin)">numerical_hessian</a>( pOR(search_idx), loglikH, <span class="keyword">...</span>
0670     <span class="string">'stepSize'</span>,delta_diff);
0671 
0672 hessParamTR_matrix  = gradParamTR_matrix' * hessParamOR_matrix * <span class="keyword">...</span>
0673     gradParamTR_matrix + hessParanTR_prior_matrix;
0674 
0675 <span class="keyword">if</span> ~any(any(isnan(hessParamTR_matrix)))
0676     covParamTR_matrix   = inv(-hessParamTR_matrix);
0677     <span class="keyword">if</span> any(any(diag(covParamTR_matrix&lt;0)))
0678         <span class="keyword">if</span> ~any(any(isnan(std_p_TR(search_idx))))
0679             covParamTR_matrix   = diag(std_p_TR(search_idx).^2);
0680         <span class="keyword">else</span>
0681             fprintf(fileID, [<span class="string">'Warning: the covariance matrix '</span>, <span class="keyword">...</span>
0682                 <span class="string">'cannot be computed.\n'</span>]);
0683             covParamTR_matrix = NaN(nb_param, nb_param);
0684         <span class="keyword">end</span>
0685     <span class="keyword">end</span>
0686 <span class="keyword">end</span>
0687 <span class="keyword">end</span>
0688 
0689 <a name="_sub2" href="#_subfunctions" class="code">function  LL = loglik4hessian (p, data, model, misc, search_idx)</a>
0690 model.parameter(search_idx) = p;
0691 
0692 <span class="comment">% Insert parameter values in param_properties</span>
0693 [model.param_properties]=<span class="keyword">...</span>
0694     <a href="../../../OpenBDLM_V1.0/functions/Others/writeParameterProperties.html" class="code" title="function [cellOut]=writeParameterProperties(cellIn, arrayIn, Position)">writeParameterProperties</a>(model.param_properties, <span class="keyword">...</span>
0695     [p, model.p_ref], 9);
0696 
0697 [~,~,~,~,LL,~,~]            = <a href="../../../OpenBDLM_V1.0/functions/StateEstimation/SwitchingKalmanFilter.html" class="code" title="function [x, V, VV, S, loglik,U,D]=SwitchingKalmanFilter(data, model, misc)">SwitchingKalmanFilter</a>(data,model,misc);
0698 <span class="keyword">end</span>
0699</pre></div>
<hr><address>Generated on Tue 05-Feb-2019 11:23:52 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>