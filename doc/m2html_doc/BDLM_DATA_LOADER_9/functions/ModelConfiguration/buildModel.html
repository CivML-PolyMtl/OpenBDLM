<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of buildModel</title>
  <meta name="keywords" content="buildModel">
  <meta name="description" content="BUILDMODEL Build model (build A,C, Q, R matrices)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">BDLM_DATA_LOADER_9</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">ModelConfiguration</a> &gt; buildModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for BDLM_DATA_LOADER_9/functions/ModelConfiguration&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>buildModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>BUILDMODEL Build model (build A,C, Q, R matrices)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [model]=buildModel(data, model, misc) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">BUILDMODEL Build model (build A,C, Q, R matrices)

   SYNOPSIS:
     [model]=BUILDMODEL(data, model, misc, model)
 
   INPUT:
       data       - structure (required)
                      data must contain three fields :

                           'timestamps' is a 1×N cell array
                           each cell is a M_ix1 real array

                           'values' is a 1×N cell array
                           each cell is a M_ix1 real array

                           'labels' is a 1×N cell array
                           each cell is a character array

                           N: number of time series
                           M_i: number of samples of time series i

      model       - structure (required)

      misc        - structure (required)
 
   OUTPUT:
      model       - structure
 
   DESCRIPTION:
      BUILDMODEL builds model (build A,C,Q,R matrices)
 
   EXAMPLES:
      [model] = BUILDMODEL(data, model, misc)
 
   See also <a href="defineModel.html" class="code" title="function [model]=defineModel(data, misc)">DEFINEMODEL</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="Static_kernel_component.html" class="code" title="function [K_norm]=Static_kernel_component(reg_parameters,timestamp,timestamp_ref,nb_p)">Static_kernel_component</a>	STATIC_KERNEL_COMPONENT Compute normalized kernel coefficients</li><li><a href="defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>	DEFINEREFERENCETIMESTEP computes reference timestep of a timestamp vector</li><li><a href="../../../BDLM_DATA_LOADER_9/functions/Others/hidden_component.html" class="code" title="function interp_hc=hidden_component(reg_parameters,t_idx)">hidden_component</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../BDLM_DATA_LOADER_9/BDLM.html" class="code" title="">BDLM</a>	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</li><li><a href="configureModelForDataReal.html" class="code" title="function [data, model, estimation, misc]=configureModelForDataReal(data, model, estimation , misc)">configureModelForDataReal</a>	CONFIGUREMODELFORDATAREAL configures model for BDLM analysis based on real data</li><li><a href="configureModelForDataSimulation.html" class="code" title="function [data, model, estimation, misc]=configureModelForDataSimulation(data, model, estimation , misc)">configureModelForDataSimulation</a>	CONFIGUREMODELFORDATASIMULATION configures model for BDLM analysis based on simulated data</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [model]=buildModel(data, model, misc)</a>
0002 <span class="comment">%BUILDMODEL Build model (build A,C, Q, R matrices)</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   SYNOPSIS:</span>
0005 <span class="comment">%     [model]=BUILDMODEL(data, model, misc, model)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   INPUT:</span>
0008 <span class="comment">%       data       - structure (required)</span>
0009 <span class="comment">%                      data must contain three fields :</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%                           'timestamps' is a 1×N cell array</span>
0012 <span class="comment">%                           each cell is a M_ix1 real array</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%                           'values' is a 1×N cell array</span>
0015 <span class="comment">%                           each cell is a M_ix1 real array</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%                           'labels' is a 1×N cell array</span>
0018 <span class="comment">%                           each cell is a character array</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%                           N: number of time series</span>
0021 <span class="comment">%                           M_i: number of samples of time series i</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%      model       - structure (required)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%      misc        - structure (required)</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%   OUTPUT:</span>
0028 <span class="comment">%      model       - structure</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%   DESCRIPTION:</span>
0031 <span class="comment">%      BUILDMODEL builds model (build A,C,Q,R matrices)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%   EXAMPLES:</span>
0034 <span class="comment">%      [model] = BUILDMODEL(data, model, misc)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   See also DEFINEMODEL</span>
0037  
0038 <span class="comment">%   AUTHORS:</span>
0039 <span class="comment">%      James-A Goulet, Luong Ha Nguyen, Ianis Gaudot</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%      Email: &lt;james.goulet@polymtl.ca&gt;</span>
0042 <span class="comment">%      Website: &lt;http://www.polymtl.ca/expertises/goulet-james-alexandre&gt;</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%   MATLAB VERSION:</span>
0045 <span class="comment">%      Tested on 9.1.0.441655 (R2016b)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%   DATE CREATED:</span>
0048 <span class="comment">%       April 23, 2018</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%   DATE LAST UPDATE:</span>
0051 <span class="comment">%       June 1, 2018</span>
0052  
0053 <span class="comment">%--------------------BEGIN CODE ----------------------</span>
0054 
0055 <span class="comment">%% Get arguments passed to the function and proceed to some verifications</span>
0056 p = inputParser;
0057 
0058 addRequired(p,<span class="string">'data'</span>, @isstruct );
0059 addRequired(p,<span class="string">'model'</span>, @isstruct );
0060 addRequired(p,<span class="string">'misc'</span>, @isstruct );
0061 parse(p,data, model, misc);
0062 
0063 data=p.Results.data;
0064 model=p.Results.model;
0065 misc=p.Results.misc;
0066 
0067 <span class="comment">%% Get reference time step</span>
0068 <span class="comment">%% Compute reference time step from timestamp vector</span>
0069 timestamps = data.timestamps{1};
0070 [dt_ref] = <a href="defineReferenceTimeStep.html" class="code" title="function [ReferenceTimestep]=defineReferenceTimeStep(timestamps)">defineReferenceTimeStep</a>(timestamps);
0071 misc.dt_ref = dt_ref;
0072 
0073 <span class="comment">%% Get number of time series</span>
0074 numberOfTimeSeries = length(data.labels);
0075 
0076 <span class="comment">%% Get number of model class</span>
0077 numberOfModelClass = size(model.components.block,2);
0078 model.nb_class = size(model.components.block,2);
0079 
0080 <span class="comment">%% Block Component definition</span>
0081 
0082 <span class="comment">%#11 Local level</span>
0083 model.components.idx{11}=<span class="string">'LL'</span>;
0084 LL.A=@(p,t,dt) 1;
0085 LL.pA=[];
0086 LL.pA0=[];
0087 LL.C=@(p,t,dt) 1;
0088 LL.pC=[];
0089 LL.pC0=[];
0090 LL.I=@(p,t,dt) 0;
0091 LL.pI=[];
0092 LL.pI0=[];
0093 LL.Q=@(p,t,dt) p^2*dt';
0094 LL.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LL'</span>,[],[],[nan,nan]};
0095 LL.x={<span class="string">'x^{LL}'</span>,[],[]};
0096 <span class="keyword">if</span> misc.isDataSimulation
0097     LL.pQ0={<span class="string">'0'</span>};
0098     LL.init={<span class="string">'10'</span>,<span class="string">'0.1^2'</span>};
0099 <span class="keyword">else</span>
0100     LL.pQ0={<span class="string">'0*nanstd(data.values{obs})'</span>};
0101     LL.init={<span class="string">'nanmean(data.values{obs})'</span>,<span class="string">'(2*nanstd(data.values{obs}))^2'</span>};
0102 <span class="keyword">end</span>
0103 
0104 <span class="comment">%#12 Local trend</span>
0105 model.components.idx{12}=<span class="string">'LT'</span>;
0106 LT.A=@(p,t,dt) [1 dt;0 1];
0107 LT.pA=[];
0108 LT.pA0=[];
0109 LT.C=@(p,t,dt) [1 0];
0110 LT.pC=[];
0111 LT.pC0=[];
0112 LT.I=@(p,t,dt) [0 0];
0113 LT.pI=[];
0114 LT.pI0=[];
0115 LT.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^3/3 dt^2/2;dt^2/2 dt];
0116 LT.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LT'</span>,[],[],[0,inf]};
0117 LT.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LT}'</span>,[],[]};
0118 <span class="keyword">if</span> misc.isDataSimulation 
0119     LT.pQ0={<span class="string">'1E-7'</span>};
0120     LT.init={<span class="string">'[10 -0.1]'</span>,<span class="string">'[0.1^2 0.1^2]'</span>};
0121 <span class="keyword">else</span>
0122     LT.pQ0={<span class="string">'1E-7*nanstd(data.values{obs})'</span>};
0123     LT.init={<span class="string">'[nanmean(data.values{obs}) 0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2]'</span>};
0124 <span class="keyword">end</span>
0125 
0126 
0127 
0128 <span class="comment">%#13 Local acceleration</span>
0129 model.components.idx{13}=<span class="string">'LA'</span>;
0130 LA.A=@(p,t,dt)[1 dt dt^2;0 1 dt;0 0 1];
0131 LA.pA=[];
0132 LA.pA0=[];
0133 LA.C=@(p,t,dt)[1 0 0];
0134 LA.pC=[];
0135 LA.pC0=[];
0136 LA.I=@(p,t,dt) [0 0 0];
0137 LA.pI=[];
0138 LA.pI0=[];
0139 LA.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^5/20 dt^4/8 dt^3/6;dt^4/8 dt^3/3 dt^2/2;dt^3/6 dt^2/2 dt];
0140 LA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LA'</span>,[],[],[0,inf]};
0141 LA.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LT}'</span>,[],[];<span class="string">'x^{LA}'</span>,[],[]};
0142 <span class="keyword">if</span> misc.isDataSimulation 
0143     LA.pQ0={<span class="string">'1E-8'</span>};
0144     LA.init={<span class="string">'[10 0 0]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0145 <span class="keyword">else</span>
0146     LA.pQ0={<span class="string">'1E-8*nanstd(data.values{obs})'</span>};
0147     LA.init={<span class="string">'[nanmean(data.values{obs}) 0 0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2]'</span>};
0148 <span class="keyword">end</span>
0149 
0150 
0151 
0152 <span class="comment">%#21 Local level compatible with LT</span>
0153 model.components.idx{21}=<span class="string">'LcT'</span>;
0154 LcT.A=@(p,t,dt) [1 0;0 0];
0155 LcT.pA=[];
0156 LcT.pA0=[];
0157 LcT.C=@(p,t,dt) [1 0];
0158 LcT.pC=[];
0159 LcT.pC0=[];
0160 LcT.I=@(p,t,dt) [0 0];
0161 LcT.pI=[];
0162 LcT.pI0=[];
0163 LcT.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0;0 1E-15/(p^2*dt/dt_ref)];
0164 LcT.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LcT'</span>,[],[],[0,inf]};
0165 LcT.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LTc}'</span>,[],[]};
0166 <span class="keyword">if</span> misc.isDataSimulation 
0167     LcT.pQ0={<span class="string">'1E-7'</span>};
0168     LcT.init={<span class="string">'[10 0]'</span>,<span class="string">'[0.1^2 (1E-6)^2]'</span>};
0169 <span class="keyword">else</span>
0170     LcT.pQ0={<span class="string">'1E-7*nanstd(data.values{obs})'</span>};
0171     LcT.init={<span class="string">'[nanmean(data.values{obs}) 0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2 (1E-6*nanstd(data.values{obs}))^2]'</span>};
0172 <span class="keyword">end</span>
0173 
0174 <span class="comment">%#22 Local level compatible with LA</span>
0175 <span class="comment">%model.components.idx{22}='LA';</span>
0176 model.components.idx{22}=<span class="string">'LcA'</span>;
0177 LcA.A=@(p,t,dt) [1 0 0;0 0 0; 0 0 0]';
0178 LcA.pA=[];
0179 LcA.pA0=[];
0180 LcA.C=@(p,t,dt) [1 0 0];
0181 LcA.pC0=[];
0182 LcA.pC=[];
0183 LcA.I=@(p,t,dt) [0 0 0];
0184 LcA.pI=[];
0185 LcA.pA0=[];
0186 LcA.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0 0;0 0 0; 0 0 1E-15/(p^2*dt/dt_ref)];
0187 LcA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'LcA'</span>,[],[],[0,inf]};
0188 LcA.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LTc}'</span>,[],[];<span class="string">'x^{LAc}'</span>,[],[]};
0189 <span class="keyword">if</span> misc.isDataSimulation
0190     LcA.pQ0={<span class="string">'1E-7'</span>};
0191     LcA.init={<span class="string">'[10 -0.1 0]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0192 <span class="keyword">else</span>
0193     LcA.pQ0={<span class="string">'1E-7*nanstd(data.values{obs})'</span>};
0194     LcA.init={<span class="string">'[nanmean(data.values{obs} 0 0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2]'</span>};
0195 <span class="keyword">end</span>
0196 
0197 
0198 <span class="comment">%#23 Local trend compatible with LA</span>
0199 model.components.idx{23}=<span class="string">'TcA'</span>;
0200 TcA.A=@(p,t,dt) [1 dt 0;0 1 0; 0 0 0];
0201 TcA.pA=[];
0202 TcA.pA0=[];
0203 TcA.C=@(p,t,dt) [1 0 0];
0204 TcA.pC=[];
0205 TcA.pC0=[];
0206 TcA.I=@(p,t,dt) [0 0 0];
0207 TcA.pI=[];
0208 TcA.pC0=[];
0209 TcA.Q=@(p,t,dt) p^2*dt/dt_ref*[dt^3/3 dt^2/2 0;dt^2/2 dt 0; 0 0 1E-15/(p^2*dt/dt_ref)];
0210 TcA.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'TcA'</span>,[],[],[0,inf]};
0211 TcA.x={<span class="string">'x^{LL}'</span>,[],[];<span class="string">'x^{LT}'</span>,[],[];<span class="string">'x^{LAc}'</span>,[],[]};
0212 <span class="keyword">if</span> misc.isDataSimulation 
0213     TcA.pQ0={<span class="string">'1E-8'</span>};
0214     TcA.init={<span class="string">'[10 -0.1 0]'</span>,<span class="string">'[0.1^2 0.1^2 0.1^2]'</span>};
0215 <span class="keyword">else</span>
0216     TcA.pQ0={<span class="string">'1E-8*nanstd(data.values{obs})'</span>};
0217     TcA.init={<span class="string">'[nanmean(data.values{obs}) 0 0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2 (nanstd(data.values{obs}))^2]'</span>};
0218 <span class="keyword">end</span>
0219 
0220 
0221 <span class="comment">%#31 Periodic component</span>
0222 model.components.idx{31}=<span class="string">'PD'</span>;
0223 PD.A=@(p,t,dt) [cos(2*pi*dt/p(1)) sin(2*pi*dt/p(1));-sin(2*pi*dt/p(1)) cos(2*pi*dt/p(1))];
0224 PD.pA={<span class="string">'p'</span>,<span class="string">'PD'</span>,[],[nan,nan]};
0225 PD.pA0={<span class="string">'365.2422'</span>,<span class="string">'1'</span>,<span class="string">'365.2422/2'</span>,<span class="string">'7'</span>};
0226 PD.C=@(p,t,dt) [1 0];
0227 PD.pC=[];
0228 PD.pC0=[];
0229 PD.I=@(p,t,dt) [p 0];
0230 PD.pI={<span class="string">'\phi'</span>,<span class="string">'PD,I'</span>,[],[],[-inf,inf]};
0231 PD.pI0={<span class="string">'0.5'</span>};
0232 PD.Q=@(p,t,dt) p^2*dt/dt_ref*[1 0;0 1];
0233 PD.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'PD'</span>,[],[],[nan,nan]};
0234 PD.x={<span class="string">'x^{S1}'</span>,[],[];<span class="string">'x^{S2}'</span>,[],[]};
0235 <span class="keyword">if</span> misc.isDataSimulation 
0236     PD.pQ0={<span class="string">'0'</span>};
0237     PD.init={<span class="string">'[10,10]'</span>,<span class="string">'[(2*0.1)^2,(2*0.1)^2]'</span>};
0238 <span class="keyword">else</span>
0239     PD.pQ0={<span class="string">'0*nanstd(data.values{obs})'</span>};
0240     PD.init={<span class="string">'[5,0]'</span>,<span class="string">'[(2*nanstd(data.values{obs}))^2,(2*nanstd(data.values{obs}))^2]'</span>};
0241 <span class="keyword">end</span>
0242 
0243 <span class="comment">%#41 Autoregressive component</span>
0244 model.components.idx{41}=<span class="string">'AR'</span>;
0245 AR.A=@(p,t,dt) p(1)^(dt/dt_ref);
0246 AR.pA={<span class="string">'\phi'</span>,<span class="string">'AR'</span>,[],[],[0,1]};
0247 AR.pA0={<span class="string">'0.75'</span>};
0248 AR.C=@(p,t,dt) 1;
0249 AR.pC=[];
0250 AR.pC0=[];
0251 AR.I=@(p,t,dt) p;
0252 AR.pI={<span class="string">'\phi'</span>,<span class="string">'AR,I'</span>,[],[],[-inf,inf]};
0253 AR.pI0={<span class="string">'0.5'</span>};
0254 AR.Q=@(p,t,dt) p^2*dt/dt_ref;
0255 AR.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'AR'</span>,[],[],[0,inf]};
0256 AR.x={<span class="string">'x^{AR}'</span>,[],[]};
0257 <span class="keyword">if</span> misc.isDataSimulation 
0258     AR.pQ0={<span class="string">'1E-1*0.1'</span>};
0259     AR.init={<span class="string">'0'</span>,<span class="string">'0.1^2'</span>};
0260 <span class="keyword">else</span>
0261     AR.pQ0={<span class="string">'1E-1*nanstd(data.values{obs})'</span>};
0262     AR.init={<span class="string">'0'</span>,<span class="string">'(nanstd(data.values{obs}))^2'</span>};
0263 <span class="keyword">end</span>
0264 
0265 <span class="comment">%#51 Dynamic regression with hidden component</span>
0266 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'nb_DH_p'</span>)
0267     model.components.nb_DH_p=5;
0268 <span class="keyword">end</span>
0269 model.components.idx{51}=<span class="string">'DH'</span>;
0270 DH.A=@(p,t,dt) 1;
0271 DH.pA=[];
0272 DH.pA0=[];
0273 DH.C=@(p,t,dt) <a href="../../../BDLM_DATA_LOADER_9/functions/Others/hidden_component.html" class="code" title="function interp_hc=hidden_component(reg_parameters,t_idx)">hidden_component</a>(p,t);
0274 DH.pC=[];
0275 DH.pC0=[{<span class="string">'0.013'</span>}, {<span class="string">'0.082'</span>}, {<span class="string">'0.34'</span>}, {<span class="string">'0.67'</span>}, {<span class="string">'0.90'</span>} ];
0276 <span class="keyword">for</span> i=1:model.components.nb_DH_p
0277     DH.pC=[DH.pC;{[<span class="string">'ycp'</span> num2str(i)],<span class="string">'DH'</span> ,[],[],[0,1]}];
0278     <span class="comment">%DH.pC0=[DH.pC0,{'0.5'}];</span>
0279 <span class="keyword">end</span>
0280 
0281 DH.pC=[DH.pC;{[<span class="string">'x_0'</span> num2str(i)],<span class="string">'DH'</span> ,[],[],[0,inf]};{[<span class="string">'d_x'</span> num2str(i)],<span class="string">'DH'</span> ,[],[],[nan,nan]}];
0282 DH.pC0=[DH.pC0,{num2str(datenum(<span class="string">'2017-1-1 00:00'</span>))},{num2str(365.2224)}];
0283 clear i
0284 DH.I=@(p,t,dt) p;
0285 DH.pI={<span class="string">'\phi'</span>,<span class="string">'DH,I'</span>,[],[],[-inf,inf]};
0286 DH.pI0={<span class="string">'0.01'</span>};
0287 DH.Q=@(p,t,dt) p^2*dt/dt_ref;
0288 DH.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'DH'</span>,[],[],[nan,nan]};
0289 DH.x={<span class="string">'x^{DH}'</span>,[],[]};
0290 <span class="keyword">if</span> misc.isDataSimulation
0291     DH.pQ0={<span class="string">'0'</span>};
0292     DH.init={<span class="string">'1'</span>,<span class="string">'0.1^2'</span>};
0293 <span class="keyword">else</span>
0294     DH.pQ0={<span class="string">'0'</span>};
0295     DH.init={<span class="string">'0'</span>,<span class="string">'(nanstd(data.values{obs}))^2'</span>};
0296 <span class="keyword">end</span>
0297 
0298 
0299 <span class="comment">%#52 Static Kernel Regression</span>
0300 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'nb_SK_p'</span>)
0301     model.components.nb_SK_p=50;
0302 <span class="keyword">end</span>
0303 model.components.idx{52}=<span class="string">'SK'</span>;
0304 SK.A=@(p,t,dt) eye(model.components.nb_SK_p);
0305 SK.pA=[];
0306 SK.pA0=[];
0307 SK.C=@(p,t,dt) [<a href="Static_kernel_component.html" class="code" title="function [K_norm]=Static_kernel_component(reg_parameters,timestamp,timestamp_ref,nb_p)">Static_kernel_component</a>(p,t,timestamps(1),model.components.nb_SK_p)];
0308 SK.pC=[{<span class="string">'\ell'</span>,<span class="string">'SK'</span>,[],[],[0,inf]};{<span class="string">'p'</span>,<span class="string">'SK'</span>,[],[],[nan,nan]}];
0309 SK.pC0=[{<span class="string">'0.5'</span>};{<span class="string">'365.2422'</span>}];
0310 SK.I=@(p,t,dt) p;
0311 SK.pI={<span class="string">'\phi'</span>,<span class="string">'SK,I'</span>,[],[],[-inf,inf]};
0312 SK.pI0={<span class="string">'0.01'</span>};
0313 SK.Q=@(p,t,dt) eye(model.components.nb_SK_p)*p^2*dt/dt_ref;
0314 SK.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'SK'</span>,[],[],[nan,nan]};
0315 SK.x=[];
0316 <span class="keyword">for</span> i=1:model.components.nb_SK_p
0317     SK.x=[SK.x;{[<span class="string">'x^{SK'</span> num2str(i) <span class="string">'}'</span>],[],[]}];
0318 <span class="keyword">end</span>
0319 clear i
0320 <span class="keyword">if</span> misc.isDataSimulation 
0321     t = linspace(1,2*pi, model.components.nb_SK_p);
0322     a=sin(t);
0323     b=sin(4*t+30);
0324     c = sin(8*t-45);
0325     summ=a+b+c;
0326     summ_trun = summ(1:model.components.nb_SK_p);
0327     
0328     SK.pQ0={<span class="string">'0'</span>};
0329     SK.init={[<span class="string">'['</span> sprintf(<span class="string">'%f '</span>, summ_trun) <span class="string">']'</span>],[<span class="string">'['</span> repmat(<span class="string">'0.01 '</span>,[1,model.components.nb_SK_p]) <span class="string">']'</span>]};    
0330 <span class="keyword">else</span>
0331     SK.pQ0={<span class="string">'0'</span>};
0332     SK.init={[<span class="string">'['</span> repmat(<span class="string">'0 '</span>,[1,model.components.nb_SK_p]) <span class="string">']'</span>],[<span class="string">'['</span> repmat(<span class="string">'(nanstd(data.values{obs}))^2 '</span>,[1,model.components.nb_SK_p]) <span class="string">']'</span>]};
0333 <span class="keyword">end</span>
0334 
0335 <span class="comment">%#53 Dynamic Kernel Regression</span>
0336 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'nb_DK_p'</span>)
0337     model.components.nb_DK_p=50+1;
0338 <span class="keyword">end</span>
0339 model.components.idx{53}=<span class="string">'DK'</span>;
0340 DK.A=@(p,t,dt) [[1 <a href="Static_kernel_component.html" class="code" title="function [K_norm]=Static_kernel_component(reg_parameters,timestamp,timestamp_ref,nb_p)">Static_kernel_component</a>(p,t,timestamps(1),model.components.nb_DK_p-1)];zeros(model.components.nb_DK_p-1,1) eye(model.components.nb_DK_p-1)];
0341 DK.pA=[{<span class="string">'\ell'</span>,<span class="string">'DK'</span>,[],[],[0,inf]};{<span class="string">'p'</span>,<span class="string">'DK'</span>,[],[],[nan,nan]}];
0342 DK.pA0=[{<span class="string">'0.5'</span>};{<span class="string">'365.2422'</span>}];
0343 DK.C=@(p,t,dt) [1 zeros(1,model.components.nb_DK_p-1)];
0344 DK.pC=[];
0345 DK.pC0=[];
0346 DK.I=@(p,t,dt) p;
0347 DK.pI={<span class="string">'\phi'</span>,<span class="string">'DK,I'</span>,[],[],[-inf,inf]};
0348 DK.pI0={<span class="string">'0.01'</span>};
0349 DK.Q=@(p,t,dt) blkdiag(0,eye(model.components.nb_DK_p-1)*p^2*dt/dt_ref);
0350 DK.pQ={<span class="string">'\sigma_w'</span>,<span class="string">'DK'</span>,[],[],[nan,nan]};
0351 DK.x=[];
0352 <span class="keyword">for</span> i=1:model.components.nb_DK_p
0353     DK.x=[DK.x;{[<span class="string">'x^{DK'</span> num2str(i) <span class="string">'}'</span>],[],[]}];
0354 <span class="keyword">end</span>
0355 clear i
0356 <span class="keyword">if</span> misc.isDataSimulation 
0357     t = linspace(1,2*pi, model.components.nb_DK_p);
0358     a=sin(t);
0359     b=sin(4*t+30);
0360     c = sin(8*t-45);
0361     summ=a+b+c;
0362     summ_trun = summ(1:model.components.nb_DK_p);
0363     
0364     DK.pQ0={<span class="string">'0.1^2'</span>};
0365     DK.init={[<span class="string">'['</span> sprintf(<span class="string">'%f '</span>, summ_trun) <span class="string">']'</span>],[<span class="string">'['</span> repmat(<span class="string">'0.01 '</span>,[1,model.components.nb_DK_p]) <span class="string">']'</span>]};
0366 <span class="keyword">else</span>
0367     
0368     DK.pQ0={<span class="string">'(nanstd(data.values{obs}))^2 '</span>};
0369     DK.init={[<span class="string">'['</span> repmat(<span class="string">'0 '</span>,[1,model.components.nb_DK_p]) <span class="string">']'</span>],[<span class="string">'['</span> repmat(<span class="string">'(nanstd(data.values{obs}))^2 '</span>,[1,model.components.nb_DK_p]) <span class="string">']'</span>]};
0370 <span class="keyword">end</span>
0371 
0372 <span class="comment">%% Block initialization</span>
0373 param_properties={};        <span class="comment">%Reference vector for parameter names in A,C,Q,R matrices</span>
0374 param_idx=1;                <span class="comment">%Index for parameter count in A,C,Q,R matrices</span>
0375 x_count=zeros(numberOfTimeSeries,100);
0376 parameter=[];               <span class="comment">%Default values for parameters</span>
0377 nb_param_class=1;           <span class="comment">%number of parameter per model class</span>
0378 <span class="keyword">for</span> class_from=1:numberOfModelClass  <span class="comment">%Loop over each model class</span>
0379     h_count=0;                   <span class="comment">%Count of the number of periodic component</span>
0380     A{class_from}=[];            <span class="comment">%Matrices initialization</span>
0381     R{class_from}=[];
0382     initX{class_from}=[];        <span class="comment">%Initial state variable expected value</span>
0383     initV{class_from}=[];        <span class="comment">%Initial state variable variance</span>
0384     hidden_states_names{class_from}={};     <span class="comment">%Reference vector for hidden state variables names</span>
0385     <span class="keyword">for</span> class_to=1:numberOfModelClass<span class="comment">%Loop over each model class</span>
0386         Q{class_from}{class_to}=[];
0387         CI_block=cell(numberOfTimeSeries);
0388         <span class="keyword">for</span> obs=1:numberOfTimeSeries   <span class="comment">%Loop over each observation</span>
0389             p_count=0;                   <span class="comment">%Count of the number of periodic component</span>
0390             nb_hidden_states{class_from}{obs}=0;
0391             C{class_from}{obs,obs}=[];
0392             C_block=[];
0393             <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0394                 block_idx=model.components.block{class_from}{obs}(block);
0395                 block_name=model.components.idx{block_idx};
0396                 <span class="keyword">if</span> class_from==class_to
0397                     x_count(obs,block_idx)=x_count(obs,block_idx)+1;    <span class="comment">%count the number of components</span>
0398                     <span class="keyword">if</span> x_count(obs,block_idx)&gt;1
0399                         count_label=num2str(x_count(obs,block_idx));
0400                     <span class="keyword">else</span>
0401                         count_label=num2str([]);
0402                     <span class="keyword">end</span>
0403                     name=eval([block_name <span class="string">'.x'</span>]);
0404                     <span class="keyword">for</span> i=1:size(name,1)
0405                         name{i,2}=num2str(class_from);
0406                         name{i,3}=data.labels{obs};
0407                         hidden_states_names{class_from}=[hidden_states_names{class_from};name(i,:)];
0408                     <span class="keyword">end</span>
0409                     <span class="comment">% initial hidden state values</span>
0410                     initX{class_from}=[initX{class_from},eval(eval([block_name <span class="string">'.init{1}'</span>]))];
0411                     initV{class_from}=[initV{class_from},eval(eval([block_name <span class="string">'.init{2}'</span>]))];
0412                     
0413                     <span class="comment">% A - Transition matrix</span>
0414                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0415                         A{class_from}=[A{class_from},<span class="string">','</span>,[block_name <span class="string">'.A(p(['</span> num2str(A_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0416                     <span class="keyword">else</span>
0417                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pA,1)'</span>]);
0418                         <span class="keyword">if</span> nb_param&gt;0
0419                             p_idx=param_idx:param_idx-1+nb_param;
0420                         <span class="keyword">else</span>
0421                             p_idx=[];
0422                         <span class="keyword">end</span>
0423                         A{class_from}=[A{class_from},<span class="string">','</span>,[block_name <span class="string">'.A(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0424                         <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pA'</span>]),<span class="string">'p'</span>))
0425                             p_count=p_count+1;
0426                             name={<span class="string">'p'</span> ,[<span class="string">'PD'</span> num2str(p_count)],[],[],eval([block_name <span class="string">'.pA{4}'</span>])};
0427                             p_value=eval([block_name <span class="string">'.pA0{'</span> num2str(p_count) <span class="string">'}'</span>]);
0428                             <span class="keyword">if</span> ~isempty(p_value)
0429                                 parameter=[parameter;eval(p_value)];
0430                             <span class="keyword">end</span>
0431                         <span class="keyword">elseif</span> strcmp(block_name,<span class="string">'DK'</span>)
0432                             name=eval([block_name <span class="string">'.pA'</span>]);
0433                             k_count=0;
0434                             <span class="keyword">for</span> i=1:2
0435                                 k_count=k_count+1;
0436                                 p_value=eval([block_name <span class="string">'.pA0{'</span> num2str(k_count) <span class="string">'}'</span>]);
0437                                 parameter=[parameter;eval(p_value)];
0438                                 name{i,3}=[num2str(class_from)];
0439                                 name{i,4}=data.labels{obs};
0440                             <span class="keyword">end</span>
0441                         <span class="keyword">else</span>
0442                             name=eval([block_name <span class="string">'.pA'</span>]);
0443                             p_value=eval([block_name <span class="string">'.pA0'</span>]);
0444                             <span class="keyword">if</span> ~isempty(p_value)
0445                                 parameter=[parameter;eval(p_value{:})];
0446                             <span class="keyword">end</span>
0447                         <span class="keyword">end</span>
0448                         <span class="keyword">if</span> ~isempty(name)&amp;&amp;~strcmp(block_name,<span class="string">'DK'</span>)
0449                             name{3}=[num2str(class_from)];
0450                             name{4}=data.labels{obs};
0451                         <span class="keyword">end</span>
0452                         param_properties=[param_properties;name];
0453                         A_param_ref{class_from}{obs}{block}=p_idx;
0454                         param_idx=param_idx+nb_param;
0455                     <span class="keyword">end</span>
0456                     
0457                     <span class="comment">% Q - Model transition error covariance</span>
0458                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0459                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(Q_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0460                         Q_param_ref{class_from}{obs}{block}=Q_param_ref{1}{obs}{block};
0461                     <span class="keyword">else</span>
0462                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pQ,1)'</span>]);
0463                         <span class="keyword">if</span> nb_param&gt;0
0464                             p_idx=param_idx:param_idx-1+nb_param;
0465                         <span class="keyword">else</span>
0466                             p_idx=[];
0467                         <span class="keyword">end</span>
0468                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0469                         <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pA'</span>]),<span class="string">'p'</span>))
0470                             name={<span class="string">'\sigma_w'</span>,[<span class="string">'PD'</span> num2str(p_count)],[],[],eval([block_name <span class="string">'.pQ{5}'</span>])};
0471                         <span class="keyword">else</span>
0472                             name=eval([block_name <span class="string">'.pQ'</span>]);
0473                         <span class="keyword">end</span>
0474                         <span class="keyword">if</span> ~isempty(name)
0475                             p_value=eval(eval([block_name <span class="string">'.pQ0{:}'</span>]));
0476                             parameter=[parameter;p_value];
0477                             name{3}=[num2str(class_from)];
0478                             name{4}=data.labels{obs};
0479                         <span class="keyword">end</span>
0480                         param_properties=[param_properties;name];
0481                         Q_param_ref{class_from}{obs}{block}=p_idx;
0482                         param_idx=param_idx+nb_param;
0483                     <span class="keyword">end</span>
0484                     
0485                     <span class="comment">% C - Observation matrix</span>
0486                     <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0487                         C_block=[C_block,<span class="string">','</span>,[block_name <span class="string">'.C(p(['</span> num2str(C_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0488                     <span class="keyword">else</span>
0489                         nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pC,1)'</span>]);
0490                         <span class="keyword">if</span> nb_param&gt;0
0491                             p_idx=param_idx:param_idx-1+nb_param;
0492                         <span class="keyword">else</span>
0493                             p_idx=[];
0494                         <span class="keyword">end</span>
0495                         C_block=[C_block,<span class="string">','</span>,[block_name <span class="string">'.C(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0496                         name=eval([block_name <span class="string">'.pC'</span>]);
0497                         <span class="keyword">if</span> ~isempty(name)
0498                             <span class="keyword">if</span> any(strcmp(eval([block_name <span class="string">'.pC{1,1}'</span>]),<span class="string">'ycp1'</span>))
0499                                 <span class="keyword">for</span> i=1:size(eval([block_name <span class="string">'.pC'</span>]),1)
0500                                     h_count=h_count+1;
0501                                     p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(h_count) <span class="string">'}'</span>]);
0502                                     parameter=[parameter;eval(p_value)];
0503                                     name{i,3}=[num2str(class_from)];
0504                                     name{i,4}=data.labels{obs};
0505                                 <span class="keyword">end</span>
0506                             <span class="keyword">elseif</span> any(strcmp(eval([block_name <span class="string">'.pC{1,1}'</span>]),<span class="string">'\ell'</span>))
0507                                 C_block_K=[block_name <span class="string">'.C(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>];
0508                                 k_count=0;
0509                                 <span class="keyword">for</span> i=1:2
0510                                     k_count=k_count+1;
0511                                     p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(k_count) <span class="string">'}'</span>]);
0512                                     parameter=[parameter;eval(p_value)];
0513                                     name{i,3}=[num2str(class_from)];
0514                                     name{i,4}=data.labels{obs};
0515                                 <span class="keyword">end</span>
0516                             <span class="keyword">else</span>
0517                                 p_value=eval([block_name <span class="string">'.pC0{'</span> num2str(p_count) <span class="string">'}'</span>]);
0518                                 parameter=[parameter;eval(h_value)];
0519                                 name{3}=[num2str(class_from)];
0520                                 name{4}=data.labels{obs};
0521                             <span class="keyword">end</span>
0522                         <span class="keyword">end</span>
0523                         param_properties=[param_properties;name];
0524                         C_param_ref{class_from}{obs}{block}=p_idx;
0525                         param_idx=param_idx+nb_param;
0526                     <span class="keyword">end</span>
0527                     nb_hidden_states{class_from}{obs}=nb_hidden_states{class_from}{obs}+length(eval([block_name <span class="string">'.A(ones(1,1000),1,1)'</span>]));
0528                 <span class="keyword">end</span>
0529             <span class="keyword">end</span>
0530             <span class="keyword">if</span> class_from==class_to
0531                 
0532                 R{class_from}=[R{class_from},<span class="string">',p(['</span> num2str(param_idx) <span class="string">'])^2'</span>];
0533                 C{class_from}{obs,obs}=[C{class_from}{obs,obs},<span class="string">',['</span> C_block(2:end) <span class="string">']'</span>];
0534                 param_properties=[param_properties;{[<span class="string">'\sigma_v'</span>],[],[num2str(class_from)],[data.labels{obs}],[0,inf]}];
0535                                 
0536                <span class="keyword">if</span> misc.isDataSimulation 
0537                    parameter=[parameter;0.01];            
0538                <span class="keyword">else</span>
0539                    parameter=[parameter;0.05*nanstd(data.values{obs})];
0540                <span class="keyword">end</span>
0541                 param_idx=param_idx+1;
0542                 
0543                 <span class="comment">% PCA inter-component regression</span>
0544                 <span class="keyword">if</span> isfield(model.components,<span class="string">'PCA'</span>)
0545                     <span class="comment">%PCA_coeff=model.components.PCA{obs};</span>
0546                     <span class="keyword">for</span> pca_idx=1:length(model.components.ic{obs})
0547                         PCA_reg_param{obs}(pca_idx)=param_idx;
0548                         param_properties=[param_properties;{[<span class="string">'\phi'</span>],[ data.labels{obs}(1) <span class="string">'|'</span> <span class="string">'PC'</span> num2str(pca_idx) ],[num2str(class_from)],[data.labels{obs}],[-inf,inf]}];
0549                         parameter=[parameter;1];
0550                         param_idx=param_idx+1;
0551                     <span class="keyword">end</span>
0552                     
0553                 <span class="keyword">end</span>
0554                 
0555                 <span class="comment">% I - Inter-component regression</span>
0556                 <span class="keyword">for</span> obs_idx=1:numberOfTimeSeries
0557                     
0558                      <span class="keyword">if</span> obs_idx ~= obs
0559                          C{class_from}{obs_idx,obs} = [];
0560                      <span class="keyword">end</span>
0561                     
0562                     ic_idx=find([model.components.ic{obs_idx}]==obs);
0563                     <span class="keyword">if</span> ~isempty(ic_idx)
0564                         <span class="comment">%param_reg=0;</span>
0565                         <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0566                             block_idx=model.components.block{class_from}{obs}(block);
0567                             block_name=model.components.idx{block_idx};
0568                             nb_param=eval([<span class="string">'size('</span> block_name <span class="string">'.pI,1)'</span>]);
0569                             <span class="keyword">if</span> nb_param&gt;0
0570                                 <span class="comment">%if param_reg==0</span>
0571                                 p_idx=param_idx:param_idx-1+nb_param;
0572                                 param_reg=p_idx;
0573                                 param_properties=[param_properties;{<span class="string">'\phi'</span>, [data.labels{obs_idx}(1) <span class="string">'|'</span> data.labels{obs}(1) <span class="string">'('</span> block_name <span class="string">')'</span> ],[num2str(class_from)],[data.labels{obs}],[-inf,inf]}];
0574                                 parameter=[parameter;eval(eval([block_name <span class="string">'.pI0{:}'</span>]))];
0575                                 param_idx=param_idx+1;
0576                                 <span class="comment">%else</span>
0577                                 <span class="comment">%    p_idx=param_reg;</span>
0578                                 <span class="comment">%end</span>
0579                             <span class="keyword">else</span>
0580                                 p_idx=[];
0581                             <span class="keyword">end</span>
0582                             
0583                             <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0584                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">','</span>,[block_name <span class="string">'.I(p(['</span> num2str(IC_param_ref{1}{obs}{block}) <span class="string">']),t,dt)'</span>]];
0585                             <span class="keyword">else</span>
0586                                 
0587                                 <span class="keyword">if</span> block_idx==52||block_idx==53
0588                                     C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">','</span>,[block_name <span class="string">'.I(p(['</span> num2str(p_idx) <span class="string">']),t,dt)*'</span> C_block_K]];
0589                                 <span class="keyword">else</span>
0590                                 
0591                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">','</span>,[block_name <span class="string">'.I(p(['</span> num2str(p_idx) <span class="string">']),t,dt)'</span>]];
0592                                 
0593                                 <span class="keyword">end</span>
0594                             <span class="keyword">end</span>
0595                             <span class="keyword">if</span> isfield(model.components,<span class="string">'PCA'</span>)
0596                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},<span class="string">'*'</span>,<span class="string">'sum(p(['</span> num2str(PCA_reg_param{obs_idx}) <span class="string">']).*model.components.PCA{'</span> num2str(obs_idx) <span class="string">'}('</span> num2str(ic_idx) <span class="string">',:)'')'</span> ];
0597                             <span class="keyword">end</span>
0598                             IC_param_ref{class_from}{obs}{block}=p_idx;
0599                             
0600                             <span class="comment">%if eval([block_name '.I(parameter([' num2str(p_idx-1) ']))'])~=0&amp;&amp;class_from==1%||model.components.const{class_from}{obs}(block)==0</span>
0601                             
0602                             <span class="comment">%end</span>
0603                         <span class="keyword">end</span>
0604                     <span class="keyword">elseif</span> obs_idx~=obs
0605                         C{class_from}{obs_idx,obs}=[<span class="string">','</span> num2str(zeros(1,nb_hidden_states{class_from}{obs}))];
0606                     <span class="keyword">end</span>
0607                 <span class="keyword">end</span>
0608             <span class="keyword">end</span>
0609         <span class="keyword">end</span>
0610         <span class="keyword">if</span> class_from==class_to
0611             <span class="keyword">for</span> obs=1:numberOfTimeSeries  <span class="comment">%Loop over each observation</span>
0612                 Cc{class_from}{obs,1}=[<span class="string">',['</span> cell2mat(C{class_from}(obs,:)) <span class="string">']'</span>];
0613             <span class="keyword">end</span>
0614             model.A{class_from}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> A{class_from}(2:end) <span class="string">')'</span>]);
0615             model.C{class_from}=eval([<span class="string">'@(p,t,dt) reshape(['</span> ([Cc{class_from}{:}]) <span class="string">'],['</span> num2str(sum([nb_hidden_states{class_from}{:}])) <span class="string">','</span>  num2str(numberOfTimeSeries) <span class="string">'])'''</span>]);
0616             model.R{class_from}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> R{class_from}(2:end) <span class="string">')'</span>]);
0617             model.Q{class_from}{class_to}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> Q{class_from}{class_to}(2:end) <span class="string">')'</span>]);
0618         <span class="keyword">end</span>
0619     <span class="keyword">end</span>
0620 <span class="keyword">end</span>
0621 
0622 <span class="comment">%% Q_ij model process noise transition errors</span>
0623 <span class="keyword">for</span> class_from=1:numberOfModelClass  <span class="comment">%Loop over each model class</span>
0624     <span class="keyword">for</span> class_to=setdiff([1:numberOfModelClass],class_from)<span class="comment">%Loop over each model class</span>
0625         Q{class_from}{class_to}=[];
0626         <span class="keyword">if</span> class_from~=class_to
0627             <span class="keyword">for</span> obs=1:numberOfTimeSeries   <span class="comment">%Loop over each observation</span>
0628                 <span class="keyword">for</span> block=1:length(model.components.block{class_from}{obs}) <span class="comment">%loop over each model block</span>
0629                     block_idx=model.components.block{class_from}{obs}(block);
0630                     block_name=model.components.idx{block_idx};
0631                     <span class="comment">% Q - Model transition error covariance</span>
0632                     <span class="keyword">if</span> block_idx&gt;10&amp;&amp;block_idx&lt;30
0633                         nb_param=size(eval([block_name <span class="string">'.Q(1,1,1)'</span>]),1);
0634                         <span class="keyword">if</span> nb_param&gt;0
0635                             p_idx=param_idx:param_idx-1+nb_param;
0636                         <span class="keyword">else</span>
0637                             p_idx=[];
0638                         <span class="keyword">end</span>
0639                         <span class="keyword">if</span> class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1
0640                             Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p(['</span> num2str(Q_param_ref{1}{obs}{block}) <span class="string">']).^2,t,dt)'</span>]];
0641                         <span class="keyword">else</span>
0642                             Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[<span class="string">'diag(p(['</span> num2str(p_idx) <span class="string">']).^2)'</span>]];
0643                             
0644                             <span class="keyword">for</span> i=1:nb_param
0645                                 name=[eval([block_name <span class="string">'.pQ'</span>])];
0646                                 <span class="keyword">if</span> ~isempty(name)
0647                                     <span class="keyword">if</span> nb_param&gt;1
0648                                         name{1}=[name{1},<span class="string">'('</span> num2str(i),num2str(i) <span class="string">')'</span>];
0649                                     <span class="keyword">end</span>
0650                                     parameter=[parameter;1E3*eval(eval([block_name <span class="string">'.pQ0{:}'</span>]))];
0651                                     name{3}=[num2str(class_from) num2str(class_to)];
0652                                     name{4}=data.labels{obs};
0653                                 <span class="keyword">end</span>
0654                                 param_properties=[param_properties;name];
0655                             <span class="keyword">end</span>
0656                             param_idx=param_idx+nb_param;
0657                         <span class="keyword">end</span>
0658                     <span class="keyword">else</span>
0659                         Q{class_from}{class_to}=[Q{class_from}{class_to},<span class="string">','</span>,[block_name <span class="string">'.Q(p('</span> num2str(Q_param_ref{class_from}{obs}{block}) <span class="string">'),t,dt)'</span>]];
0660                     <span class="keyword">end</span>
0661                 <span class="keyword">end</span>
0662             <span class="keyword">end</span>
0663         <span class="keyword">end</span>
0664         <span class="keyword">if</span> class_from~=class_to
0665             model.Q{class_from}{class_to}=eval([<span class="string">'@(p,t,dt) blkdiag('</span> Q{class_from}{class_to}(2:end) <span class="string">')'</span>]);
0666         <span class="keyword">end</span>
0667     <span class="keyword">end</span>
0668 <span class="keyword">end</span>
0669 
0670 <span class="comment">%% Initial nanmean vector and covariance matrix</span>
0671 
0672 <span class="keyword">if</span> ~isfield(model,<span class="string">'initX'</span>)
0673     <span class="keyword">for</span> class_from=1:numberOfModelClass
0674         model.initX{class_from}=initX{class_from}';
0675     <span class="keyword">end</span>
0676 <span class="keyword">end</span>
0677 <span class="keyword">if</span> ~isfield(model,<span class="string">'initV'</span>)
0678     <span class="keyword">for</span> class_from=1:numberOfModelClass
0679         model.initV{class_from}=diag(initV{class_from});
0680     <span class="keyword">end</span>
0681 <span class="keyword">end</span>
0682 <span class="keyword">if</span> ~isfield(model,<span class="string">'initS'</span>)
0683     <span class="keyword">for</span> class_from=1:numberOfModelClass
0684         model.initS{class_from}=1/numberOfModelClass;
0685     <span class="keyword">end</span>
0686 <span class="keyword">end</span>
0687 
0688 <span class="comment">%% Transition matrix</span>
0689 model.Z=[];
0690 <span class="keyword">if</span> numberOfModelClass==1
0691     model.Z=@(p,t,dt) 1;
0692 <span class="keyword">elseif</span> numberOfModelClass==2
0693     model.Z=@(p,t,dt) eval([<span class="string">'[p('</span> num2str(param_idx) <span class="string">') 1-p('</span> num2str(param_idx) <span class="string">') ;1-p('</span> num2str(param_idx) <span class="string">'+1) p('</span> num2str(param_idx) <span class="string">'+1) ]^(dt/'</span> num2str(dt_ref) <span class="string">')'</span>]);
0694     param_properties=[param_properties;{<span class="string">'Z(11)'</span>,[],<span class="string">'11'</span>,[],[0,1]};{<span class="string">'Z(22)'</span>,[],<span class="string">'22'</span>,[],[0,1]}];
0695     parameter=[parameter;1-1/(dt_ref*365*10);1-1/(dt_ref*365*10)];
0696     param_idx=param_idx+2;
0697     
0698 <span class="keyword">else</span>
0699     <span class="keyword">for</span> i=1:numberOfModelClass
0700         <span class="keyword">for</span> j=i:numberOfModelClass
0701             param_idx=param_idx+1;
0702             model.Z=[model.Z;{ <span class="string">'p(param_idx)'</span>}];
0703             param_properties=[param_properties;{<span class="string">'\pi_z'</span>,[],[num2str(i),num2str(j)], [] ,[nan,nan]}];
0704             parameter=[parameter;0.5];
0705         <span class="keyword">end</span>
0706     <span class="keyword">end</span>
0707     model.Z=@(p,t,dt) [reshape(model.Z),[numberOfModelClass,numberOfModelClass]]^(dt/dt_ref);
0708 <span class="keyword">end</span>
0709 <span class="keyword">if</span> ~isfield(model,<span class="string">'parameter'</span>)
0710     model.parameter=parameter;
0711 <span class="keyword">end</span>
0712 <span class="keyword">if</span> ~isfield(model,<span class="string">'p_ref'</span>)
0713     model.p_ref=1:length(parameter);
0714 <span class="keyword">end</span>
0715 <span class="keyword">if</span> ~isfield(model,<span class="string">'param_properties'</span>)
0716     model.param_properties=param_properties;
0717 <span class="keyword">end</span>
0718 <span class="keyword">if</span> ~isfield(model.components,<span class="string">'PCA'</span>)
0719     model.components.PCA=cell(1,numberOfTimeSeries);
0720 <span class="keyword">end</span>
0721 model.hidden_states_names=hidden_states_names;
0722 
0723 
0724 
0725 
0726 
0727 <span class="comment">% %% Block initialization</span>
0728 <span class="comment">% param_properties={};        %Reference vector for parameter names in A,C,Q,R matrices</span>
0729 <span class="comment">% param_idx=1;                %Index for parameter count in A,C,Q,R matrices</span>
0730 <span class="comment">% x_count=zeros(numberOfTimeSeries,100);</span>
0731 <span class="comment">% parameter=[];               %Default values for parameters</span>
0732 <span class="comment">% nb_param_class=1;           %number of parameter per model class</span>
0733 <span class="comment">% for class_from=1:numberOfModelClass  %Loop over each model class</span>
0734 <span class="comment">%     h_count=0;                   %Count of the number of periodic component</span>
0735 <span class="comment">%     A{class_from}=[];            %Matrices initialization</span>
0736 <span class="comment">%     R{class_from}=[];</span>
0737 <span class="comment">%     initX{class_from}=[];        %Initial state variable expected value</span>
0738 <span class="comment">%     initV{class_from}=[];        %Initial state variable variance</span>
0739 <span class="comment">%     hidden_states_names{class_from}={};     %Reference vector for hidden state variables names</span>
0740 <span class="comment">%     for class_to=1:numberOfModelClass%Loop over each model class</span>
0741 <span class="comment">%         Q{class_from}{class_to}=[];</span>
0742 <span class="comment">%         CI_block=cell(numberOfTimeSeries);</span>
0743 <span class="comment">%         for obs=1:numberOfTimeSeries   %Loop over each observation</span>
0744 <span class="comment">%             p_count=0;                   %Count of the number of periodic component</span>
0745 <span class="comment">%             nb_hidden_states{class_from}{obs}=0;</span>
0746 <span class="comment">%             C{class_from}{obs,obs}=[];</span>
0747 <span class="comment">%             C_block=[];</span>
0748 <span class="comment">%             for block=1:length(model.components.block{class_from}{obs}) %loop over each model block</span>
0749 <span class="comment">%                 block_idx=model.components.block{class_from}{obs}(block);</span>
0750 <span class="comment">%                 block_name=model.components.idx{block_idx};</span>
0751 <span class="comment">%                 if class_from==class_to</span>
0752 <span class="comment">%                     x_count(obs,block_idx)=x_count(obs,block_idx)+1;    %count the number of components</span>
0753 <span class="comment">%                     if x_count(obs,block_idx)&gt;1</span>
0754 <span class="comment">%                         count_label=num2str(x_count(obs,block_idx));</span>
0755 <span class="comment">%                     else</span>
0756 <span class="comment">%                         count_label=num2str([]);</span>
0757 <span class="comment">%                     end</span>
0758 <span class="comment">%                     name=eval([block_name '.x']);</span>
0759 <span class="comment">%                     for i=1:size(name,1)</span>
0760 <span class="comment">%                         name{i,2}=num2str(class_from);</span>
0761 <span class="comment">%                         name{i,3}=data.labels{obs};</span>
0762 <span class="comment">%                         hidden_states_names{class_from}=[hidden_states_names{class_from};name(i,:)];</span>
0763 <span class="comment">%                     end</span>
0764 <span class="comment">%                     % initial hidden state values</span>
0765 <span class="comment">%                     initX{class_from}=[initX{class_from},eval(eval([block_name '.init{1}']))];</span>
0766 <span class="comment">%                     initV{class_from}=[initV{class_from},eval(eval([block_name '.init{2}']))];</span>
0767 <span class="comment">%</span>
0768 <span class="comment">%                     % A - Transition matrix</span>
0769 <span class="comment">%                     if class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1</span>
0770 <span class="comment">%                         A{class_from}=[A{class_from},',',[block_name '.A(p([' num2str(A_param_ref{1}{obs}{block}) ']),t,dt)']];</span>
0771 <span class="comment">%                     else</span>
0772 <span class="comment">%                         nb_param=eval(['size(' block_name '.pA,1)']);</span>
0773 <span class="comment">%                         if nb_param&gt;0</span>
0774 <span class="comment">%                             p_idx=param_idx:param_idx-1+nb_param;</span>
0775 <span class="comment">%                         else</span>
0776 <span class="comment">%                             p_idx=[];</span>
0777 <span class="comment">%                         end</span>
0778 <span class="comment">%                         A{class_from}=[A{class_from},',',[block_name '.A(p([' num2str(p_idx) ']),t,dt)']];</span>
0779 <span class="comment">%                         if any(strcmp(eval([block_name '.pA']),'p'))</span>
0780 <span class="comment">%                             p_count=p_count+1;</span>
0781 <span class="comment">%                             name={'p' ,['PD' num2str(p_count)],[],[],eval([block_name '.pQ{5}'])};</span>
0782 <span class="comment">%                             p_value=eval([block_name '.pA0{' num2str(p_count) '}']);</span>
0783 <span class="comment">%                             if ~isempty(p_value)</span>
0784 <span class="comment">%                                 parameter=[parameter;eval(p_value)];</span>
0785 <span class="comment">%                             end</span>
0786 <span class="comment">%                         else</span>
0787 <span class="comment">%                             name=eval([block_name '.pA']);</span>
0788 <span class="comment">%                             p_value=eval([block_name '.pA0']);</span>
0789 <span class="comment">%                             if ~isempty(p_value)</span>
0790 <span class="comment">%                                 parameter=[parameter;eval(p_value{:})];</span>
0791 <span class="comment">%                             end</span>
0792 <span class="comment">%                         end</span>
0793 <span class="comment">%                         if ~isempty(name)</span>
0794 <span class="comment">%                             name{3}=[num2str(class_from)];</span>
0795 <span class="comment">%                             name{4}=data.labels{obs};</span>
0796 <span class="comment">%                         end</span>
0797 <span class="comment">%                         param_properties=[param_properties;name];</span>
0798 <span class="comment">%                         A_param_ref{class_from}{obs}{block}=p_idx;</span>
0799 <span class="comment">%                         param_idx=param_idx+nb_param;</span>
0800 <span class="comment">%                     end</span>
0801 <span class="comment">%</span>
0802 <span class="comment">%                     % Q - Model transition error covariance</span>
0803 <span class="comment">%                     if class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1</span>
0804 <span class="comment">%                         Q{class_from}{class_to}=[Q{class_from}{class_to},',',[block_name '.Q(p([' num2str(Q_param_ref{1}{obs}{block}) ']),t,dt)']];</span>
0805 <span class="comment">%                         Q_param_ref{class_from}{obs}{block}=Q_param_ref{1}{obs}{block};</span>
0806 <span class="comment">%                     else</span>
0807 <span class="comment">%                         nb_param=eval(['size(' block_name '.pQ,1)']);</span>
0808 <span class="comment">%                         if nb_param&gt;0</span>
0809 <span class="comment">%                             p_idx=param_idx:param_idx-1+nb_param;</span>
0810 <span class="comment">%                         else</span>
0811 <span class="comment">%                             p_idx=[];</span>
0812 <span class="comment">%                         end</span>
0813 <span class="comment">%                         Q{class_from}{class_to}=[Q{class_from}{class_to},',',[block_name '.Q(p([' num2str(p_idx) ']),t,dt)']];</span>
0814 <span class="comment">%                         if any(strcmp(eval([block_name '.pA']),'p'))</span>
0815 <span class="comment">%                             name={'\sigma_w',['PD' num2str(p_count)],[],[],eval([block_name '.pQ{5}'])};</span>
0816 <span class="comment">%                         else</span>
0817 <span class="comment">%                             name=eval([block_name '.pQ']);</span>
0818 <span class="comment">%                         end</span>
0819 <span class="comment">%                         if ~isempty(name)</span>
0820 <span class="comment">%                             p_value=eval(eval([block_name '.pQ0{:}']));</span>
0821 <span class="comment">%                             parameter=[parameter;p_value];</span>
0822 <span class="comment">%                             name{3}=[num2str(class_from)];</span>
0823 <span class="comment">%                             name{4}=data.labels{obs};</span>
0824 <span class="comment">%                         end</span>
0825 <span class="comment">%                         param_properties=[param_properties;name];</span>
0826 <span class="comment">%                         Q_param_ref{class_from}{obs}{block}=p_idx;</span>
0827 <span class="comment">%                         param_idx=param_idx+nb_param;</span>
0828 <span class="comment">%                     end</span>
0829 <span class="comment">%</span>
0830 <span class="comment">%                     % C - Observation matrix</span>
0831 <span class="comment">%                     if class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1</span>
0832 <span class="comment">%                         C_block=[C_block,',',[block_name '.C(p([' num2str(C_param_ref{1}{obs}{block}) ']),t,dt)']];</span>
0833 <span class="comment">%                     else</span>
0834 <span class="comment">%                         nb_param=eval(['size(' block_name '.pC,1)']);</span>
0835 <span class="comment">%                         if nb_param&gt;0</span>
0836 <span class="comment">%                             p_idx=param_idx:param_idx-1+nb_param;</span>
0837 <span class="comment">%                         else</span>
0838 <span class="comment">%                             p_idx=[];</span>
0839 <span class="comment">%                         end</span>
0840 <span class="comment">%                         C_block=[C_block,',',[block_name '.C(p([' num2str(p_idx) ']),t,dt)']];</span>
0841 <span class="comment">%                         name=eval([block_name '.pC']);</span>
0842 <span class="comment">%                         if ~isempty(name)</span>
0843 <span class="comment">%                             if any(strcmp(eval([block_name '.pC{1,1}']),'ycp1'))</span>
0844 <span class="comment">%                                 for i=1:length(eval([block_name '.pC']))</span>
0845 <span class="comment">%                                     h_count=h_count+1;</span>
0846 <span class="comment">%                                     p_value=eval([block_name '.pC0{' num2str(h_count) '}']);</span>
0847 <span class="comment">%                                     parameter=[parameter;eval(p_value)];</span>
0848 <span class="comment">%                                     name{i,3}=[num2str(class_from)];</span>
0849 <span class="comment">%                                     name{i,4}=data.labels{obs};</span>
0850 <span class="comment">%                                 end</span>
0851 <span class="comment">%                             else</span>
0852 <span class="comment">%                                 p_value=eval([block_name '.pC0{' num2str(p_count) '}']);</span>
0853 <span class="comment">%                                 parameter=[parameter;eval(h_value)];</span>
0854 <span class="comment">%                                 name{3}=[num2str(class_from)];</span>
0855 <span class="comment">%                                 name{4}=data.labels{obs};</span>
0856 <span class="comment">%                             end</span>
0857 <span class="comment">%                         end</span>
0858 <span class="comment">%                         param_properties=[param_properties;name];</span>
0859 <span class="comment">%                         C_param_ref{class_from}{obs}{block}=p_idx;</span>
0860 <span class="comment">%                         param_idx=param_idx+nb_param;</span>
0861 <span class="comment">%                     end</span>
0862 <span class="comment">%                     nb_hidden_states{class_from}{obs}=nb_hidden_states{class_from}{obs}+length(eval([block_name '.A(ones(1,1000),1,1)']));</span>
0863 <span class="comment">%                 end</span>
0864 <span class="comment">%             end</span>
0865 <span class="comment">%             if class_from==class_to</span>
0866 <span class="comment">%</span>
0867 <span class="comment">%                 R{class_from}=[R{class_from},',p([' num2str(param_idx) '])^2'];</span>
0868 <span class="comment">%                 C{class_from}{obs,obs}=[C{class_from}{obs,obs},',[' C_block(2:end) ']'];</span>
0869 <span class="comment">%                 param_properties=[param_properties;{['\sigma_v'],[],[num2str(class_from)],[data.labels{obs}],[0,inf]}];</span>
0870 <span class="comment">%</span>
0871 <span class="comment">%                if misc.isDataSimulation</span>
0872 <span class="comment">%                    parameter=[parameter;0.01];</span>
0873 <span class="comment">%                else</span>
0874 <span class="comment">%                    parameter=[parameter;0.05*nanstd(data.values{obs})];</span>
0875 <span class="comment">%                end</span>
0876 <span class="comment">%                 param_idx=param_idx+1;</span>
0877 <span class="comment">%</span>
0878 <span class="comment">%                 % PCA inter-component regression</span>
0879 <span class="comment">%                 if isfield(model.components,'PCA')</span>
0880 <span class="comment">%                     %PCA_coeff=model.components.PCA{obs};</span>
0881 <span class="comment">%                     for pca_idx=1:length(model.components.ic{obs})</span>
0882 <span class="comment">%                         PCA_reg_param{obs}(pca_idx)=param_idx;</span>
0883 <span class="comment">%                         param_properties=[param_properties;{['\phi'],[ data.labels{obs}(1) '|' 'PC' num2str(pca_idx) ],[num2str(class_from)],[data.labels{obs}],[-inf,inf]}];</span>
0884 <span class="comment">%                         parameter=[parameter;1];</span>
0885 <span class="comment">%                         param_idx=param_idx+1;</span>
0886 <span class="comment">%                     end</span>
0887 <span class="comment">%</span>
0888 <span class="comment">%                 end</span>
0889 <span class="comment">%</span>
0890 <span class="comment">%                 % I - Inter-component regression</span>
0891 <span class="comment">%                 for obs_idx=1:numberOfTimeSeries</span>
0892 <span class="comment">%</span>
0893 <span class="comment">%                     if obs_idx ~= obs</span>
0894 <span class="comment">%                         C{class_from}{obs_idx,obs} = [];</span>
0895 <span class="comment">%                     end</span>
0896 <span class="comment">%</span>
0897 <span class="comment">%                     ic_idx=find([model.components.ic{obs_idx}]==obs);</span>
0898 <span class="comment">%                     if ~isempty(ic_idx)</span>
0899 <span class="comment">%                         %param_reg=0;</span>
0900 <span class="comment">%                         for block=1:length(model.components.block{class_from}{obs}) %loop over each model block</span>
0901 <span class="comment">%                             block_idx=model.components.block{class_from}{obs}(block);</span>
0902 <span class="comment">%                             block_name=model.components.idx{block_idx};</span>
0903 <span class="comment">%                             nb_param=eval(['size(' block_name '.pI,1)']);</span>
0904 <span class="comment">%                             if nb_param&gt;0</span>
0905 <span class="comment">%                                 %if param_reg==0</span>
0906 <span class="comment">%                                 p_idx=param_idx:param_idx-1+nb_param;</span>
0907 <span class="comment">%                                 param_reg=p_idx;</span>
0908 <span class="comment">%                                 param_properties=[param_properties;{'\phi', [data.labels{obs_idx}(1) '|' data.labels{obs}(1) '(' block_name ')' ],[num2str(class_from)],[data.labels{obs}],[-inf,inf]}];</span>
0909 <span class="comment">%                                 parameter=[parameter;eval(eval([block_name '.pI0{:}']))];</span>
0910 <span class="comment">%                                 param_idx=param_idx+1;</span>
0911 <span class="comment">%                                 %else</span>
0912 <span class="comment">%                                 %    p_idx=param_reg;</span>
0913 <span class="comment">%                                 %end</span>
0914 <span class="comment">%                             else</span>
0915 <span class="comment">%                                 p_idx=[];</span>
0916 <span class="comment">%                             end</span>
0917 <span class="comment">%</span>
0918 <span class="comment">%                             if class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1</span>
0919 <span class="comment">%                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},',',[block_name '.I(p([' num2str(IC_param_ref{1}{obs}{block}) ']),t,dt)']];</span>
0920 <span class="comment">%                             else</span>
0921 <span class="comment">%                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},',',[block_name '.I(p([' num2str(p_idx) ']),t,dt)']];</span>
0922 <span class="comment">%                             end</span>
0923 <span class="comment">%                             if isfield(model.components,'PCA')</span>
0924 <span class="comment">%                                 C{class_from}{obs_idx,obs}=[C{class_from}{obs_idx,obs},'*','sum(p([' num2str(PCA_reg_param{obs_idx}) ']).*model.components.PCA{' num2str(obs_idx) '}(' num2str(ic_idx) ',:)'')' ];</span>
0925 <span class="comment">%                             end</span>
0926 <span class="comment">%                             IC_param_ref{class_from}{obs}{block}=p_idx;</span>
0927 <span class="comment">%</span>
0928 <span class="comment">%                             %if eval([block_name '.I(parameter([' num2str(p_idx-1) ']))'])~=0&amp;&amp;class_from==1%||model.components.const{class_from}{obs}(block)==0</span>
0929 <span class="comment">%</span>
0930 <span class="comment">%                             %end</span>
0931 <span class="comment">%                         end</span>
0932 <span class="comment">%                     elseif obs_idx~=obs</span>
0933 <span class="comment">%                             C{class_from}{obs_idx,obs}=[',' num2str(zeros(1,nb_hidden_states{class_from}{obs}))];</span>
0934 <span class="comment">%                     end</span>
0935 <span class="comment">%                 end</span>
0936 <span class="comment">%             end</span>
0937 <span class="comment">%         end</span>
0938 <span class="comment">%         if class_from==class_to</span>
0939 <span class="comment">%             for obs=1:numberOfTimeSeries  %Loop over each observation</span>
0940 <span class="comment">%                 Cc{class_from}{obs,1}=[',[' cell2mat(C{class_from}(obs,:)) ']'];</span>
0941 <span class="comment">%             end</span>
0942 <span class="comment">%             model.A{class_from}=eval(['@(p,t,dt) blkdiag(' A{class_from}(2:end) ')']);</span>
0943 <span class="comment">%             model.C{class_from}=eval(['@(p,t,dt) reshape([' ([Cc{class_from}{:}]) '],[' num2str(sum([nb_hidden_states{class_from}{:}])) ','  num2str(numberOfTimeSeries) '])''']);</span>
0944 <span class="comment">%             model.R{class_from}=eval(['@(p,t,dt) blkdiag(' R{class_from}(2:end) ')']);</span>
0945 <span class="comment">%             model.Q{class_from}{class_to}=eval(['@(p,t,dt) blkdiag(' Q{class_from}{class_to}(2:end) ')']);</span>
0946 <span class="comment">%         end</span>
0947 <span class="comment">%     end</span>
0948 <span class="comment">% end</span>
0949 <span class="comment">%</span>
0950 <span class="comment">% %% Q_ij model process noise transition errors</span>
0951 <span class="comment">% for class_from=1:numberOfModelClass  %Loop over each model class</span>
0952 <span class="comment">%     for class_to=setdiff([1:numberOfModelClass],class_from)%Loop over each model class</span>
0953 <span class="comment">%         Q{class_from}{class_to}=[];</span>
0954 <span class="comment">%         if class_from~=class_to</span>
0955 <span class="comment">%             for obs=1:numberOfTimeSeries   %Loop over each observation</span>
0956 <span class="comment">%                 for block=1:length(model.components.block{class_from}{obs}) %loop over each model block</span>
0957 <span class="comment">%                     block_idx=model.components.block{class_from}{obs}(block);</span>
0958 <span class="comment">%                     block_name=model.components.idx{block_idx};</span>
0959 <span class="comment">%                     % Q - Model transition error covariance</span>
0960 <span class="comment">%                     if block_idx&gt;10&amp;&amp;block_idx&lt;30</span>
0961 <span class="comment">%                         nb_param=size(eval([block_name '.Q(1,1,1)']),1);</span>
0962 <span class="comment">%                         if nb_param&gt;0</span>
0963 <span class="comment">%                             p_idx=param_idx:param_idx-1+nb_param;</span>
0964 <span class="comment">%                         else</span>
0965 <span class="comment">%                             p_idx=[];</span>
0966 <span class="comment">%                         end</span>
0967 <span class="comment">%                         if class_from&gt;1&amp;&amp;model.components.const{class_from}{obs}(block)==1</span>
0968 <span class="comment">%                             Q{class_from}{class_to}=[Q{class_from}{class_to},',',[block_name '.Q(p([' num2str(Q_param_ref{1}{obs}{block}) ']).^2,t,dt)']];</span>
0969 <span class="comment">%                         else</span>
0970 <span class="comment">%                             Q{class_from}{class_to}=[Q{class_from}{class_to},',',['diag(p([' num2str(p_idx) ']).^2)']];</span>
0971 <span class="comment">%</span>
0972 <span class="comment">%                             for i=1:nb_param</span>
0973 <span class="comment">%                                 name=[eval([block_name '.pQ'])];</span>
0974 <span class="comment">%                                 if ~isempty(name)</span>
0975 <span class="comment">%                                     if nb_param&gt;1</span>
0976 <span class="comment">%                                         name{1}=[name{1},'(' num2str(i),num2str(i) ')'];</span>
0977 <span class="comment">%                                     end</span>
0978 <span class="comment">%                                     parameter=[parameter;1E3*eval(eval([block_name '.pQ0{:}']))];</span>
0979 <span class="comment">%                                     name{3}=[num2str(class_from) num2str(class_to)];</span>
0980 <span class="comment">%                                     name{4}=data.labels{obs};</span>
0981 <span class="comment">%                                 end</span>
0982 <span class="comment">%                                 param_properties=[param_properties;name];</span>
0983 <span class="comment">%                             end</span>
0984 <span class="comment">%                             param_idx=param_idx+nb_param;</span>
0985 <span class="comment">%                         end</span>
0986 <span class="comment">%                     else</span>
0987 <span class="comment">%                         Q{class_from}{class_to}=[Q{class_from}{class_to},',',[block_name '.Q(p(' num2str(Q_param_ref{class_from}{obs}{block}) '),t,dt)']];</span>
0988 <span class="comment">%                     end</span>
0989 <span class="comment">%                 end</span>
0990 <span class="comment">%             end</span>
0991 <span class="comment">%         end</span>
0992 <span class="comment">%         if class_from~=class_to</span>
0993 <span class="comment">%             model.Q{class_from}{class_to}=eval(['@(p,t,dt) blkdiag(' Q{class_from}{class_to}(2:end) ')']);</span>
0994 <span class="comment">%         end</span>
0995 <span class="comment">%     end</span>
0996 <span class="comment">% end</span>
0997 <span class="comment">%</span>
0998 <span class="comment">% %% Initial nanmean vector and covariance matrix</span>
0999 <span class="comment">%</span>
1000 <span class="comment">% if ~isfield(model,'initX')</span>
1001 <span class="comment">%     for class_from=1:numberOfModelClass</span>
1002 <span class="comment">%         model.initX{class_from}=initX{class_from}';</span>
1003 <span class="comment">%     end</span>
1004 <span class="comment">% end</span>
1005 <span class="comment">% if ~isfield(model,'initV')</span>
1006 <span class="comment">%     for class_from=1:numberOfModelClass</span>
1007 <span class="comment">%         model.initV{class_from}=diag(initV{class_from});</span>
1008 <span class="comment">%     end</span>
1009 <span class="comment">% end</span>
1010 <span class="comment">% if ~isfield(model,'initS')</span>
1011 <span class="comment">%     for class_from=1:numberOfModelClass</span>
1012 <span class="comment">%         model.initS{class_from}=1/numberOfModelClass;</span>
1013 <span class="comment">%     end</span>
1014 <span class="comment">% end</span>
1015 <span class="comment">%</span>
1016 <span class="comment">% %% Transition matrix</span>
1017 <span class="comment">% model.Z=[];</span>
1018 <span class="comment">% if numberOfModelClass==1</span>
1019 <span class="comment">%     model.Z=@(p,t,dt) 1;</span>
1020 <span class="comment">% elseif numberOfModelClass==2</span>
1021 <span class="comment">%     model.Z=@(p,t,dt) eval(['[p(' num2str(param_idx) ') 1-p(' num2str(param_idx) ') ;1-p(' num2str(param_idx) '+1) p(' num2str(param_idx) '+1) ]^(dt/' num2str(dt_ref) ')']);</span>
1022 <span class="comment">%     param_properties=[param_properties;{'Z(11)',[],'11',[],[0,1]};{'Z(22)',[],'22',[],[0,1]}];</span>
1023 <span class="comment">%     parameter=[parameter;1-1/(dt_ref*365*10);1-1/(dt_ref*365*10)];</span>
1024 <span class="comment">%     param_idx=param_idx+2;</span>
1025 <span class="comment">%</span>
1026 <span class="comment">% else</span>
1027 <span class="comment">%     for i=1:numberOfModelClass</span>
1028 <span class="comment">%         for j=i:numberOfModelClass</span>
1029 <span class="comment">%             param_idx=param_idx+1;</span>
1030 <span class="comment">%             model.Z=[model.Z;{ 'p(param_idx)'}];</span>
1031 <span class="comment">%             param_properties=[param_properties;{'\pi_z',[],[num2str(i),num2str(j)], [] ,[nan,nan]}];</span>
1032 <span class="comment">%             parameter=[parameter;0.5];</span>
1033 <span class="comment">%         end</span>
1034 <span class="comment">%     end</span>
1035 <span class="comment">%     model.Z=@(p,t,dt) [reshape(model.Z),[numberOfModelClass,numberOfModelClass]]^(dt/dt_ref);</span>
1036 <span class="comment">% end</span>
1037 <span class="comment">% if ~isfield(model,'parameter')</span>
1038 <span class="comment">%     model.parameter=parameter;</span>
1039 <span class="comment">% end</span>
1040 <span class="comment">% if ~isfield(model,'p_ref')</span>
1041 <span class="comment">%     model.p_ref=1:length(parameter);</span>
1042 <span class="comment">% end</span>
1043 <span class="comment">% if ~isfield(model,'param_properties')</span>
1044 <span class="comment">%     model.param_properties=param_properties;</span>
1045 <span class="comment">% end</span>
1046 <span class="comment">% if ~isfield(model.components,'PCA')</span>
1047 <span class="comment">%     model.components.PCA=cell(1,numberOfTimeSeries);</span>
1048 <span class="comment">% end</span>
1049 <span class="comment">% model.hidden_states_names=hidden_states_names;</span>
1050  
1051 <span class="comment">%--------------------END CODE ------------------------</span>
1052 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 18-Jun-2018 12:19:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>