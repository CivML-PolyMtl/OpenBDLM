<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of SKF</title>
  <meta name="keywords" content="SKF">
  <meta name="description" content="INPUTS:">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">BDLM_DATA_LOADER_9</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">StateEstimation</a> &gt; SKF.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for BDLM_DATA_LOADER_9/functions/StateEstimation&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>SKF
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>INPUTS:</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [x, V, VV, S, loglik, pr_model_false_full, U,D] = SKF(data,model,misc) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> INPUTS:
 y(:,t)   - the observation at time t
 A - the system matrix
 C - the observation matrix
 Q - the system covariance
 R - the observation covariance
 Z - Transition probabilities for model classes
 init_x - the initial state (column) vector
 init_V - the initial state covariance
 init_S - the initial model class probabilities

 OUTPUTS (where X is the hidden state being estimated)
 x(:,t) = E[X(:,t) | y(:,1:t)]
 V(:,:,t) = Cov[X(:,t) | y(:,1:t)]
 loglik = sum{t=1}^T log P(y(:,t))</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../BDLM_DATA_LOADER_9/functions/ModelConfiguration/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>	COMPUTETIMESTEPS compute timestep vector from timestamps vector</li><li><a href="KF.html" class="code" title="function [xnew, Vnew, VVnew, loglik] = KF(A, C, Q, R, y, x, V,varargin)">KF</a>	function [xnew, Vnew, VVnew, loglik, pr_model_false_marginal, nis, e] = KF(A, C, Q, R, y, x, V,varargin)</li><li><a href="UDF.html" class="code" title="function [xnew, Vnew, VVnew, U_post, D_post, loglik] = UDF(A, C, Q, R, y, x, V, U_post, D_post)">UDF</a>	</li><li><a href="myUD.html" class="code" title="function [U D] = myUD(mat,varargin)">myUD</a>	--------------------------------------------------------------------------</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../BDLM_DATA_LOADER_9/functions/ModelParametersLearning/NR_EM.html" class="code" title="function [optim]=NR_EM(data, model, misc, varargin)">NR_EM</a>	INPUTS:</li><li><a href="../../../BDLM_DATA_LOADER_9/functions/ModelParametersLearning/logPosteriorPE.html" class="code" title="function [logpdf, Glogpdf, Hlogpdf, delta_grad] = logPosteriorPE(data, model, option, varargin)">logPosteriorPE</a>	INPUTS:</li><li><a href="state_estimation.html" class="code" title="function [estimation]=state_estimation(data,model,estimation, misc, varargin)">state_estimation</a>	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [x, V, VV, S, loglik, pr_model_false_full, U,D] = SKF(data,model,misc)</a>
0002 <span class="comment">% INPUTS:</span>
0003 <span class="comment">% y(:,t)   - the observation at time t</span>
0004 <span class="comment">% A - the system matrix</span>
0005 <span class="comment">% C - the observation matrix</span>
0006 <span class="comment">% Q - the system covariance</span>
0007 <span class="comment">% R - the observation covariance</span>
0008 <span class="comment">% Z - Transition probabilities for model classes</span>
0009 <span class="comment">% init_x - the initial state (column) vector</span>
0010 <span class="comment">% init_V - the initial state covariance</span>
0011 <span class="comment">% init_S - the initial model class probabilities</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% OUTPUTS (where X is the hidden state being estimated)</span>
0014 <span class="comment">% x(:,t) = E[X(:,t) | y(:,1:t)]</span>
0015 <span class="comment">% V(:,:,t) = Cov[X(:,t) | y(:,1:t)]</span>
0016 <span class="comment">% loglik = sum{t=1}^T log P(y(:,t))</span>
0017 <span class="comment">%</span>
0018 
0019 <span class="comment">%% Get timestamps</span>
0020 timestamps = data.timestamps;
0021 
0022 <span class="comment">%% Compute timestep vector</span>
0023 [timesteps]=<a href="../../../BDLM_DATA_LOADER_9/functions/ModelConfiguration/computeTimeSteps.html" class="code" title="function [timesteps]=computeTimeSteps(timestamps)">computeTimeSteps</a>(timestamps);
0024 
0025 <span class="comment">%% Transform data.values to an array</span>
0026 DataValues = data.values;
0027 
0028 T = length(timestamps);
0029 M = model.nb_class;           <span class="comment">%Number of model classes</span>
0030 
0031 <span class="keyword">if</span> strcmp(misc.method,<span class="string">'UD'</span>)
0032     U=cell(M,M,T);
0033     D=cell(M,M,T);
0034     <span class="keyword">if</span> isfield(model,<span class="string">'U'</span>)     <span class="comment">%Online procedure</span>
0035         <span class="keyword">for</span> j=1:M
0036             <span class="keyword">for</span> i=1:M
0037                 U{i,j,1}=model.U{i,j,1};
0038                 D{i,j,1}=model.D{i,j,1};
0039             <span class="keyword">end</span>
0040         <span class="keyword">end</span>
0041     <span class="keyword">end</span>
0042 <span class="keyword">elseif</span> strcmp(misc.method,<span class="string">'kalman'</span>)
0043     U=[];
0044     D=[];
0045 <span class="keyword">else</span>
0046     error(<span class="string">'estimation method not recognized | SKF.m'</span>)
0047 <span class="keyword">end</span>
0048 
0049 <span class="comment">%% Initialization</span>
0050 x = cell(1,M);
0051 V = cell(1,M);
0052 VV = cell(1,M);
0053 x_ij=cell(1,M);
0054 V_ij=cell(1,M);
0055 VV_ij=cell(1,M);
0056 sigma22_idx=find(contains(model.param_properties(:,1),<span class="string">'\sigma_w(22)'</span>),1,<span class="string">'first'</span>);
0057 
0058 <span class="comment">%% Preallocate the matrices A, C, R, Z, Q</span>
0059 A=cell(M,T);
0060 C=cell(M,T);
0061 R=cell(M,T);
0062 Z=cell(1,T);
0063 Q=cell(M,M,T);
0064 
0065 pr_model_false=zeros(1,T);
0066 
0067 <span class="keyword">for</span> j=1:M
0068     ss=size(model.hidden_states_names{1},1);
0069     x{j} = zeros(ss,T);
0070     V{j} = zeros(ss, ss,T);
0071     VV{j} = zeros(ss, ss,T);
0072     
0073     x_ij{j} = zeros(ss,M);
0074     V_ij{j} = zeros(ss,ss,M);
0075     VV_ij{j} = zeros(ss,ss,M);
0076 <span class="keyword">end</span>
0077 
0078 S = zeros(T,M);
0079 W=zeros(M,M);
0080 LL=zeros(M,M);
0081 pr_model_false_marginal=zeros(M,M);
0082 
0083 loglik = 0;
0084 <span class="comment">%% Estimate state for each t</span>
0085 <span class="keyword">for</span> t=1:T
0086     log_S_marginal = zeros(M,M);
0087     lik_merge=0;
0088     pr_model_false_sum = 0;
0089     
0090     <span class="keyword">for</span> j=1:M       <span class="comment">% transition model</span>
0091         <span class="keyword">if</span> (t==1|(timesteps(t)~=timesteps(1:t-1)))
0092             A{j,t} = model.A{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0093             C{j,t} = model.C{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0094             R{j,t} = model.R{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0095             Z{t} = model.Z(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0096         <span class="keyword">else</span>
0097             idx=find(timesteps(t)==timesteps(1:t-1),1,<span class="string">'first'</span>);
0098             A{j,t}=A{j,idx};
0099             C{j,t} = model.C{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0100             R{j,t}=R{j,idx};
0101             Z{t}=Z{idx};
0102 
0103         <span class="keyword">end</span>
0104         <span class="keyword">for</span> i=1:M   <span class="comment">% starting model</span>
0105             <span class="keyword">if</span> (t==1|(timesteps(t)~=timesteps(1:t-1)))
0106                 Q{j,i,t} = model.Q{i}{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));
0107             <span class="keyword">else</span>
0108                 idx=find(timesteps(t)==timesteps(1:t-1),1,<span class="string">'first'</span>);
0109                 Q{j,i,t}=Q{j,i,idx};
0110             <span class="keyword">end</span>
0111 <span class="comment">%         if and(j==1,i==2)</span>
0112 <span class="comment">%             Q{j,i,t}=diag(diag(Q{j,j,t}));</span>
0113 <span class="comment">%             Q{j,i,t}(2,2)=model.parameter(sigma22_idx)^2*(timesteps(t)^2/data.dt_ref);</span>
0114 <span class="comment">%         elseif and(j==2,i==1)</span>
0115 <span class="comment">%             QQ = model.Q{j}{j}(model.parameter(model.p_ref),timestamps(t),timesteps(t));</span>
0116 <span class="comment">%             Q{j,i,t}=diag(diag(QQ));</span>
0117 <span class="comment">%             Q{j,i,t}(2,2)=model.parameter(sigma22_idx)^2*(timesteps(t)^4/(3*data.dt_ref));</span>
0118 <span class="comment">%         end</span>
0119             
0120             <span class="keyword">if</span> t==1
0121                 prevX = model.initX{i};
0122                 prevV = model.initV{i};
0123                 prevS = model.initS{i};
0124                 <span class="keyword">if</span> strcmp(misc.method,<span class="string">'UD'</span>)
0125                     <span class="keyword">if</span> and(isempty(U{i,j,t}),isempty(D{i,j,t}))
0126                         error_myUD=1;
0127                         <span class="keyword">while</span> error_myUD
0128                             <span class="keyword">try</span>
0129                                 [U{i,j,t},D{i,j,t}] = <a href="myUD.html" class="code" title="function [U D] = myUD(mat,varargin)">myUD</a>(prevV);
0130                                 <span class="keyword">if</span> isempty(U{i,j,t})
0131                                     error_myUD=1;
0132                                 <span class="keyword">else</span>
0133                                     error_myUD=0;
0134                                 <span class="keyword">end</span>
0135                             <span class="keyword">catch</span> err
0136                                 disp([<span class="string">'warning:  UD decomposition failed at time step: '</span> num2str(t) <span class="string">'| SKF.m'</span>])
0137                                 disp(<span class="string">' -&gt; Retry without covariance terms in''prevV'''</span>)
0138                                 prevV=diag(diag(prevV));
0139                             <span class="keyword">end</span>
0140                         <span class="keyword">end</span>
0141                     <span class="keyword">end</span>
0142                 <span class="keyword">end</span>
0143             <span class="keyword">else</span>
0144                 prevX = x{i}(:,t-1);
0145                 prevV = V{i}(:,:,t-1);
0146                 prevS = S(t-1,i);
0147             <span class="keyword">end</span>
0148             <span class="keyword">if</span> strcmp(misc.method,<span class="string">'UD'</span>)
0149                 <span class="comment">%% UD filter</span>
0150                 [x_ij{j}(:,i), V_ij{j}(:,:,i), VV_ij{j}(:,:,i), U{i,j,t+1}, D{i,j,t+1}, LL(i,j,t)] = <a href="UDF.html" class="code" title="function [xnew, Vnew, VVnew, U_post, D_post, loglik] = UDF(A, C, Q, R, y, x, V, U_post, D_post)">UDF</a>(A{j,t},C{j,t},Q{j,i,t},R{j,t}, DataValues(t,:)', prevX, prevV, U{i,j,t}, D{i,j,t});
0151             <span class="keyword">else</span>
0152                 <span class="comment">%% Kalman filter</span>
0153                 warning(<span class="string">'off'</span>,<span class="string">'all'</span>)
0154                 <span class="comment">%[x_ij{j}(:,i), V_ij{j}(:,:,i), VV_ij{j}(:,:,i), LL(i,j,t), pr_model_false_marginal(i,j,t), nis(i,j,t), e(i,j,t)] = KF(A{j,t},C{j,t},Q{j,i,t},R{j,t}, DataValues(t,:)', prevX, prevV);</span>
0155                 [x_ij{j}(:,i), V_ij{j}(:,:,i), VV_ij{j}(:,:,i), LL(i,j,t)] = <a href="KF.html" class="code" title="function [xnew, Vnew, VVnew, loglik] = KF(A, C, Q, R, y, x, V,varargin)">KF</a>(A{j,t},C{j,t},Q{j,i,t},R{j,t}, DataValues(t,:)', prevX, prevV);
0156                 warning(<span class="string">'on'</span>,<span class="string">'all'</span>)
0157             <span class="keyword">end</span>
0158             
0159             <span class="keyword">if</span> isnan(LL(i,j,t))
0160                 LL(i,j,t)=1;
0161                 loglik=-inf;
0162                 disp([<span class="string">'warning: LL{'</span> num2str(i) <span class="string">','</span> num2str(j) <span class="string">'}(t='</span> num2str(t) <span class="string">')=nan | SKF.m'</span>])
0163                 <span class="keyword">break</span>
0164             <span class="keyword">end</span>
0165             
0166             log_S_marginal(i,j)=LL(i,j,t) + log(Z{t}(i,j)) + log(prevS);
0167             lik_merge=lik_merge + exp(log_S_marginal(i,j));
0168                         
0169             <span class="comment">%  Probability of model falsification (Ianis)</span>
0170             <span class="comment">%pr_model_false_sum = pr_model_false_sum + pr_model_false_marginal(i,j,t)*Z{t}(i,j)*prevS ;</span>
0171             
0172             <span class="keyword">if</span> any(any(isnan(VV_ij{j}(:,:,i))))
0173                 disp([<span class="string">'warning: VV_ij{'</span> num2str(i) <span class="string">','</span> num2str(j) <span class="string">'}(t='</span> num2str(t) <span class="string">')=nan | SKF.m'</span>])
0174             <span class="keyword">end</span>
0175         <span class="keyword">end</span>
0176         <span class="keyword">if</span> loglik==-inf
0177             disp([<span class="string">'warning: LL{'</span> num2str(i) <span class="string">','</span> num2str(j) <span class="string">'}(t='</span> num2str(t) <span class="string">')=-inf | SKF.m'</span>])
0178             <span class="keyword">break</span>
0179         <span class="keyword">end</span>
0180     <span class="keyword">end</span>
0181     
0182     <span class="comment">%pr_model_false(t)=pr_model_false_sum;</span>
0183     
0184     loglik_ind(t)=lik_merge;
0185     
0186     <span class="keyword">if</span> loglik==-inf
0187         <span class="keyword">break</span>
0188     <span class="keyword">end</span>
0189     
0190     loglik=loglik+log(lik_merge);
0191     <span class="keyword">if</span> loglik==-inf
0192         disp(<span class="string">'warning: loglik=-inf | SKF.m'</span>)
0193         <span class="keyword">break</span>
0194     <span class="keyword">elseif</span> isnan(loglik)
0195         disp(<span class="string">'warning: loglik=-inf | SKF.m'</span>)
0196     <span class="keyword">end</span>
0197     
0198     S_marginal=exp(log_S_marginal);
0199     <span class="keyword">if</span> any(any(S_marginal==0))
0200         S_marginal=exp(log_S_marginal+(299-max(max(log_S_marginal))));
0201     <span class="keyword">end</span>
0202     <span class="keyword">if</span> any(any(S_marginal==0))
0203         S_marginal(S_marginal==0)=1E-100;
0204     <span class="keyword">end</span>
0205     S_norm = sum(sum(S_marginal));
0206     
0207     <span class="comment">%% posterior for state j at time t</span>
0208     S_marginal = S_marginal/S_norm;
0209     <span class="keyword">for</span> j=1:M
0210         S(t,j) = sum(S_marginal(:,j));
0211     <span class="keyword">end</span>
0212     S(t,S(t,:)==0)=1E-99;
0213     
0214     <span class="comment">%% weights of state components</span>
0215     <span class="keyword">for</span> j=1:M
0216         <span class="keyword">for</span> i=1:M
0217             W(i,j) = S_marginal(i,j)/S(t,j);
0218         <span class="keyword">end</span>
0219     <span class="keyword">end</span>
0220     W(W==0)=1E-99;
0221     
0222     <span class="keyword">if</span> isnan(W(i,j))
0223         disp([<span class="string">'warning: W(i,j)(t='</span> num2str(t) <span class="string">')=nan | SKF.m'</span>])
0224     <span class="keyword">end</span>
0225     
0226     <span class="comment">%% approximate new continuous state</span>
0227     <span class="keyword">for</span> j=1:M
0228         x{j}(:,t) = x_ij{j}(:,:) * W(:,j);
0229         <span class="keyword">for</span> i=1:M
0230             m = x_ij{j}(:,i) - x{j}(:,t);
0231             V{j}(:,:,t) = V{j}(:,:,t) + W(i,j)*(V_ij{j}(:,:,i) + m*m');
0232             VV{j}(:,:,t) = VV{j}(:,:,t) + W(i,j)*(VV_ij{j}(:,:,i) + m*m');
0233         <span class="keyword">end</span>
0234     <span class="keyword">end</span>
0235 <span class="keyword">end</span>
0236 disp(<span class="string">' '</span>)
0237 pr_model_false_full=mean(pr_model_false(:), <span class="string">'omitnan'</span>);
0238 
0239 <span class="comment">% figure</span>
0240 <span class="comment">% plot(timestamps, squeeze(nis))</span>
0241 <span class="comment">% hold on</span>
0242 <span class="comment">% plot(timestamps, 3.84*ones(1,length(timestamps)), 'r')</span>
0243 <span class="comment">%</span>
0244 <span class="comment">% figure</span>
0245 <span class="comment">% normplot(squeeze(e))</span>
0246 
0247 
0248 
0249</pre></div>
<hr><address>Generated on Mon 18-Jun-2018 12:19:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>