<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mergeTimeStampVectors</title>
  <meta name="keywords" content="mergeTimeStampVectors">
  <meta name="description" content="MERGETIMESTAMPVECTORS Create a single time vector from a set of time series">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">BDLM_DATA_LOADER_9</a> &gt; <a href="#">functions</a> &gt; <a href="index.html">DataLoader</a> &gt; mergeTimeStampVectors.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for BDLM_DATA_LOADER_9/functions/DataLoader&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>mergeTimeStampVectors
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>MERGETIMESTAMPVECTORS Create a single time vector from a set of time series</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [data]=mergeTimeStampVectors(data, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MERGETIMESTAMPVECTORS Create a single time vector from a set of time series

   SYNOPSIS:
     [data]=MERGETIMESTAMPVECTORS(data, varargin)

   INPUT:
       data        - structure (required)
                      data must contain three fields :

                           'timestamps' is a 1×N cell array
                           each cell is a M_ix1 real array

                           'values' is a 1×N cell array
                           each cell is a M_ix1 real array

                           'labels' is a 1×N cell array
                           each cell is a character array

                 N: number of time series
                 M_i: number of samples of time series i

      NanThreshold - real (optional)
                     maximum amount of missing data (NaN) allowed at each
                     timestamp, given in percent 0&lt;= NanThreshold &lt;= 100
                     default: 0 (no missing data is allowed)


      tolerance    - real (optional)
                     value given in number of days
                     timestamps +/- tolerance are considered equal
                     default: 10E-6

      isOutputFile - logical (optional)
                     if true, save the data in a DATA_*.mat Matlab file
                     default: false

      isPlot       - logical (optional)
                     if true, plot data
                     default: false

   OUTPUT:
      data         - structure (required)
                     fields of data are timestamps, values, labels

   DESCRIPTION:
      MERGETIMESTAMPVECTORS process a set of time series, each having
      their own timestamp vector.
      MERGETIMESTAMPVECTORS merge all  timestamps vector in a single one by
      removing samples and/or padding with missing data if required.
      The parameter &quot;NanThreshold&quot; controls the amount of missing data
      allowed at each time step.
      Small &quot;NanThreshold&quot; value may force to remove a lot of data
      samples.
      High &quot;NanThreshold&quot; usually preserve the data, but may lead to a
      strong NaN padding.

      Note that timestamps +/- tolerance are considered equal
      Tolerance variable is a real value given in number of days.

   EXAMPLES:
      [data] = MERGETIMESTAMPVECTORS (data)
      [data] = MERGETIMESTAMPVECTORS (data, 'NanThreshold', 100, ...
               'Tolerance', 0.01)
      [data] = MERGETIMESTAMPVECTORS (data, 'NanThreshold', 100, ...
               'Tolerance', 0.01, 'isPlot', true, 'isOutputFile', true)
      [data] = MERGETIMESTAMPVECTORS (data, 'Tolerance', 0.01 )

   See also <a href="extractSynchronousRecords.html" class="code" title="function [data]=extractSynchronousRecords(data, varargin)">EXTRACTSYNCHRONOUSRECORDS</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="saveDataBinary.html" class="code" title="function [dataFilename] = saveDataBinary(data,varargin)">saveDataBinary</a>	SAVEDATABINARY Save data in a binary Matlab .mat file</li><li><a href="verificationDataStructure.html" class="code" title="function [isValid]=verificationDataStructure(data)">verificationDataStructure</a>	VERIFICATIONDATASTRUCTURE Verify formatting of data structure</li><li><a href="../../../BDLM_DATA_LOADER_9/functions/VisualizationTools/plotData.html" class="code" title="function plotData(data, model, estimation, misc, varargin)">plotData</a>	PLOTDATA Plot amplitude and time step of time series data</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="loadData.html" class="code" title="function [data, dataFilename]=loadData(varargin)">loadData</a>	LOADDATA Load data from csv file</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [data]=mergeTimeStampVectors(data, varargin)</a>
0002 <span class="comment">%MERGETIMESTAMPVECTORS Create a single time vector from a set of time series</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   SYNOPSIS:</span>
0005 <span class="comment">%     [data]=MERGETIMESTAMPVECTORS(data, varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%   INPUT:</span>
0008 <span class="comment">%       data        - structure (required)</span>
0009 <span class="comment">%                      data must contain three fields :</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%                           'timestamps' is a 1×N cell array</span>
0012 <span class="comment">%                           each cell is a M_ix1 real array</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%                           'values' is a 1×N cell array</span>
0015 <span class="comment">%                           each cell is a M_ix1 real array</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%                           'labels' is a 1×N cell array</span>
0018 <span class="comment">%                           each cell is a character array</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%                 N: number of time series</span>
0021 <span class="comment">%                 M_i: number of samples of time series i</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%      NanThreshold - real (optional)</span>
0024 <span class="comment">%                     maximum amount of missing data (NaN) allowed at each</span>
0025 <span class="comment">%                     timestamp, given in percent 0&lt;= NanThreshold &lt;= 100</span>
0026 <span class="comment">%                     default: 0 (no missing data is allowed)</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%      tolerance    - real (optional)</span>
0030 <span class="comment">%                     value given in number of days</span>
0031 <span class="comment">%                     timestamps +/- tolerance are considered equal</span>
0032 <span class="comment">%                     default: 10E-6</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%      isOutputFile - logical (optional)</span>
0035 <span class="comment">%                     if true, save the data in a DATA_*.mat Matlab file</span>
0036 <span class="comment">%                     default: false</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%      isPlot       - logical (optional)</span>
0039 <span class="comment">%                     if true, plot data</span>
0040 <span class="comment">%                     default: false</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%   OUTPUT:</span>
0043 <span class="comment">%      data         - structure (required)</span>
0044 <span class="comment">%                     fields of data are timestamps, values, labels</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%   DESCRIPTION:</span>
0047 <span class="comment">%      MERGETIMESTAMPVECTORS process a set of time series, each having</span>
0048 <span class="comment">%      their own timestamp vector.</span>
0049 <span class="comment">%      MERGETIMESTAMPVECTORS merge all  timestamps vector in a single one by</span>
0050 <span class="comment">%      removing samples and/or padding with missing data if required.</span>
0051 <span class="comment">%      The parameter &quot;NanThreshold&quot; controls the amount of missing data</span>
0052 <span class="comment">%      allowed at each time step.</span>
0053 <span class="comment">%      Small &quot;NanThreshold&quot; value may force to remove a lot of data</span>
0054 <span class="comment">%      samples.</span>
0055 <span class="comment">%      High &quot;NanThreshold&quot; usually preserve the data, but may lead to a</span>
0056 <span class="comment">%      strong NaN padding.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">%      Note that timestamps +/- tolerance are considered equal</span>
0059 <span class="comment">%      Tolerance variable is a real value given in number of days.</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%   EXAMPLES:</span>
0062 <span class="comment">%      [data] = MERGETIMESTAMPVECTORS (data)</span>
0063 <span class="comment">%      [data] = MERGETIMESTAMPVECTORS (data, 'NanThreshold', 100, ...</span>
0064 <span class="comment">%               'Tolerance', 0.01)</span>
0065 <span class="comment">%      [data] = MERGETIMESTAMPVECTORS (data, 'NanThreshold', 100, ...</span>
0066 <span class="comment">%               'Tolerance', 0.01, 'isPlot', true, 'isOutputFile', true)</span>
0067 <span class="comment">%      [data] = MERGETIMESTAMPVECTORS (data, 'Tolerance', 0.01 )</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%   See also EXTRACTSYNCHRONOUSRECORDS</span>
0070 
0071 <span class="comment">%   AUTHORS:</span>
0072 <span class="comment">%      Ianis Gaudot, Luong Ha Nguyen, James-A Goulet</span>
0073 <span class="comment">%</span>
0074 <span class="comment">%      Email: &lt;james.goulet@polymtl.ca&gt;</span>
0075 <span class="comment">%      Website: &lt;http://www.polymtl.ca/expertises/goulet-james-alexandre&gt;</span>
0076 <span class="comment">%</span>
0077 <span class="comment">%   MATLAB VERSION:</span>
0078 <span class="comment">%      Tested on 9.1.0.441655 (R2016b)</span>
0079 <span class="comment">%</span>
0080 <span class="comment">%   DATE CREATED:</span>
0081 <span class="comment">%       April 13, 2018</span>
0082 <span class="comment">%</span>
0083 <span class="comment">%   DATE LAST UPDATE:</span>
0084 <span class="comment">%       April 16, 2018</span>
0085 
0086 <span class="comment">%--------------------BEGIN CODE ----------------------</span>
0087 <span class="comment">%% Get arguments passed to the function and proceed to some verifications</span>
0088 p = inputParser;
0089 defaultNanThreshold = 0;
0090 defaulttolerance = 10^(-6);
0091 defaultisOutputFile =  false;
0092 defaultisPlot = false;
0093 
0094 addRequired(p,<span class="string">'data'</span>, @isstruct );
0095 validationFcn = @(x) isreal(x) &amp; x &gt;= 0 &amp; x &lt;= 100;
0096 addParameter(p,<span class="string">'NanThreshold'</span>,defaultNanThreshold,validationFcn);
0097 addParameter(p,<span class="string">'tolerance'</span>,defaulttolerance,@isreal);
0098 addParameter(p,<span class="string">'isOutputFile'</span>,defaultisOutputFile,@islogical);
0099 addParameter(p,<span class="string">'isPlot'</span>,defaultisPlot,@islogical);
0100 
0101 parse(p,data, varargin{:} );
0102 
0103 data=p.Results.data;
0104 NaNThreshold = p.Results.NanThreshold;
0105 tolerance = p.Results.tolerance;
0106 isOutputFile=p.Results.isOutputFile;
0107 isPlot=p.Results.isPlot;
0108 
0109 <span class="comment">% Validation of structure data</span>
0110 isValid = <a href="verificationDataStructure.html" class="code" title="function [isValid]=verificationDataStructure(data)">verificationDataStructure</a>(data);
0111 <span class="keyword">if</span> ~isValid
0112     disp(<span class="string">' '</span>)
0113     disp(<span class="string">'ERROR: Unable to read the data from the structure.'</span>)
0114     disp(<span class="string">' '</span>)
0115     <span class="keyword">return</span>
0116 <span class="keyword">end</span>
0117 
0118 <span class="comment">%displayData(data)</span>
0119 
0120 <span class="comment">%% Gather all serial date number in a single matrix</span>
0121 
0122 <span class="comment">% Get number of time series</span>
0123 numberOfTimeSeries = length(data.values);
0124 
0125 <span class="comment">% Get lengh of each time series (number of samples)</span>
0126 AllTimeSeriesLength = cellfun(@length, data.values);
0127 
0128 <span class="comment">% Gather serial dates number in same matrix</span>
0129 alldates = [];
0130 <span class="comment">% Load array</span>
0131 <span class="keyword">for</span> i=1:numberOfTimeSeries
0132     alldates = [alldates ; data.timestamps{i}];
0133 <span class="keyword">end</span>
0134 
0135 <span class="comment">%% Full outer join</span>
0136 <span class="comment">% select identical timestamp with tolerance</span>
0137 [keys,~,ind] = uniquetol( alldates, tolerance, <span class="string">'Datascale'</span>, 1 ); 
0138 indice=[];
0139 <span class="keyword">for</span> i=1:numberOfTimeSeries
0140     <span class="keyword">if</span> i==1
0141         beg_idx=1;
0142         end_idx=AllTimeSeriesLength(i);
0143         indice(1:end_idx-beg_idx+1,i)=ind(beg_idx:end_idx,1);
0144     <span class="keyword">else</span>
0145         beg_idx=end_idx+1;
0146         end_idx=beg_idx+AllTimeSeriesLength(i)-1;
0147         indice(1:end_idx-beg_idx+1,i)=ind(beg_idx:end_idx,1);
0148     <span class="keyword">end</span>
0149 <span class="keyword">end</span>
0150 
0151 fullOuterJoin = zeros(length(keys),numberOfTimeSeries+1);
0152 fullOuterJoin(:,:)=NaN; <span class="comment">% fill with NaN (missing data)</span>
0153 fullOuterJoin(:,1) = keys; <span class="comment">% union of dates</span>
0154 
0155 <span class="comment">%% Build full outerjoin</span>
0156 <span class="keyword">for</span> i=1:numberOfTimeSeries    
0157     <span class="comment">% stores values</span>
0158     fullOuterJoin(indice(1:AllTimeSeriesLength(i),i),i+1) = data.values{i};
0159 <span class="keyword">end</span>
0160 
0161 <span class="comment">%% Remove time samples to try to reach NaNThreshold condition</span>
0162 NaNThresholdTested = NaNThreshold;
0163 
0164 isData = false;
0165 <span class="keyword">while</span> isData == false
0166     
0167     tmp = fullOuterJoin;
0168     criteria=(numberOfTimeSeries*NaNThresholdTested)./100;
0169     tmp(sum(isnan(tmp(:,2:end)),2) &gt; criteria,:)=[];
0170     
0171     <span class="keyword">if</span> isempty(tmp)
0172         NaNThresholdTested = NaNThresholdTested + 1;
0173         
0174         <span class="keyword">if</span> NaNThresholdTested &gt;= 100
0175             tmp = fullOuterJoin;
0176             isData = true;
0177         <span class="keyword">end</span>
0178         
0179     <span class="keyword">else</span>
0180         isData = true;
0181     <span class="keyword">end</span>
0182     
0183 <span class="keyword">end</span>
0184 
0185 <span class="keyword">if</span> NaNThresholdTested ~= NaNThreshold
0186     disp(<span class="string">' '</span>)
0187     fprintf([<span class="string">'WARNING: NaNThreshold has been increased from '</span> <span class="keyword">...</span>
0188         <span class="string">'%6.2f %% to %6.2f %% to avoid removing all the data'</span>], <span class="keyword">...</span>
0189         NaNThreshold, NaNThresholdTested )
0190     disp(<span class="string">' '</span>)
0191 <span class="keyword">end</span>
0192 
0193 <span class="comment">%% Overwrite data structure</span>
0194 <span class="keyword">for</span> i=1:numberOfTimeSeries
0195     
0196     <span class="keyword">if</span> ~all(isnan(tmp(:,i+1)))
0197         <span class="comment">% stores timestamps</span>
0198         data.timestamps{i} = tmp(:,1);
0199         <span class="comment">% stores values</span>
0200         data.values{i} = tmp(:,i+1);
0201     <span class="keyword">else</span>
0202         fprintf([<span class="string">'WARNING: %s has been removed because '</span> <span class="keyword">...</span>
0203             <span class="string">'it does not store real valued data anymore'</span>], data.labels{i})
0204         disp(<span class="string">' '</span>)
0205         data.timestamps{i}=[];
0206         data.values{i} = [];  
0207         data.labels{i} = [];
0208         disp(<span class="string">' '</span>)
0209 
0210         <span class="keyword">continue</span>
0211     <span class="keyword">end</span>
0212 <span class="keyword">end</span>
0213 
0214 <span class="comment">% Remove empty fields</span>
0215 data.timestamps(cellfun(@isempty, data.timestamps))=[];
0216 data.values(cellfun(@isempty, data.values))=[];
0217 data.labels(cellfun(@isempty, data.labels))=[];
0218 
0219 <span class="comment">%% Plot</span>
0220 <span class="keyword">if</span> isPlot
0221     <a href="../../../BDLM_DATA_LOADER_9/functions/VisualizationTools/plotData.html" class="code" title="function plotData(data, model, estimation, misc, varargin)">plotData</a>(data, <span class="string">'FigurePath'</span>, <span class="string">'figures'</span>)
0222 <span class="keyword">end</span>
0223 
0224 <span class="comment">%% Save in binary DATA_*.mat file</span>
0225 <span class="keyword">if</span> isOutputFile
0226     <a href="saveDataBinary.html" class="code" title="function [dataFilename] = saveDataBinary(data,varargin)">saveDataBinary</a>(data, <span class="string">'FilePath'</span>,<span class="string">'processed_data'</span>)
0227 <span class="keyword">end</span>
0228 <span class="comment">%--------------------END CODE ------------------------</span>
0229 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 18-Jun-2018 12:19:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>